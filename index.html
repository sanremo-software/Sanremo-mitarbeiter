
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WorkTime ‚Äì Stempel System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }

    /* ====== BANNER FULL-WIDTH COM NOVO LOGO ====== */
    .hero-banner {
      width: 100vw;
      height: 200px;
      position: relative;
      left: 50%;
      transform: translateX(-50%);
      background: #ffffff url('worktime-logo.png') center/contain no-repeat;
      display: flex;
      align-items: flex-end;
      padding: 16px 24px;
      box-sizing: border-box;
      border-bottom: 4px solid #e0e0e0;
    }

    .hero-text {
      background: rgba(255,255,255,0.9);
      padding: 8px 14px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .hero-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      color: #222;
    }

    .hero-subtitle {
      margin: 3px 0 0 0;
      font-size: 13px;
      color: #555;
    }

    @media (min-width: 700px) {
      .hero-banner {
        height: 220px;
      }
      .hero-title {
        font-size: 26px;
      }
      .hero-subtitle {
        font-size: 14px;
      }
    }

    /* ====== LAYOUT GERAL ====== */
    body {
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }

    .section {
      border: 1px solid #ccc;
      padding: 16px;
      margin-top: 16px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    h3 { margin-top: 0; }

    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }

    input, select, button {
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input, select {
      width: 100%;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-danger {
      background: #d32f2f;
      color: #fff;
    }

    .warning {
      color: #d32f2f;
      font-weight: bold;
    }

    small {
      font-size: 12px;
      color: #555;
    }

    .employee-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      gap: 8px;
    }

    .employee-row button {
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .box {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: #fafafa;
      margin-top: 10px;
    }

    #chefLoginStatus {
      font-size: 13px;
      margin-top: 6px;
    }

    #status, #hoursInfo, #planHoursInfo {
      font-size: 14px;
      margin-top: 6px;
    }

    /* GRELHA CHEF-AREA + STEMPEL */
    @media (min-width: 700px) {
      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 16px;
      }
    }

    /* HIST√ìRICO ESCONDIDO */
    #historyBox {
      display: none;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      padding: 8px;
      font-size: 13px;
      max-height: 220px;
      overflow-y: auto;
    }

    #log {
      font-size: 13px;
    }

    /* RODAP√â LEGAL SIMPLES */
    .legal {
      font-size: 12px;
      margin: 24px 0 8px 0;
      color: #555;
    }

    .legal h4 {
      margin: 0 0 6px 0;
      font-size: 14px;
    }

    .legal p {
      margin: 4px 0;
    }
  </style>
</head>
<body>

  <!-- ===== BANNER COM O NOVO LOGO ===== -->
  <header class="hero-banner">
    <div class="hero-text">
      <h1 class="hero-title">Dienstplan</h1>
      <p class="hero-subtitle">WorkTime ‚Äì Stempel System f√ºr Mitarbeiter und kleine Teams.</p>
    </div>
  </header>

  <div class="container">

    <!-- LOGIN DO CHEFE -->
    <div class="section" id="chefLoginCard">
      <h3>Chef Login</h3>
      <label for="chefPinInput">PIN eingeben:</label>
      <input type="password" id="chefPinInput" placeholder="PIN">
      <button id="btnChefLogin" class="btn-primary" style="width:48%; margin-right:4%;">Login</button>
      <button id="btnChefLogout" class="btn-secondary" style="width:48%;">Logout</button>

      <p id="chefLoginStatus"></p>
      <small>
        Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp, Export &amp; Datenschutz) freigeschaltet.
      </small>
    </div>

    <div class="grid">
      <!-- √ÅREA DO CHEFE (escondida at√© login) -->
      <div id="chefArea" style="display:none;">

        <!-- Gest√£o de empregados -->
        <div class="section">
          <h3>Mitarbeiter verwalten</h3>

          <label for="empName">Name des Mitarbeiters:</label>
          <input type="text" id="empName" placeholder="z.B. Jo√£o, Maria, ...">

          <label for="empPhone">WhatsApp / Telefonnummer (optional):</label>
          <input type="password" id="empPhone" placeholder="z.B. 491701234567">

          <button id="btnAddEmp" class="btn-primary" style="width:100%; margin-top:10px;">
            Mitarbeiter hinzuf√ºgen
          </button>

          <div id="employeeList" style="margin-top:12px;">
            <!-- lista de empregados -->
          </div>

          <small>
            Mitarbeiterliste, Stunden und √úberstunden werden nur lokal im Browser/Tablet gespeichert (localStorage). Kein externer Server.
          </small>
        </div>

        <!-- Plano + WhatsApp + Export -->
        <div class="section">
          <h3>Dienstplan &amp; WhatsApp</h3>

          <label for="planEmployeeSelect">Mitarbeiter ausw√§hlen:</label>
          <select id="planEmployeeSelect">
            <option value="">-- Mitarbeiter w√§hlen --</option>
          </select>

          <div id="planHoursInfo">
            Stunden diesen Monat: 0 | √úberstundenkonto: 0
          </div>

          <label for="date">Tag:</label>
          <input type="date" id="date">

          <label for="timeFrom">Von (Uhrzeit):</label>
          <input type="time" id="timeFrom">

          <label for="timeTo">Bis (Uhrzeit):</label>
          <input type="time" id="timeTo">

          <div class="box">
            <button id="btnPreview" class="btn-secondary" style="width:100%; margin-bottom:6px;">
              Nachricht anzeigen
            </button>
            <button id="btnWhatsapp" class="btn-primary" style="width:100%;">
              WhatsApp √∂ffnen
            </button>
            <p style="font-size:12px; margin-top:6px;">
              WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.
            </p>
          </div>

          <div class="box">
            <b>Vorschau Nachricht:</b>
            <p id="previewText" style="white-space: pre-wrap; margin-top: 8px;">
              (Noch keine Nachricht)
            </p>
          </div>

          <div class="section" style="margin-top:16px;">
            <h3>Monats-Export (CSV / Excel)</h3>
            <p style="font-size:13px;">
              Export pro Mitarbeiter und Monat ‚Äì ideal f√ºr den Steuerberater.
              Die Datei kann in Excel, Google Sheets oder LibreOffice ge√∂ffnet werden.
            </p>

            <label for="exportEmployeeSelect">Mitarbeiter ausw√§hlen:</label>
            <select id="exportEmployeeSelect">
              <option value="">-- Mitarbeiter w√§hlen --</option>
            </select>

            <label for="exportMonthSelect">Monat ausw√§hlen:</label>
            <select id="exportMonthSelect"></select>

            <button id="btnExportCsv" class="btn-primary" style="width:100%; margin-top:10px;">
              CSV / Excel exportieren
            </button>

            <p id="exportInfo" style="font-size:12px; margin-top:6px; color:#555;"></p>
          </div>

        </div>

        <!-- MONATSBERICHT (CHEF) -->
        <div class="section">
          <h3>Monatsbericht (Chef)</h3>
          <p style="font-size:13px; margin-bottom:8px;">
            √úbersicht aller Mitarbeiter f√ºr den aktuellen Monat (Summen).
          </p>

          <div id="monthlyReportContainer">
            <!-- tabela gerada por JavaScript -->
          </div>

          <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="printMonthlyReport()">
            Drucken / als PDF speichern
          </button>
        </div>

        <!-- TEXTO LEGAL SIMPLES -->
        <div class="section legal">
          <h4>Datenschutz &amp; Nutzungshinweise</h4>
          <p>Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs. Es werden keine Daten auf externen Servern gespeichert.</p>
          <p>Der Zugriff auf die Daten haben nur der Betrieb/Chef und autorisierte Personen. Der Arbeitgeber ist verantwortlich f√ºr die Information seiner Mitarbeiter.</p>
          <p>Die Weitergabe oder der Verkauf des Quellcodes ohne schriftliche Zustimmung des Entwicklers ist untersagt.</p>
        </div>

      </div> <!-- fim chefArea -->

      <!-- SEC√á√ÉO: Stempeluhr ‚Äì para os empregados (sempre vis√≠vel) -->
      <div>
        <div class="section">
          <h3>Stempeluhr (f√ºr Mitarbeiter)</h3>

          <label for="employeeSelect">Mitarbeiter ausw√§hlen:</label>
          <select id="employeeSelect">
            <option value="">-- Mitarbeiter w√§hlen --</option>
          </select>

          <div id="hoursInfo">
            Stunden diesen Monat: 0 | √úberstundenkonto: 0
          </div>

          <div id="status">Bereit zum Stempeln.</div>

          <button id="btnIn" class="btn-primary" style="width:100%; margin-top:10px;">
            Einstempeln
          </button>
          <button id="btnOut" class="btn-secondary" style="width:100%; margin-top:8px;">
            Ausstempeln
          </button>

          <button id="btnDeleteLast" class="btn-danger" style="width:100%; margin-top:10px;">
            Letzten Eintrag l√∂schen
          </button>

          <button id="btnToggleHistory" class="btn-secondary" style="width:100%; margin-top:8px;">
            Heutige Eintr√§ge anzeigen / verbergen
          </button>

          <!-- HIST√ìRICO ESCONDIDO -->
          <div id="historyBox">
            <div id="log"><b>Heutige Eintr√§ge:</b><br></div>
          </div>

          <small>
            Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).
          </small>
        </div>
      </div>
    </div> <!-- fim .grid -->

  </div> <!-- fim .container -->

  <script>
    // ============ CONFIG LOGIN DO CHEFE ============
    const CHEF_PIN = "1234"; // MUDA ESTE PIN

    const chefPinInput = document.getElementById('chefPinInput');
    const btnChefLogin = document.getElementById('btnChefLogin');
    const btnChefLogout = document.getElementById('btnChefLogout');
    const chefLoginStatus = document.getElementById('chefLoginStatus');
    const chefArea = document.getElementById('chefArea');

    btnChefLogin.addEventListener('click', () => {
      const pin = chefPinInput.value.trim();
      if (pin === CHEF_PIN) {
        chefArea.style.display = 'block';
        chefLoginStatus.style.color = 'green';
        chefLoginStatus.textContent = 'Login erfolgreich. Chef-Bereiche sind freigeschaltet.';
        chefPinInput.value = '';
      } else {
        chefLoginStatus.style.color = 'red';
        chefLoginStatus.textContent = 'Falscher PIN.';
      }
    });

    btnChefLogout.addEventListener('click', () => {
      chefArea.style.display = 'none';
      chefLoginStatus.style.color = '#333';
      chefLoginStatus.textContent = 'Logout erfolgreich.';
    });

    // ============ DADOS & ARMAZENAMENTO ============
    let employees = [];

    function loadEmployees() {
      const data = localStorage.getItem('sanremoEmployees');
      if (data) {
        employees = JSON.parse(data);
      } else {
        employees = [];
      }
    }

    function saveEmployees() {
      localStorage.setItem('sanremoEmployees', JSON.stringify(employees));
    }

    function generateId() {
      return 'emp_' + Math.random().toString(36).substring(2, 9);
    }

    // ============ ELEMENTOS DO DOM ============
    const empNameInput = document.getElementById('empName');
    const empPhoneInput = document.getElementById('empPhone');
    const btnAddEmp = document.getElementById('btnAddEmp');
    const employeeListDiv = document.getElementById('employeeList');

    const employeeSelect = document.getElementById('employeeSelect');
    const statusEl = document.getElementById('status');
    const hoursInfoEl = document.getElementById('hoursInfo');
    const logEl = document.getElementById('log');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');
    const btnDeleteLast = document.getElementById('btnDeleteLast');
    const btnToggleHistory = document.getElementById('btnToggleHistory');
    const historyBox = document.getElementById('historyBox');

    const planEmployeeSelect = document.getElementById('planEmployeeSelect');
    const planHoursInfoEl = document.getElementById('planHoursInfo');
    const dateInput = document.getElementById('date');
    const timeFromInput = document.getElementById('timeFrom');
    const timeToInput = document.getElementById('timeTo');
    const btnPreview = document.getElementById('btnPreview');
    const btnWhatsapp = document.getElementById('btnWhatsapp');
    const previewText = document.getElementById('previewText');

    const exportEmployeeSelect = document.getElementById('exportEmployeeSelect');
    const exportMonthSelect = document.getElementById('exportMonthSelect');
    const btnExportCsv = document.getElementById('btnExportCsv');
    const exportInfo = document.getElementById('exportInfo');

    const MAX_HOURS_PER_MONTH = 40;

    // ============ HELPERS DE DATA/HORA ============
    function getCurrentMonthKey(dateObj) {
      const d = dateObj || new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function formatGermanDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("de-DE", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }

    // ============ HORAS & BANCO ============
    function getHoursAndBank(emp, monthKey) {
      const key = monthKey || getCurrentMonthKey();
      const total = (emp.monthlyHours && emp.monthlyHours[key]) || 0;
      const bank = (emp.timeBank && emp.timeBank[key]) || 0;
      return { total, bank };
    }

    function updateHoursInfo() {
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        hoursInfoEl.innerHTML = 'Stunden diesen Monat: 0 | √úberstundenkonto: 0';
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = `Stunden diesen Monat: ${total.toFixed(2)} | √úberstundenkonto: ${bank.toFixed(2)}`;
      if (total > MAX_HOURS_PER_MONTH) {
        text += ' ‚Äì <span class="warning">Limit 40h √ºberschritten!</span>';
      }
      hoursInfoEl.innerHTML = text;
    }

    function updatePlanHoursInfo() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        planHoursInfoEl.innerHTML = 'Stunden diesen Monat: 0 | √úberstundenkonto: 0';
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = `Stunden diesen Monat: ${total.toFixed(2)} | √úberstundenkonto: ${bank.toFixed(2)}`;
      if (total > MAX_HOURS_PER_MONTH) {
        text += ' ‚Äì <span class="warning">Limit 40h √ºberschritten!</span>';
      }
      planHoursInfoEl.innerHTML = text;
    }

    function addLog(text) {
      const now = new Date().toLocaleString();
      logEl.innerHTML += `${text} ‚Äì <i>${now}</i><br>`;
      historyBox.scrollTop = historyBox.scrollHeight;
    }

    // ============ UI DE EMPREGADOS ============
    function refreshEmployeeUI() {
      employeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
      planEmployeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
      exportEmployeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';

      employees.forEach(emp => {
        ['employeeSelect','planEmployeeSelect','exportEmployeeSelect'].forEach(selId => {
          const sel = document.getElementById(selId);
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          sel.appendChild(opt);
        });
      });

      // Lista de chef
      employeeListDiv.innerHTML = '';
      employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        row.innerHTML = `<span>${emp.name} ${emp.phone ? '(Nummer gespeichert)' : ''}</span>`;
        const btnDel = document.createElement('button');
        btnDel.textContent = 'L√∂schen';
        btnDel.className = 'btn-danger';
        btnDel.onclick = () => {
          if (confirm('Mitarbeiter "' + emp.name + '" wirklich l√∂schen?')) {
            employees = employees.filter(e => e.id !== emp.id);
            saveEmployees();
            refreshEmployeeUI();
            updateHoursInfo();
            updatePlanHoursInfo();
            renderMonthlyReport();
          }
        };
        row.appendChild(btnDel);
        employeeListDiv.appendChild(row);
      });

      const disabled = employees.length === 0;
      btnIn.disabled = disabled;
      btnOut.disabled = disabled;
      btnDeleteLast.disabled = disabled;
      if (disabled) {
        statusEl.textContent = 'Keine Mitarbeiter angelegt. Chef muss zuerst Mitarbeiter hinzuf√ºgen.';
      } else {
        statusEl.textContent = 'Bereit zum Stempeln.';
      }
    }

    employeeSelect.addEventListener('change', () => {
      updateHoursInfo();
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (emp && emp.activeSessionStart) {
        statusEl.textContent = 'Mitarbeiter ist aktuell eingestempelt (seit ' +
          new Date(emp.activeSessionStart).toLocaleString() + ').';
      } else {
        statusEl.textContent = 'Bereit zum Stempeln.';
      }
    });

    planEmployeeSelect.addEventListener('change', () => {
      updatePlanHoursInfo();
    });

    // ============ ADICIONAR EMPREGADOS ============
    btnAddEmp.addEventListener('click', () => {
      const name = empNameInput.value.trim();
      const phone = empPhoneInput.value.trim();
      if (!name) {
        alert('Bitte einen Namen eingeben.');
        return;
      }
      const emp = {
        id: generateId(),
        name,
        phone: phone || '',
        monthlyHours: {},
        timeBank: {},
        activeSessionStart: null,
        history: [] // para armazenar entradas do dia (para export)
      };
      employees.push(emp);
      saveEmployees();
      empNameInput.value = '';
      empPhoneInput.value = '';
      refreshEmployeeUI();
      renderMonthlyReport();
    });

    // ============ STEMPENUHR ============
    btnIn.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (emp.activeSessionStart) {
        alert('Dieser Mitarbeiter ist bereits eingestempelt.');
        return;
      }

      emp.activeSessionStart = new Date().toISOString();
      saveEmployees();
      statusEl.textContent = 'Eingestempelt um ' +
        new Date(emp.activeSessionStart).toLocaleString() + '.';
      addLog(emp.name + ' eingestempelt');
    });

    btnOut.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (!emp.activeSessionStart) {
        alert('Dieser Mitarbeiter ist noch nicht eingestempelt.');
        return;
      }

      const start = new Date(emp.activeSessionStart);
      const end = new Date();
      const diffMs = end - start;
      const hours = diffMs / 1000 / 60 / 60;
      const monthKey = getCurrentMonthKey(start);

      if (!emp.monthlyHours) emp.monthlyHours = {};
      if (!emp.timeBank) emp.timeBank = {};
      if (!emp.history) emp.history = [];

      const prevTotal = emp.monthlyHours[monthKey] || 0;
      const newTotal = prevTotal + hours;
      emp.monthlyHours[monthKey] = newTotal;

      let bank = 0;
      if (newTotal > MAX_HOURS_PER_MONTH) {
        bank = newTotal - MAX_HOURS_PER_MONTH;
      }
      emp.timeBank[monthKey] = bank;

      // guardar no hist√≥rico simples (para CSV e ‚Äúletzter Eintrag l√∂schen‚Äù)
      emp.history.push({
        start: emp.activeSessionStart,
        end: end.toISOString()
      });

      emp.activeSessionStart = null;
      saveEmployees();

      statusEl.textContent = 'Ausgestempelt. Gearbeitete Zeit: ' +
        hours.toFixed(2) + ' Std. Gesamt in diesem Monat: ' +
        newTotal.toFixed(2) + ' Std.';
      addLog(emp.name + ' ausgestempelt (' + hours.toFixed(2) + ' Std.)');

      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    });

    // apagar √∫ltimo registo (tanto hist√≥rico como horas)
    btnDeleteLast.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp || !emp.history || emp.history.length === 0) {
        alert('Keine Eintr√§ge zum L√∂schen.');
        return;
      }
      if (!confirm('Letzten Eintrag dieses Mitarbeiters wirklich l√∂schen?')) return;

      const last = emp.history.pop();
      const start = new Date(last.start);
      const end = new Date(last.end);
      const hours = (end - start) / 1000 / 60 / 60;
      const monthKey = getCurrentMonthKey(start);

      if (!emp.monthlyHours) emp.monthlyHours = {};
      const prevTotal = emp.monthlyHours[monthKey] || 0;
      let newTotal = prevTotal - hours;
      if (newTotal < 0) newTotal = 0;
      emp.monthlyHours[monthKey] = newTotal;

      let bank = 0;
      if (newTotal > MAX_HOURS_PER_MONTH) {
        bank = newTotal - MAX_HOURS_PER_MONTH;
      }
      emp.timeBank[monthKey] = bank;

      saveEmployees();
      addLog('Letzter Eintrag von ' + emp.name + ' gel√∂scht (' + hours.toFixed(2) + ' Std.).');
      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    });

    // mostrar / esconder hist√≥rico de hoje
    btnToggleHistory.addEventListener('click', () => {
      historyBox.style.display = (historyBox.style.display === 'none' || historyBox.style.display === '') 
        ? 'block' : 'none';
    });

    // ============ WHATSAPP ‚Äì CHEF ============
    function buildMessage() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const date = dateInput.value;
      const tFrom = timeFromInput.value;
      const tTo = timeToInput.value;

      if (!emp || !date || !tFrom || !tTo) {
        return "";
      }

      const dateDE = formatGermanDate(date);
      const { total, bank } = getHoursAndBank(emp);

      let hoursLine =
        `Aktueller Monat: ${total.toFixed(2)} Std. (√úberstundenkonto: ${bank.toFixed(2)} Std.)`;
      if (total > MAX_HOURS_PER_MONTH) {
        hoursLine += " ‚Äì LIMIT 40h √ºberschritten!";
      }

      const msg =
        "WorkTime ‚Äì Dienstplan\n\n" +
        "Hallo " + emp.name + ",\n\n" +
        "dein Dienst:\n" +
        "üìÖ Datum: " + dateDE + "\n" +
        "‚è∞ Zeit: " + tFrom + " ‚Äì " + tTo + " Uhr\n" +
        "üìç Ort: Eiscaf√© / Betrieb\n\n" +
        hoursLine + "\n\n" +
        "Bitte best√§tige mit OK.";
      return msg;
    }

    btnPreview.addEventListener('click', () => {
      const msg = buildMessage();
      if (!msg) {
        alert("Bitte Mitarbeiter, Tag und Zeiten ausf√ºllen.");
        return;
      }
      previewText.textContent = msg;
    });

    btnWhatsapp.addEventListener('click', () => {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const msg = buildMessage();

      if (!emp) {
        alert("Bitte Mitarbeiter w√§hlen.");
        return;
      }
      if (!msg) {
        alert("Bitte Tag und Zeiten eintragen.");
        return;
      }

      if (!emp.phone) {
        alert("F√ºr diesen Mitarbeiter ist keine Telefonnummer hinterlegt.");
        return;
      }

      const phone = emp.phone;
      const encodedMsg = encodeURIComponent(msg);
      const url = "https://wa.me/" + phone + "?text=" + encodedMsg;

      window.open(url, "_blank");
    });

    // ============ MONATSBERICHT (CHEF) ============
    function renderMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      if (!employees || employees.length === 0) {
        container.innerHTML = '<em>Keine Mitarbeiter angelegt.</em>';
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse; font-size:14px;">';
      html += '<thead><tr>' +
              '<th style="border-bottom:1px solid #ccc; text-align:left; padding:4px;">Mitarbeiter</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">Stunden im Monat</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">√úberstundenkonto</th>' +
              '</tr></thead><tbody>';

      let totalHoursAll = 0;
      let totalBankAll = 0;
      const monthKey = getCurrentMonthKey();

      employees.forEach(emp => {
        const { total, bank } = getHoursAndBank(emp, monthKey);
        totalHoursAll += total;
        totalBankAll += bank;

        html += '<tr>' +
          '<td style="border-bottom:1px solid #eee; padding:4px;">' + emp.name + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + total.toFixed(2) + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + bank.toFixed(2) + '</td>' +
          '</tr>';
      });

      html += '<tr>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">Summe:</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalHoursAll.toFixed(2) + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalBankAll.toFixed(2) + '</td>' +
        '</tr>';

      html += '</tbody></table>';

      container.innerHTML = html;
    }

    function printMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      const win = window.open('', '_blank');
      win.document.write('<html><head><title>Monatsbericht ‚Äì WorkTime</title>');
      win.document.write('<meta charset="UTF-8">');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse;font-size:14px;} th,td{border:1px solid #ccc;padding:4px;} th{text-align:left;background:#f0f0f0;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h2>Monatsbericht ‚Äì WorkTime</h2>');
      win.document.write('<p>Monat: ' + getCurrentMonthKey() + '</p>');
      win.document.write(container.innerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }

    // ============ EXPORT CSV POR M√äS ============

    function fillExportMonthSelect() {
      // 12 meses √† volta: actual -5 at√© +6
      exportMonthSelect.innerHTML = '';
      const now = new Date();
      for (let i = -5; i <= 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const key = getCurrentMonthKey(d);
        const label = d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = label;
        if (i === 0) opt.selected = true;
        exportMonthSelect.appendChild(opt);
      }
    }

    btnExportCsv.addEventListener('click', () => {
      const empId = exportEmployeeSelect.value;
      const monthKey = exportMonthSelect.value;
      if (!empId || !monthKey) {
        alert('Bitte Mitarbeiter und Monat ausw√§hlen.');
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      const dParts = monthKey.split('-');
      const year = parseInt(dParts[0], 10);
      const month = parseInt(dParts[1], 10) - 1;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      let csv = '';
      csv += `Name;${emp.name};Monat;${monthKey}\n`;
      csv += 'Tag;Arbeitsbeginn;Arbeitsende;Pausenbeginn;Pausenende;Arbeitszeit;Entlohnungsart\n';

      for (let day = 1; day <= daysInMonth; day++) {
        const d = new Date(year, month, day);
        const dateStr = d.toLocaleDateString('de-DE');
        csv += `${dateStr};;;;;;\n`;
      }

      const { total, bank } = getHoursAndBank(emp, monthKey);
      csv += `;;;Gesamtstunden;${total.toFixed(2)};;√úberstundenkonto (Monat);${bank.toFixed(2)}\n`;

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeName = emp.name.replace(/[^a-z0-9]+/gi, '_');
      a.href = url;
      a.download = `stunden_${safeName}_${monthKey}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      exportInfo.textContent = 'Export erstellt: ' + a.download;
    });

    // ============ INICIALIZA√á√ÉO ============
    loadEmployees();
    refreshEmployeeUI();
    updateHoursInfo();
    updatePlanHoursInfo();
    renderMonthlyReport();
    fillExportMonthSelect();
  </script>

</body>
</html>
