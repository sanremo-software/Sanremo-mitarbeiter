
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Mitarbeiterportal â€“ Arbeitszeiterfassung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="theme-color" content="#f0f2f5">

  <style>
    html, body {
      height: 100%;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 900px;
      margin: 0 auto;
      background: #f0f2f5;
      min-height: 100vh;
    }

    h3 { margin-top: 20px; }

    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }

    input, select, button {
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    select, input {
      width: 100%;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-danger {
      background: #d32f2f;
      color: #fff;
    }

    .section {
      border: 1px solid #ccc;
      padding: 14px;
      margin-top: 15px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    #status, #hoursInfo, #planHoursInfo {
      font-size: 14px;
      margin-top: 6px;
    }

    #log {
      margin-top: 10px;
      max-height: 220px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
    }

    .employee-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      gap: 8px;
    }
    .employee-row button {
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .warning {
      color: #d32f2f;
      font-weight: bold;
    }
    .box {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: #fafafa;
      margin-top: 10px;
    }
    #chefLoginStatus {
      font-size: 13px;
      margin-top: 6px;
    }
    small {
      font-size: 12px;
      color: #555;
    }

    @media (min-width: 700px) {
      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 16px;
      }
    }

    /* HERO BANNER */
    .hero-banner {
      position: relative;
      margin-bottom: 16px;
      border-radius: 16px;
      overflow: hidden;
      height: 180px;
      background-image:
        linear-gradient(135deg, rgba(0,0,0,0.45), rgba(0,0,0,0.15)),
        url('IMG-20251125-WA0004.jpg');
      background-size: cover;
      background-position: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 12px 16px;
      color: #fff;
    }

    .hero-info {
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }
    .hero-title {
      font-size: 22px;
      font-weight: 700;
    }
    .hero-subtitle {
      font-size: 14px;
      opacity: 0.95;
    }
    .hero-badge {
      margin-top: 6px;
      display: inline-block;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.20);
      backdrop-filter: blur(3px);
    }

    /* LANGUAGE SWITCHER */
    .lang-switcher {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .lang-btn {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
      color: #333;
    }
    .lang-btn.active {
      background: #1976d2;
      color: #fff;
    }

    @media (min-width: 700px) {
      .hero-banner {
        height: 200px;
      }
      .hero-title {
        font-size: 26px;
      }
      .hero-subtitle {
        font-size: 15px;
      }
    }

    /* CHEF LOGIN â€“ Bandeira italiana */
    .chef-section {
      padding: 3px;
      background: linear-gradient(90deg, #008C45 0%, #F4F5F0 50%, #CD212A 100%);
    }
    .chef-inner {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px;
    }

    /* Bloco legal em 3 caixas */
    .legal-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    .legal-box {
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.4;
    }
    .legal-box b {
      display: block;
      margin-bottom: 4px;
    }

    @media (min-width: 700px) {
      .legal-grid {
        flex-direction: row;
      }
      .legal-box {
        flex: 1;
      }
    }

    /* RodapÃ© simples */
    .footer-links {
      margin-top: 20px;
      text-align: center;
      font-size: 13px;
    }
    .footer-links a {
      color: #1976d2;
      text-decoration: none;
      margin: 0 4px;
    }
  </style>
</head>
<body>

  <!-- BANNER COM FOTO + IDIOMAS -->
  <header class="hero-banner">
    <div class="hero-info">
      <div class="hero-title" data-i18n="heroTitle">Mitarbeiterportal</div>
      <div class="hero-subtitle" data-i18n="heroSubtitle">
        Arbeitszeiterfassung &amp; Dienstplanung
      </div>
      <div class="hero-badge" data-i18n="heroBadge">
        Stempeluhr â€¢ Dienstplan â€¢ WhatsApp
      </div>
    </div>
    <div class="lang-switcher">
      <button class="lang-btn active" data-lang="de">ðŸ‡©ðŸ‡ª DE</button>
      <button class="lang-btn" data-lang="pt">ðŸ‡µðŸ‡¹ PT</button>
      <button class="lang-btn" data-lang="it">ðŸ‡®ðŸ‡¹ IT</button>
    </div>
  </header>

  <!-- LOGIN DO CHEFE (com fundo bandeira italiana) -->
  <div class="section chef-section">
    <div class="chef-inner">
      <h3 data-i18n="chefLoginTitle">Chef Login</h3>
      <label for="chefPinInput" data-i18n="chefPinLabel">PIN eingeben:</label>
      <input type="password" id="chefPinInput" placeholder="PIN">

      <button id="btnChefLogin" class="btn-primary" style="width:100%; margin-top:8px;" data-i18n="btnLogin">
        Login
      </button>

      <p id="chefLoginStatus"></p>
      <small data-i18n="chefLoginInfo">
        Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten,
        Dienstplan / WhatsApp &amp; Monatsbericht) freigeschaltet.
      </small>
    </div>
  </div>

  <div class="grid">
    <!-- ÃREA DO CHEFE (escondida atÃ© login) -->
    <div id="chefArea" style="display:none;">

      <!-- GestÃ£o de empregados -->
      <div class="section">
        <h3 data-i18n="manageEmployeesTitle">Mitarbeiter verwalten</h3>

        <label for="empName" data-i18n="empNameLabel">Name des Mitarbeiters:</label>
        <input type="text" id="empName" placeholder="z.B. JoÃ£o, Maria, ...">

        <label for="empPhone" data-i18n="empPhoneLabel">WhatsApp / Telefonnummer (optional):</label>
        <input type="text" id="empPhone" placeholder="z.B. 491701234567">

        <button id="btnAddEmp" class="btn-primary" style="width:100%; margin-top:10px;" data-i18n="btnAddEmp">
          Mitarbeiter hinzufÃ¼gen
        </button>

        <div id="employeeList" style="margin-top:12px;">
          <!-- lista de empregados -->
        </div>

        <small data-i18n="empStorageInfo">
          Mitarbeiterliste, Stunden und Ãœberstunden werden im Browser (localStorage) gespeichert.
        </small>
      </div>

      <!-- Plano + WhatsApp -->
      <div class="section">
        <h3 data-i18n="planTitle">Dienstplan &amp; WhatsApp</h3>

        <label for="planEmployeeSelect" data-i18n="planEmpLabel">Mitarbeiter auswÃ¤hlen:</label>
        <select id="planEmployeeSelect">
          <option value="" data-i18n="optChooseEmployee">-- Mitarbeiter wÃ¤hlen --</option>
        </select>

        <div id="planHoursInfo">
          Stunden diesen Monat: 0 | Ãœberstundenkonto: 0
        </div>

        <label for="date" data-i18n="planDayLabel">Tag:</label>
        <input type="date" id="date">

        <label for="timeFrom" data-i18n="planFromLabel">Von (Uhrzeit):</label>
        <input type="time" id="timeFrom">

        <label for="timeTo" data-i18n="planToLabel">Bis (Uhrzeit):</label>
        <input type="time" id="timeTo">

        <div class="box">
          <button id="btnPreview" class="btn-secondary" style="width:100%; margin-bottom:6px;" data-i18n="btnPreview">
            Nachricht anzeigen
          </button>
          <button id="btnWhatsapp" class="btn-primary" style="width:100%;" data-i18n="btnWhatsapp">
            WhatsApp Ã¶ffnen
          </button>
          <p style="font-size:12px; margin-top:6px;" data-i18n="whatsInfo">
            WhatsApp wird mit vorbereiteter Nachricht geÃ¶ffnet. Du entscheidest, ob du sendest.
          </p>
        </div>

        <div class="box">
          <b data-i18n="previewTitle">Vorschau Nachricht:</b>
          <p id="previewText" style="white-space: pre-wrap; margin-top: 8px;">
            (Noch keine Nachricht)
          </p>
        </div>
      </div>

      <!-- MONATSBERICHT (CHEF) -->
      <div class="section">
        <h3 data-i18n="monthlyReportTitle">Monatsbericht (Chef)</h3>
        <p style="font-size: 13px; margin-bottom:8px;" data-i18n="monthlyReportInfo">
          Ãœbersicht aller Mitarbeiter fÃ¼r den aktuellen Monat.
        </p>

        <div id="monthlyReportContainer">
          <!-- tabela gerada por JavaScript -->
        </div>

        <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="printMonthlyReport()" data-i18n="btnPrintPdf">
          Drucken / als PDF speichern
        </button>
      </div>

      <!-- DATENSCHUTZ & NUTZUNGSHINWEISE â€“ sÃ³ apÃ³s Chef-Login -->
      <div class="section">
        <h3 data-i18n="legalTitle">Datenschutz &amp; Nutzungshinweise</h3>

        <p style="font-size: 13px;" data-i18n="legalIntro">
          Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs.
          Es werden keine Daten auf externen Servern gespeichert.
        </p>

        <div class="legal-grid">
          <div class="legal-box">
            <b data-i18n="legalBox1Title">1. Datenschutz</b>
            <span data-i18n="legalBox1Text">
              Zugriff auf die gespeicherten Daten haben nur der Betrieb/Chef
              und die von ihm autorisierten Personen. Der Arbeitgeber ist
              dafÃ¼r verantwortlich, seine Mitarbeiter Ã¼ber die Datenerfassung
              zu informieren.
            </span>
          </div>

          <div class="legal-box">
            <b data-i18n="legalBox2Title">2. Nutzung &amp; Urheberrecht</b>
            <span data-i18n="legalBox2Text">
              Diese Anwendung ist nur fÃ¼r den lizenzierten Betrieb bestimmt.
              Eine Weitergabe, VervielfÃ¤ltigung, der Verkauf oder das Kopieren
              des Quellcodes und Designs an Dritte ohne ausdrÃ¼ckliche
              schriftliche Zustimmung des Entwicklers ist untersagt.
            </span>
          </div>

          <div class="legal-box">
            <b data-i18n="legalBox3Title">3. Haftungsausschluss</b>
            <span data-i18n="legalBox3Text">
              Die Anwendung unterstÃ¼tzt bei der Erfassung von Arbeitszeiten.
              Die rechtlich korrekte Lohnabrechnung und Einhaltung
              arbeitsrechtlicher Vorschriften bleiben in der Verantwortung
              des Arbeitgebers.
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- SECÃ‡ÃƒO: Stempeluhr â€“ para os empregados (sempre visÃ­vel) -->
    <div>
      <div class="section">
        <h3 data-i18n="clockTitle">Stempeluhr (fÃ¼r Mitarbeiter)</h3>

        <label for="employeeSelect" data-i18n="clockEmpLabel">Mitarbeiter auswÃ¤hlen:</label>
        <select id="employeeSelect">
          <option value="" data-i18n="optChooseEmployee">-- Mitarbeiter wÃ¤hlen --</option>
        </select>

        <div id="hoursInfo">
          Stunden diesen Monat: 0 | Ãœberstundenkonto: 0
        </div>

        <div id="status" data-i18n="clockReady">Bereit zum Stempeln.</div>

        <button id="btnIn" class="btn-primary" style="width:100%; margin-top:10px;" data-i18n="btnClockIn">
          Einstempeln
        </button>
        <button id="btnOut" class="btn-secondary" style="width:100%; margin-top:8px;" data-i18n="btnClockOut">
          Ausstempeln
        </button>

        <div id="log"><b data-i18n="todayEntriesTitle">Heutige EintrÃ¤ge:</b><br></div>

        <small data-i18n="clockRule">
          Regel: Maximal 40 Stunden im Monat. Alles darÃ¼ber geht ins Ãœberstundenkonto (Bank von Stunden).
        </small>
      </div>
    </div>
  </div>

  <div class="footer-links">
    <a href="#" onclick="alert('Impressum-Seite kann hier verlinkt werden.'); return false;" data-i18n="linkImpressum">Impressum</a> |
    <a href="#" onclick="alert('DatenschutzerklÃ¤rung kann hier verlinkt werden.'); return false;" data-i18n="linkDatenschutz">Datenschutz</a>
  </div>

  <script>
    // ============ CONFIG LOGIN DO CHEFE ============
    const CHEF_PIN = "1234";

    const chefPinInput = document.getElementById('chefPinInput');
    const btnChefLogin = document.getElementById('btnChefLogin');
    const chefLoginStatus = document.getElementById('chefLoginStatus');
    const chefArea = document.getElementById('chefArea');

    btnChefLogin.addEventListener('click', () => {
      const pin = chefPinInput.value.trim();
      if (pin === CHEF_PIN) {
        chefArea.style.display = 'block';
        chefLoginStatus.style.color = 'green';
        chefLoginStatus.textContent = currentTexts.chefLoginSuccess || 'Login erfolgreich. Chef-Bereiche sind freigeschaltet.';
        chefPinInput.value = '';
      } else {
        chefLoginStatus.style.color = 'red';
        chefLoginStatus.textContent = currentTexts.chefLoginFail || 'Falscher PIN.';
      }
    });

    // ============ DADOS & ARMAZENAMENTO ============
    let employees = [];

    function loadEmployees() {
      const data = localStorage.getItem('sanremoEmployees');
      if (data) {
        employees = JSON.parse(data);
      } else {
        employees = [];
      }
    }

    function saveEmployees() {
      localStorage.setItem('sanremoEmployees', JSON.stringify(employees));
    }

    function generateId() {
      return 'emp_' + Math.random().toString(36).substring(2, 9);
    }

    // ============ ELEMENTOS DO DOM ============
    const empNameInput = document.getElementById('empName');
    const empPhoneInput = document.getElementById('empPhone');
    const btnAddEmp = document.getElementById('btnAddEmp');
    const employeeListDiv = document.getElementById('employeeList');

    const employeeSelect = document.getElementById('employeeSelect');
    const statusEl = document.getElementById('status');
    const hoursInfoEl = document.getElementById('hoursInfo');
    const logEl = document.getElementById('log');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');

    const planEmployeeSelect = document.getElementById('planEmployeeSelect');
    const planHoursInfoEl = document.getElementById('planHoursInfo');
    const dateInput = document.getElementById('date');
    const timeFromInput = document.getElementById('timeFrom');
    const timeToInput = document.getElementById('timeTo');
    const btnPreview = document.getElementById('btnPreview');
    const btnWhatsapp = document.getElementById('btnWhatsapp');
    const previewText = document.getElementById('previewText');

    const MAX_HOURS_PER_MONTH = 40;

    // ============ HELPERS DE DATA/HORA ============
    function getCurrentMonthKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function formatGermanDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("de-DE", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }

    // ============ HORAS & BANCO ============
    function getHoursAndBank(emp) {
      const monthKey = getCurrentMonthKey();
      const total = (emp.monthlyHours && emp.monthlyHours[monthKey]) || 0;
      const bank = (emp.timeBank && emp.timeBank[monthKey]) || 0;
      return { total, bank };
    }

    function updateHoursInfo() {
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        hoursInfoEl.innerHTML = currentTexts.hoursInfoEmpty;
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = currentTexts.hoursInfo
        .replace('{total}', total.toFixed(2))
        .replace('{bank}', bank.toFixed(2));
      if (total > MAX_HOURS_PER_MONTH) {
        text += ' â€“ <span class="warning">' + currentTexts.limitWarning + '</span>';
      }
      hoursInfoEl.innerHTML = text;
    }

    function updatePlanHoursInfo() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        planHoursInfoEl.innerHTML = currentTexts.hoursInfoEmpty;
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = currentTexts.hoursInfo
        .replace('{total}', total.toFixed(2))
        .replace('{bank}', bank.toFixed(2));
      if (total > MAX_HOURS_PER_MONTH) {
        text += ' â€“ <span class="warning">' + currentTexts.limitWarning + '</span>';
      }
      planHoursInfoEl.innerHTML = text;
    }

    function addLog(text) {
      const now = new Date().toLocaleString();
      logEl.innerHTML += `${text} â€“ <i>${now}</i><br>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ============ UI DE EMPREGADOS ============
    function refreshEmployeeUI() {
      employeeSelect.innerHTML = '<option value="">' + currentTexts.optChooseEmployee + '</option>';
      planEmployeeSelect.innerHTML = '<option value="">' + currentTexts.optChooseEmployee + '</option>';

      employees.forEach(emp => {
        const opt1 = document.createElement('option');
        opt1.value = emp.id;
        opt1.textContent = emp.name;
        employeeSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = emp.id;
        opt2.textContent = emp.name;
        planEmployeeSelect.appendChild(opt2);
      });

      employeeListDiv.innerHTML = '';
      employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        row.innerHTML = `
          <span>${emp.name} ${emp.phone ? '(' + emp.phone + ')' : ''}</span>
        `;
        const btnDel = document.createElement('button');
        btnDel.textContent = currentTexts.btnDelete;
        btnDel.className = 'btn-danger';
        btnDel.onclick = () => {
          if (confirm(currentTexts.confirmDelete.replace('{name}', emp.name))) {
            employees = employees.filter(e => e.id !== emp.id);
            saveEmployees();
            refreshEmployeeUI();
            updateHoursInfo();
            updatePlanHoursInfo();
            renderMonthlyReport();
          }
        };
        row.appendChild(btnDel);
        employeeListDiv.appendChild(row);
      });

      const disabled = employees.length === 0;
      btnIn.disabled = disabled;
      btnOut.disabled = disabled;
      if (disabled) {
        statusEl.textContent = currentTexts.noEmployees;
      } else {
        statusEl.textContent = currentTexts.clockReady;
      }
    }

    employeeSelect.addEventListener('change', () => {
      updateHoursInfo();
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (emp && emp.activeSessionStart) {
        statusEl.textContent = currentTexts.clockInStatus.replace(
          '{time}',
          new Date(emp.activeSessionStart).toLocaleString()
        );
      } else {
        statusEl.textContent = currentTexts.clockReady;
      }
    });

    planEmployeeSelect.addEventListener('change', () => {
      updatePlanHoursInfo();
    });

    // ============ ADICIONAR EMPREGADOS ============
    btnAddEmp.addEventListener('click', () => {
      const name = empNameInput.value.trim();
      const phone = empPhoneInput.value.trim();
      if (!name) {
        alert(currentTexts.enterName);
        return;
      }
      const emp = {
        id: generateId(),
        name,
        phone: phone || '',
        monthlyHours: {},
        timeBank: {},
        activeSessionStart: null
      };
      employees.push(emp);
      saveEmployees();
      empNameInput.value = '';
      empPhoneInput.value = '';
      refreshEmployeeUI();
      renderMonthlyReport();
    });

    // ============ STEMPENUHR ============
    btnIn.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(currentTexts.selectEmployee);
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (emp.activeSessionStart) {
        alert(currentTexts.alreadyClockedIn);
        return;
      }

      emp.activeSessionStart = new Date().toISOString();
      saveEmployees();
      statusEl.textContent = currentTexts.clockInNow.replace(
        '{time}',
        new Date(emp.activeSessionStart).toLocaleString()
      );
      addLog(emp.name + ' ' + currentTexts.logClockIn);
    });

    btnOut.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(currentTexts.selectEmployee);
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (!emp.activeSessionStart) {
        alert(currentTexts.notClockedIn);
        return;
      }

      const start = new Date(emp.activeSessionStart);
      const end = new Date();
      const diffMs = end - start;
      const hours = diffMs / 1000 / 60 / 60;

      const monthKey = getCurrentMonthKey();
      if (!emp.monthlyHours) emp.monthlyHours = {};
      if (!emp.timeBank) emp.timeBank = {};

      const prevTotal = emp.monthlyHours[monthKey] || 0;
      const newTotal = prevTotal + hours;
      emp.monthlyHours[monthKey] = newTotal;

      let bank = 0;
      if (newTotal > MAX_HOURS_PER_MONTH) {
        bank = newTotal - MAX_HOURS_PER_MONTH;
      }
      emp.timeBank[monthKey] = bank;

      emp.activeSessionStart = null;
      saveEmployees();

      statusEl.textContent = currentTexts.clockOutStatus
        .replace('{hours}', hours.toFixed(2))
        .replace('{total}', newTotal.toFixed(2));
      addLog(emp.name + ' ' + currentTexts.logClockOut.replace('{hours}', hours.toFixed(2)));

      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    });

    // ============ WHATSAPP â€“ CHEF ============
    function buildMessage() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const date = dateInput.value;
      const tFrom = timeFromInput.value;
      const tTo = timeToInput.value;

      if (!emp || !date || !tFrom || !tTo) {
        return "";
      }

      const dateDE = formatGermanDate(date);
      const { total, bank } = getHoursAndBank(emp);

      let hoursLine =
        `Aktueller Monat: ${total.toFixed(2)} Std. (Ãœberstundenkonto: ${bank.toFixed(2)} Std.)`;
      if (total > MAX_HOURS_PER_MONTH) {
        hoursLine += " â€“ LIMIT 40h Ã¼berschritten!";
      }

      const msg =
        "EiscafÃ© Sanremo â€“ Dienstplan\n\n" +
        "Hallo " + emp.name + ",\n\n" +
        "dein Dienst:\n" +
        "ðŸ“… Datum: " + dateDE + "\n" +
        "â° Zeit: " + tFrom + " â€“ " + tTo + " Uhr\n" +
        "ðŸ“ Ort: EiscafÃ© Sanremo, Bad Berleburg\n\n" +
        hoursLine + "\n\n" +
        "Bitte bestÃ¤tige mit OK.";
      return msg;
    }

    btnPreview.addEventListener('click', () => {
      const msg = buildMessage();
      if (!msg) {
        alert(currentTexts.fillPlanFields);
        return;
      }
      previewText.textContent = msg;
    });

    btnWhatsapp.addEventListener('click', () => {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const msg = buildMessage();

      if (!emp) {
        alert(currentTexts.selectEmployee);
        return;
      }
      if (!msg) {
        alert(currentTexts.fillPlanFields);
        return;
      }

      if (!emp.phone) {
        alert(currentTexts.noPhone);
        return;
      }

      const phone = emp.phone;
      const encodedMsg = encodeURIComponent(msg);
      const url = "https://wa.me/" + phone + "?text=" + encodedMsg;

      window.open(url, "_blank");
    });

    // ============ MONATSBERICHT (CHEF) ============
    function renderMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      if (!employees || employees.length === 0) {
        container.innerHTML = '<em>' + currentTexts.noEmployees + '</em>';
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse; font-size:14px;">';
      html += '<thead><tr>' +
              '<th style="border-bottom:1px solid #ccc; text-align:left; padding:4px;">' + currentTexts.tblEmployee + '</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">' + currentTexts.tblHours + '</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">' + currentTexts.tblBank + '</th>' +
              '</tr></thead><tbody>';

      let totalHoursAll = 0;
      let totalBankAll = 0;

      employees.forEach(emp => {
        const { total, bank } = getHoursAndBank(emp);
        totalHoursAll += total;
        totalBankAll += bank;

        html += '<tr>' +
          '<td style="border-bottom:1px solid #eee; padding:4px;">' + emp.name + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + total.toFixed(2) + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + bank.toFixed(2) + '</td>' +
          '</tr>';
      });

      html += '<tr>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + currentTexts.tblSum + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalHoursAll.toFixed(2) + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalBankAll.toFixed(2) + '</td>' +
        '</tr>';

      html += '</tbody></table>';

      container.innerHTML = html;
    }

    function printMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      const win = window.open('', '_blank');
      win.document.write('<html><head><title>Monatsbericht</title>');
      win.document.write('<meta charset="UTF-8">');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse;font-size:14px;} th,td{border:1px solid #ccc;padding:4px;} th{text-align:left;background:#f0f0f0;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h2>Monatsbericht</h2>');
      win.document.write('<p>Monat: ' + getCurrentMonthKey() + '</p>');
      win.document.write(container.innerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }

    // ============ TRADUÃ‡Ã•ES ============
    const translations = {
      de: {
        heroTitle: 'Mitarbeiterportal',
        heroSubtitle: 'Arbeitszeiterfassung & Dienstplanung',
        heroBadge: 'Stempeluhr â€¢ Dienstplan â€¢ WhatsApp',

        chefLoginTitle: 'Chef Login',
        chefPinLabel: 'PIN eingeben:',
        btnLogin: 'Login',
        chefLoginInfo: 'Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp & Monatsbericht) freigeschaltet.',
        chefLoginSuccess: 'Login erfolgreich. Chef-Bereiche sind freigeschaltet.',
        chefLoginFail: 'Falscher PIN.',

        manageEmployeesTitle: 'Mitarbeiter verwalten',
        empNameLabel: 'Name des Mitarbeiters:',
        empPhoneLabel: 'WhatsApp / Telefonnummer (optional):',
        btnAddEmp: 'Mitarbeiter hinzufÃ¼gen',
        empStorageInfo: 'Mitarbeiterliste, Stunden und Ãœberstunden werden im Browser (localStorage) gespeichert.',
        btnDelete: 'LÃ¶schen',
        confirmDelete: 'Mitarbeiter "{name}" wirklich lÃ¶schen?',

        planTitle: 'Dienstplan & WhatsApp',
        planEmpLabel: 'Mitarbeiter auswÃ¤hlen:',
        planDayLabel: 'Tag:',
        planFromLabel: 'Von (Uhrzeit):',
        planToLabel: 'Bis (Uhrzeit):',
        btnPreview: 'Nachricht anzeigen',
        btnWhatsapp: 'WhatsApp Ã¶ffnen',
        whatsInfo: 'WhatsApp wird mit vorbereiteter Nachricht geÃ¶ffnet. Du entscheidest, ob du sendest.',
        previewTitle: 'Vorschau Nachricht:',

        monthlyReportTitle: 'Monatsbericht (Chef)',
        monthlyReportInfo: 'Ãœbersicht aller Mitarbeiter fÃ¼r den aktuellen Monat.',
        btnPrintPdf: 'Drucken / als PDF speichern',

        legalTitle: 'Datenschutz & Nutzungshinweise',
        legalIntro: 'Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs. Es werden keine Daten auf externen Servern gespeichert.',
        legalBox1Title: '1. Datenschutz',
        legalBox1Text: 'Zugriff auf die gespeicherten Daten haben nur der Betrieb/Chef und die von ihm autorisierten Personen. Der Arbeitgeber ist dafÃ¼r verantwortlich, seine Mitarbeiter Ã¼ber die Datenerfassung zu informieren.',
        legalBox2Title: '2. Nutzung & Urheberrecht',
        legalBox2Text: 'Diese Anwendung ist nur fÃ¼r den lizenzierten Betrieb bestimmt. Eine Weitergabe, VervielfÃ¤ltigung, der Verkauf oder das Kopieren des Quellcodes und Designs an Dritte ohne ausdrÃ¼ckliche schriftliche Zustimmung des Entwicklers ist untersagt.',
        legalBox3Title: '3. Haftungsausschluss',
        legalBox3Text: 'Die Anwendung unterstÃ¼tzt bei der Erfassung von Arbeitszeiten. Die rechtlich korrekte Lohnabrechnung und Einhaltung arbeitsrechtlicher Vorschriften bleiben in der Verantwortung des Arbeitgebers.',

        clockTitle: 'Stempeluhr (fÃ¼r Mitarbeiter)',
        clockEmpLabel: 'Mitarbeiter auswÃ¤hlen:',
        clockReady: 'Bereit zum Stempeln.',
        btnClockIn: 'Einstempeln',
        btnClockOut: 'Ausstempeln',
        todayEntriesTitle: 'Heutige EintrÃ¤ge:',
        clockRule: 'Regel: Maximal 40 Stunden im Monat. Alles darÃ¼ber geht ins Ãœberstundenkonto (Bank von Stunden).',

        hoursInfoEmpty: 'Stunden diesen Monat: 0 | Ãœberstundenkonto: 0',
        hoursInfo: 'Stunden diesen Monat: {total} | Ãœberstundenkonto: {bank}',
        limitWarning: 'Limit 40h Ã¼berschritten!',
        optChooseEmployee: '-- Mitarbeiter wÃ¤hlen --',
        noEmployees: 'Keine Mitarbeiter angelegt. Chef muss zuerst Mitarbeiter hinzufÃ¼gen.',
        clockInStatus: 'Mitarbeiter ist aktuell eingestempelt (seit {time}).',
        enterName: 'Bitte einen Namen eingeben.',
        selectEmployee: 'Bitte zuerst einen Mitarbeiter auswÃ¤hlen.',
        alreadyClockedIn: 'Dieser Mitarbeiter ist bereits eingestempelt.',
        clockInNow: 'Eingestempelt um {time}.',
        logClockIn: 'eingestempelt',
        notClockedIn: 'Dieser Mitarbeiter ist noch nicht eingestempelt.',
        clockOutStatus: 'Ausgestempelt. Gearbeitete Zeit: {hours} Std. Gesamt in diesem Monat: {total} Std.',
        logClockOut: 'ausgestempelt ({hours} Std.)',
        fillPlanFields: 'Bitte Mitarbeiter, Tag und Zeiten ausfÃ¼llen.',
        noPhone: 'FÃ¼r diesen Mitarbeiter ist keine Telefonnummer hinterlegt.',

        tblEmployee: 'Mitarbeiter',
        tblHours: 'Stunden im Monat',
        tblBank: 'Ãœberstundenkonto',
        tblSum: 'Summe:',

        linkImpressum: 'Impressum',
        linkDatenschutz: 'Datenschutz'
      },

      pt: {
        heroTitle: 'Portal de FuncionÃ¡rios',
        heroSubtitle: 'Registo de horas & plano de serviÃ§o',
        heroBadge: 'Ponto â€¢ Turnos â€¢ WhatsApp',

        chefLoginTitle: 'Login do Chefe',
        chefPinLabel: 'Introduzir PIN:',
        btnLogin: 'Entrar',
        chefLoginInfo: 'Depois do login sÃ£o ativadas as Ã¡reas do chefe (gestÃ£o de funcionÃ¡rios, plano / WhatsApp & relatÃ³rio mensal).',
        chefLoginSuccess: 'Login efetuado com sucesso. Ãreas do chefe ativadas.',
        chefLoginFail: 'PIN incorreto.',

        manageEmployeesTitle: 'Gerir funcionÃ¡rios',
        empNameLabel: 'Nome do funcionÃ¡rio:',
        empPhoneLabel: 'WhatsApp / NÃºmero de telefone (opcional):',
        btnAddEmp: 'Adicionar funcionÃ¡rio',
        empStorageInfo: 'Lista de funcionÃ¡rios, horas e banco de horas sÃ£o guardados localmente no navegador (localStorage).',
        btnDelete: 'Apagar',
        confirmDelete: 'Apagar o funcionÃ¡rio "{name}"?',

        planTitle: 'Plano de serviÃ§o & WhatsApp',
        planEmpLabel: 'Escolher funcionÃ¡rio:',
        planDayLabel: 'Dia:',
        planFromLabel: 'Das (hora):',
        planToLabel: 'AtÃ© (hora):',
        btnPreview: 'Mostrar mensagem',
        btnWhatsapp: 'Abrir WhatsApp',
        whatsInfo: 'O WhatsApp abre com a mensagem preparada. Tu decides se queres enviar.',
        previewTitle: 'PrÃ©-visualizaÃ§Ã£o da mensagem:',

        monthlyReportTitle: 'RelatÃ³rio mensal (Chefe)',
        monthlyReportInfo: 'Resumo de todos os funcionÃ¡rios no mÃªs atual.',
        btnPrintPdf: 'Imprimir / guardar como PDF',

        legalTitle: 'ProteÃ§Ã£o de dados & utilizaÃ§Ã£o',
        legalIntro: 'Este sistema guarda dados apenas localmente no navegador/tablet do estabelecimento. Nenhum dado Ã© guardado em servidores externos.',
        legalBox1Title: '1. ProteÃ§Ã£o de dados',
        legalBox1Text: 'SÃ³ o estabelecimento/chefe e as pessoas autorizadas por ele tÃªm acesso aos dados guardados. O empregador Ã© responsÃ¡vel por informar os funcionÃ¡rios sobre o registo de dados.',
        legalBox2Title: '2. UtilizaÃ§Ã£o & direitos de autor',
        legalBox2Text: 'Esta aplicaÃ§Ã£o destina-se apenas ao estabelecimento licenciado. Ã‰ proibida a transmissÃ£o, cÃ³pia, venda ou reproduÃ§Ã£o do cÃ³digo-fonte e design a terceiros sem autorizaÃ§Ã£o escrita do programador.',
        legalBox3Title: '3. ExclusÃ£o de responsabilidade',
        legalBox3Text: 'A aplicaÃ§Ã£o ajuda a registar horas de trabalho. O cÃ¡lculo correto de salÃ¡rios e o cumprimento das leis laborais continuam a ser da responsabilidade do empregador.',

        clockTitle: 'Ponto (para funcionÃ¡rios)',
        clockEmpLabel: 'Escolher funcionÃ¡rio:',
        clockReady: 'Pronto para picar ponto.',
        btnClockIn: 'Entrar',
        btnClockOut: 'Sair',
        todayEntriesTitle: 'Registos de hoje:',
        clockRule: 'Regra: mÃ¡ximo 40 horas por mÃªs. O resto vai para o banco de horas.',

        hoursInfoEmpty: 'Horas neste mÃªs: 0 | Banco de horas: 0',
        hoursInfo: 'Horas neste mÃªs: {total} | Banco de horas: {bank}',
        limitWarning: 'Limite de 40h ultrapassado!',
        optChooseEmployee: '-- Escolher funcionÃ¡rio --',
        noEmployees: 'Ainda nÃ£o hÃ¡ funcionÃ¡rios. O chefe tem de adicionar primeiro.',
        clockInStatus: 'FuncionÃ¡rio estÃ¡ com ponto marcado desde {time}.',
        enterName: 'Por favor, introduz um nome.',
        selectEmployee: 'Escolhe primeiro um funcionÃ¡rio.',
        alreadyClockedIn: 'Este funcionÃ¡rio jÃ¡ estÃ¡ com ponto marcado.',
        clockInNow: 'Ponto de entrada Ã s {time}.',
        logClockIn: 'entrou',
        notClockedIn: 'Este funcionÃ¡rio ainda nÃ£o marcou entrada.',
        clockOutStatus: 'SaÃ­da registada. Horas trabalhadas: {hours} h. Total este mÃªs: {total} h.',
        logClockOut: 'saiu ({hours} h)',
        fillPlanFields: 'Preenche funcionÃ¡rio, dia e horas.',
        noPhone: 'NÃ£o hÃ¡ nÃºmero de telefone guardado para este funcionÃ¡rio.',

        tblEmployee: 'FuncionÃ¡rio',
        tblHours: 'Horas no mÃªs',
        tblBank: 'Banco de horas',
        tblSum: 'Total:',

        linkImpressum: 'Impressum',
        linkDatenschutz: 'ProteÃ§Ã£o de dados'
      },

      it: {
        heroTitle: 'Portale dipendenti',
        heroSubtitle: 'Rilevazione orari & pianificazione turni',
        heroBadge: 'Timbro â€¢ Turni â€¢ WhatsApp',

        chefLoginTitle: 'Login titolare',
        chefPinLabel: 'Inserire PIN:',
        btnLogin: 'Login',
        chefLoginInfo: 'Dopo il login si attivano le aree del titolare (gestione dipendenti, planning / WhatsApp & rapporto mensile).',
        chefLoginSuccess: 'Login riuscito. Aree del titolare attivate.',
        chefLoginFail: 'PIN errato.',

        manageEmployeesTitle: 'Gestione dipendenti',
        empNameLabel: 'Nome del dipendente:',
        empPhoneLabel: 'WhatsApp / Numero di telefono (opzionale):',
        btnAddEmp: 'Aggiungi dipendente',
        empStorageInfo: 'Elenco dipendenti, ore e banca ore sono salvati localmente nel browser (localStorage).',
        btnDelete: 'Cancella',
        confirmDelete: 'Cancellare il dipendente "{name}"?',

        planTitle: 'Pianificazione turni & WhatsApp',
        planEmpLabel: 'Seleziona dipendente:',
        planDayLabel: 'Giorno:',
        planFromLabel: 'Da (ora):',
        planToLabel: 'A (ora):',
        btnPreview: 'Mostra messaggio',
        btnWhatsapp: 'Apri WhatsApp',
        whatsInfo: 'WhatsApp si apre con il messaggio preparato. Decidi tu se inviarlo.',
        previewTitle: 'Anteprima messaggio:',

        monthlyReportTitle: 'Rapporto mensile (Titolare)',
        monthlyReportInfo: 'Panoramica di tutti i dipendenti per il mese corrente.',
        btnPrintPdf: 'Stampa / salva come PDF',

        legalTitle: 'Protezione dati & utilizzo',
        legalIntro: 'Questo sistema salva i dati solo localmente nel browser/tablet dellâ€™esercizio. Nessun dato viene salvato su server esterni.',
        legalBox1Title: '1. Protezione dati',
        legalBox1Text: 'Solo lâ€™esercizio/il titolare e le persone da lui autorizzate hanno accesso ai dati salvati. Il datore di lavoro Ã¨ responsabile di informare i dipendenti sulla raccolta dei dati.',
        legalBox2Title: '2. Utilizzo & diritto dâ€™autore',
        legalBox2Text: 'Questa applicazione Ã¨ destinata solo allâ€™esercizio licenziatario. Ãˆ vietata la trasmissione, copia, vendita o riproduzione del codice sorgente e del design a terzi senza autorizzazione scritta dello sviluppatore.',
        legalBox3Title: '3. Esclusione di responsabilitÃ ',
        legalBox3Text: 'Lâ€™applicazione supporta la rilevazione degli orari di lavoro. Il corretto calcolo delle paghe e il rispetto delle norme sul lavoro restano responsabilitÃ  del datore di lavoro.',

        clockTitle: 'Timbro (per dipendenti)',
        clockEmpLabel: 'Seleziona dipendente:',
        clockReady: 'Pronto per timbrare.',
        btnClockIn: 'Entrata',
        btnClockOut: 'Uscita',
        todayEntriesTitle: 'Registrazioni di oggi:',
        clockRule: 'Regola: massimo 40 ore al mese. Il resto va nella banca ore.',

        hoursInfoEmpty: 'Ore in questo mese: 0 | Banca ore: 0',
        hoursInfo: 'Ore in questo mese: {total} | Banca ore: {bank}',
        limitWarning: 'Limite di 40 ore superato!',
        optChooseEmployee: '-- Seleziona dipendente --',
        noEmployees: 'Nessun dipendente inserito. Il titolare deve aggiungerli per primo.',
        clockInStatus: 'Il dipendente Ã¨ attualmente timbrato dallâ€™ora {time}.',
        enterName: 'Inserisci un nome.',
        selectEmployee: 'Seleziona prima un dipendente.',
        alreadyClockedIn: 'Questo dipendente ha giÃ  timbrato lâ€™entrata.',
        clockInNow: 'Entrata registrata alle {time}.',
        logClockIn: 'entrata',
        notClockedIn: 'Questo dipendente non ha ancora timbrato lâ€™entrata.',
        clockOutStatus: 'Uscita registrata. Ore lavorate: {hours} h. Totale nel mese: {total} h.',
        logClockOut: 'uscita ({hours} h)',
        fillPlanFields: 'Compila dipendente, giorno e orari.',
        noPhone: 'Per questo dipendente non Ã¨ stato salvato alcun numero di telefono.',

        tblEmployee: 'Dipendente',
        tblHours: 'Ore nel mese',
        tblBank: 'Banca ore',
        tblSum: 'Totale:',

        linkImpressum: 'Impressum',
        linkDatenschutz: 'Protezione dati'
      }
    };

    let currentLang = 'de';
    let currentTexts = translations.de;

    function applyTranslations() {
      const t = currentTexts;
      document.documentElement.lang = currentLang;

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
          el.innerHTML = t[key];
        }
      });

      // texts usados em JS
      currentTexts = t;

      // atualizar selects e info
      refreshEmployeeUI();
      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    }

    // LANGUAGE BUTTONS
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        currentLang = lang;
        localStorage.setItem('sanremo_lang', lang);

        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        applyTranslations();
      });
    });

    // ============ INICIALIZAÃ‡ÃƒO ============
    const savedLang = localStorage.getItem('sanremo_lang');
    if (savedLang && translations[savedLang]) {
      currentLang = savedLang;
      document.querySelectorAll('.lang-btn').forEach(b => {
        if (b.getAttribute('data-lang') === savedLang) b.classList.add('active');
        else b.classList.remove('active');
      });
      currentTexts = translations[savedLang];
    }

    loadEmployees();
    applyTranslations(); // tambÃ©m chama refresh UI etc.
  </script>
</body>
</html>
