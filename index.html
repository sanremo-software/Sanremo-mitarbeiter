
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Digitales Mitarbeiter-Kontrollsystem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f0f2f5">
  <link rel="manifest" href="manifest.json">

  <style>
    html, body {
      height: 100%;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 900px;
      margin: 0 auto;
      background: #f0f2f5;
      min-height: 100vh;
    }

    h3 { margin-top: 20px; }

    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }

    input, select, button {
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    select, input {
      width: 100%;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-danger {
      background: #d32f2f;
      color: #fff;
    }

    .section {
      border: 1px solid #ccc;
      padding: 14px;
      margin-top: 15px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    /* Fundo da casa do chefe com bandeira italiana */
    .chef-section {
      background: linear-gradient(90deg, #009246, #ffffff, #ce2b37);
      border: none;
    }
    .chef-section h3,
    .chef-section label,
    .chef-section small,
    .chef-section p {
      color: #111;
    }
    .chef-section input {
      background: #ffffff;
    }

    #status, #hoursInfo, #planHoursInfo {
      font-size: 14px;
      margin-top: 6px;
    }

    #log {
      margin-top: 10px;
      max-height: 220px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
    }

    .employee-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      gap: 8px;
    }
    .employee-row button {
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .warning {
      color: #d32f2f;
      font-weight: bold;
    }
    .box {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: #fafafa;
      margin-top: 10px;
    }
    #chefLoginStatus {
      font-size: 13px;
      margin-top: 6px;
    }
    small {
      font-size: 12px;
      color: #555;
    }

    @media (min-width: 700px) {
      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 16px;
      }
    }

    /* TOP BAR ‚Äì t√≠tulo + idioma */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .system-title {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.85);
      border-radius: 10px;
      color: #222;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      flex: 1;
    }
    .lang-switch {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      white-space: nowrap;
    }
    .lang-label-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .lang-switch label {
      font-size: 12px;
    }
    .lang-flag {
      padding: 2px 6px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      line-height: 1.2;
    }
    .lang-flag.active {
      border-color: #1976d2;
      box-shadow: 0 0 0 1px rgba(25,118,210,0.4);
    }
    .lang-switch select {
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      width: 100%;
    }

    @media (max-width: 600px) {
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .lang-switch {
        align-items: flex-start;
      }
    }

    /* HERO BANNER ‚Äì s√≥ a foto, sem letras vis√≠veis */
    .hero-banner {
      position: relative;
      margin-bottom: 24px;
      border-radius: 16px;
      overflow: hidden;
      height: 210px;
      background-image:
        url('IMG-20251125-WA0004.jpg');
      background-size: cover;
      background-position: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    /* Mantemos o hero-inner mas escondido, para o JS n√£o partir */
    .hero-inner {
      display: none;
    }

    @media (min-width: 700px) {
      .hero-banner {
        height: 230px;
      }
    }
  </style>
</head>
<body>

  <!-- T√çTULO + IDIOMA -->
  <div class="top-bar">
    <div id="systemTitle" class="system-title">
      Digitales Mitarbeiter-Kontrollsystem
    </div>
    <div class="lang-switch">
      <div class="lang-label-row">
        <label for="langSelect" id="langLabel">Sprache:</label>
        <button type="button" class="lang-flag" data-lang="de" id="flagDe">üá©üá™ DE</button>
        <button type="button" class="lang-flag" data-lang="pt" id="flagPt">üáµüáπ PT</button>
        <button type="button" class="lang-flag" data-lang="it" id="flagIt">üáÆüáπ IT</button>
      </div>
      <!-- Dropdown extra (segunda op√ß√£o) -->
      <select id="langSelect">
        <option value="de">Deutsch (DE)</option>
        <option value="pt">Portugu√™s (PT)</option>
        <option value="it">Italiano (IT)</option>
      </select>
    </div>
  </div>

  <!-- LOG√ìTIPO / FOTO ‚Äì sem letras -->
  <header class="hero-banner">
    <div class="hero-inner">
      <!-- Estes textos ficam ocultos via CSS -->
      <div class="hero-title" id="heroTitle" style="display:none;">Eiscaf√© Sanremo</div>
      <div class="hero-subtitle" id="heroSubtitle" style="display:none;">Mitarbeiterportal ‚Äì Bad Berleburg</div>
      <div class="hero-badge" id="heroBadge" style="display:none;">Stempeluhr ‚Ä¢ Dienstplan ‚Ä¢ WhatsApp</div>
    </div>
  </header>

  <!-- LOGIN DO CHEFE (com bandeira italiana de fundo) -->
  <div class="section chef-section">
    <h3 id="chefLoginTitle">Chef Login</h3>
    <label for="chefPinInput" id="chefPinLabel">PIN eingeben:</label>
    <input type="password" id="chefPinInput" placeholder="PIN">

    <button id="btnChefLogin" class="btn-primary" style="width:100%; margin-top:8px;">
      Login
    </button>
    <button id="btnChefLogout" class="btn-secondary" style="width:100%; margin-top:8px; display:none;">
      Logout
    </button>

    <p id="chefLoginStatus"></p>
    <small id="chefInfoText">
      Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp &amp; Monatsbericht) freigeschaltet.
    </small>
  </div>

  <div class="grid">
    <!-- √ÅREA DO CHEFE -->
    <div id="chefArea" style="display:none;">

      <!-- Gest√£o de empregados -->
      <div class="section">
        <h3 id="empManageTitle">Mitarbeiter verwalten</h3>

        <label for="empName" id="empNameLabel">Name des Mitarbeiters:</label>
        <input type="text" id="empName" placeholder="z.B. Jo√£o, Maria, ...">

        <label for="empPhone" id="empPhoneLabel">WhatsApp / Telefonnummer (optional):</label>
        <input type="text" id="empPhone" placeholder="z.B. 491701234567">

        <button id="btnAddEmp" class="btn-primary" style="width:100%; margin-top:10px;">
          Mitarbeiter hinzuf√ºgen
        </button>

        <div id="employeeList" style="margin-top:12px;"></div>

        <small id="empStorageNote">
          Mitarbeiterliste, Stunden und √úberstunden werden im Browser (localStorage) gespeichert.
        </small>
      </div>

      <!-- Plano + WhatsApp -->
      <div class="section">
        <h3 id="planTitle">Dienstplan &amp; WhatsApp</h3>

        <label for="planEmployeeSelect" id="planEmployeeLabel">Mitarbeiter ausw√§hlen:</label>
        <select id="planEmployeeSelect">
          <option value="">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="planHoursInfo">
          Stunden diesen Monat: 0 | √úberstundenkonto: 0
        </div>

        <label for="date" id="planDateLabel">Tag:</label>
        <input type="date" id="date">

        <label for="timeFrom" id="planFromLabel">Von (Uhrzeit):</label>
        <input type="time" id="timeFrom">

        <label for="timeTo" id="planToLabel">Bis (Uhrzeit):</label>
        <input type="time" id="timeTo">

        <div class="box">
          <button id="btnPreview" class="btn-secondary" style="width:100%; margin-bottom:6px;">
            Nachricht anzeigen
          </button>
          <button id="btnWhatsapp" class="btn-primary" style="width:100%;">
            WhatsApp √∂ffnen
          </button>
          <p id="whatsappInfoText" style="font-size:12px; margin-top:6px;">
            WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.
          </p>
        </div>

        <div class="box">
          <b id="previewTitle">Vorschau Nachricht:</b>
          <p id="previewText" style="white-space: pre-wrap; margin-top: 8px;">
            (Noch keine Nachricht)
          </p>
        </div>
      </div>

      <!-- Monatsbericht + Export -->
      <div class="section">
        <h3 id="monthlyReportTitle">Monatsbericht (Chef)</h3>
        <p id="monthlyReportDesc" style="font-size: 13px; margin-bottom:8px;">
          √úbersicht aller Mitarbeiter f√ºr den aktuellen Monat.
        </p>

        <div id="monthlyReportContainer"></div>

        <button id="btnPrintMonthly" class="btn-primary" style="width:100%; margin-top:10px;" onclick="printMonthlyReport()">
          Drucken / als PDF speichern
        </button>

        <button id="btnExportMonthAll" class="btn-secondary" style="width:100%; margin-top:8px;">
          Gesamten Monat (alle Mitarbeiter) als CSV exportieren
        </button>

        <div style="margin-top:16px; border-top:1px solid #eee; padding-top:10px;">
          <label for="exportMonth">Monat ausw√§hlen:</label>
          <input type="month" id="exportMonth" style="width:100%; margin-top:4px;">

          <label for="reportEmployeeSelect">Mitarbeiter f√ºr Export (Excel/CSV):</label>
          <select id="reportEmployeeSelect">
            <option value="">-- Mitarbeiter w√§hlen --</option>
          </select>

          <button id="btnExportExcel" class="btn-secondary" style="width:100%; margin-top:8px;">
            Als CSV f√ºr Excel exportieren
          </button>
          <small style="font-size:12px; color:#555;">
            CSV-Datei mit Datum, Startzeit, Endzeit, Stunden pro Tag und Monatssumme ‚Äì ideal f√ºr den Steuerberater.
          </small>

          <button id="btnPrintEmployeeDetail" class="btn-primary" style="width:100%; margin-top:8px;">
            Detaillierter Bericht (Drucker) f√ºr Mitarbeiter
          </button>
          <small style="font-size:12px; color:#555;">
            Druckfertiger Bericht mit Datum, Einstempelzeit, Ausstempelzeit und Stunden ‚Äì nur f√ºr den ausgew√§hlten Mitarbeiter.
          </small>
        </div>
      </div>
    </div>

    <!-- STEMPELUHR ‚Äì Empregados -->
    <div>
      <div class="section">
        <h3 id="stempTitle">Stempeluhr (f√ºr Mitarbeiter)</h3>

        <label for="employeeSelect" id="stempEmployeeLabel">Mitarbeiter ausw√§hlen:</label>
        <select id="employeeSelect">
          <option value="">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="hoursInfo">
          Stunden diesen Monat: 0 | √úberstundenkonto: 0
        </div>

        <div id="status">Bereit zum Stempeln.</div>

        <button id="btnIn" class="btn-primary" style="width:100%; margin-top:10px;">
          Einstempeln
        </button>
        <button id="btnOut" class="btn-secondary" style="width:100%; margin-top:8px;">
          Ausstempeln
        </button>

        <button id="btnCancelStempel" class="btn-danger" style="width:100%; margin-top:8px;">
          Stempel annullieren (letzter Eintrag)
        </button>

        <div id="log"><b>Heutige Eintr√§ge:</b><br></div>

        <small id="ruleNote">
          Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).
        </small>
      </div>
    </div>
  </div>

  <!-- DATENSCHUTZ & NUTZUNG (texto direto, em DE/PT/IT via JS se quiseres adaptar depois) -->
  <div class="section">
    <h3 id="legalTitle">Datenschutz & Nutzungshinweise</h3>
    <p id="legalIntro">
      Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs. Es werden keine Daten auf externen Servern gespeichert.
    </p>
    <ol>
      <li id="legalPoint1">
        Datenschutz: Zugriff auf die gespeicherten Daten haben nur der Betrieb/Chef und die von ihm autorisierten Personen. Der Arbeitgeber ist daf√ºr verantwortlich, seine Mitarbeiter √ºber die Datenerfassung zu informieren.
      </li>
      <li id="legalPoint2">
        Nutzung & Urheberrecht: Diese Anwendung ist nur f√ºr den lizenzierten Betrieb bestimmt. Eine Weitergabe, Vervielf√§ltigung, der Verkauf oder das Kopieren des Quellcodes und Designs an Dritte ohne ausdr√ºckliche schriftliche Zustimmung des Entwicklers ist untersagt.
      </li>
      <li id="legalPoint3">
        Haftungsausschluss: Die Anwendung unterst√ºtzt bei der Erfassung von Arbeitszeiten. Die rechtlich korrekte Lohnabrechnung und Einhaltung arbeitsrechtlicher Vorschriften bleiben in der Verantwortung des Arbeitgebers.
      </li>
    </ol>
  </div>

  <!-- FOOTER -->
  <footer class="section" style="margin-top:20px; text-align:center; font-size:12px; opacity:0.9;">
    <a href="impressum.html" id="footerImpressum">Impressum</a>
    <span> | </span>
    <a href="datenschutz.html" id="footerDatenschutz">Datenschutz</a>
  </footer>

  <script>
    const CHEF_PIN = "1234";
    const MAX_HOURS_PER_MONTH = 40;

    const translations = {
      de: {
        langLabel: 'Sprache:',
        systemTitle: 'Digitales Mitarbeiter-Kontrollsystem',
        heroSubtitle: 'Mitarbeiterportal ‚Äì Bad Berleburg',
        heroBadge: 'Stempeluhr ‚Ä¢ Dienstplan ‚Ä¢ WhatsApp',

        chefLoginTitle: 'Chef Login',
        chefPinLabel: 'PIN eingeben:',
        chefInfoText: 'Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp & Monatsbericht) freigeschaltet.',

        empManageTitle: 'Mitarbeiter verwalten',
        empNameLabel: 'Name des Mitarbeiters:',
        empPhoneLabel: 'WhatsApp / Telefonnummer (optional):',
        btnAddEmp: 'Mitarbeiter hinzuf√ºgen',
        empStorageNote: 'Mitarbeiterliste, Stunden und √úberstunden werden im Browser (localStorage) gespeichert.',

        planTitle: 'Dienstplan & WhatsApp',
        planEmployeeLabel: 'Mitarbeiter ausw√§hlen:',
        planDateLabel: 'Tag:',
        planFromLabel: 'Von (Uhrzeit):',
        planToLabel: 'Bis (Uhrzeit):',
        btnPreview: 'Nachricht anzeigen',
        btnWhatsapp: 'WhatsApp √∂ffnen',
        whatsappInfoText: 'WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.',
        previewTitle: 'Vorschau Nachricht:',
        previewPlaceholder: '(Noch keine Nachricht)',

        monthlyReportTitle: 'Monatsbericht (Chef)',
        monthlyReportDesc: '√úbersicht aller Mitarbeiter f√ºr den aktuellen Monat.',
        btnPrintMonthly: 'Drucken / als PDF speichern',

        stempTitle: 'Stempeluhr (f√ºr Mitarbeiter)',
        stempEmployeeLabel: 'Mitarbeiter ausw√§hlen:',
        ruleNote: 'Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).',
        logTitle: 'Heutige Eintr√§ge:',

        hoursInfoEmpty: 'Stunden diesen Monat: 0 | √úberstundenkonto: 0',
        hoursInfoText: 'Stunden diesen Monat: {hours} | √úberstundenkonto: {bank}',
        hoursLimitSuffix: ' ‚Äì LIMIT 40h √ºberschritten!',

        chefLoginSuccess: 'Login erfolgreich. Chef-Bereiche sind freigeschaltet.',
        chefLoginError: 'Falscher PIN.',
        statusNoEmployees: 'Keine Mitarbeiter angelegt. Chef muss zuerst Mitarbeiter hinzuf√ºgen.',
        statusReady: 'Bereit zum Stempeln.',
        statusStampedCurrent: 'Mitarbeiter ist aktuell eingestempelt (seit {time}).',

        monthlyNoEmployees: 'Keine Mitarbeiter angelegt.',
        monthlyTableEmp: 'Mitarbeiter',
        monthlyTableHours: 'Stunden im Monat',
        monthlyTableBank: '√úberstundenkonto',
        monthlyTableSum: 'Summe:',
        printTitle: 'Monatsbericht ‚Äì Eiscaf√© Sanremo',
        printMonthLabel: 'Monat: ',

        waHeader: 'Eiscaf√© Sanremo ‚Äì Dienstplan',
        waHello: 'Hallo {name},',
        waYourShift: 'dein Dienst:',
        waDate: 'üìÖ Datum',
        waTime: '‚è∞ Zeit',
        waPlace: 'üìç Ort',
        waPlaceValue: 'Eiscaf√© Sanremo, Bad Berleburg',
        waMonthInfo: 'Aktueller Monat: {hours} Std. (√úberstundenkonto: {bank} Std.)',
        waLimitNote: ' ‚Äì LIMIT 40h √ºberschritten!',
        waConfirm: 'Bitte best√§tige mit OK.',

        legalTitle: 'Datenschutz & Nutzungshinweise',
        legalIntro: 'Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs. Es werden keine Daten auf externen Servern gespeichert.',
        legalPoint1: 'Datenschutz: Zugriff auf die gespeicherten Daten haben nur der Betrieb/Chef und die von ihm autorisierten Personen. Der Arbeitgeber ist daf√ºr verantwortlich, seine Mitarbeiter √ºber die Datenerfassung zu informieren.',
        legalPoint2: 'Nutzung & Urheberrecht: Diese Anwendung ist nur f√ºr den lizenzierten Betrieb bestimmt. Eine Weitergabe, Vervielf√§ltigung, der Verkauf oder das Kopieren des Quellcodes und Designs an Dritte ohne ausdr√ºckliche schriftliche Zustimmung des Entwicklers ist untersagt.',
        legalPoint3: 'Haftungsausschluss: Die Anwendung unterst√ºtzt bei der Erfassung von Arbeitszeiten. Die rechtlich korrekte Lohnabrechnung und Einhaltung arbeitsrechtlicher Vorschriften bleiben in der Verantwortung des Arbeitgebers.',

        footerImpressum: 'Impressum',
        footerDatenschutz: 'Datenschutz'
      },
      pt: {
        langLabel: 'Idioma:',
        systemTitle: 'Sistema digital de controlo de funcion√°rios',
        heroSubtitle: 'Portal de funcion√°rios ‚Äì Bad Berleburg',
        heroBadge: 'Ponto ‚Ä¢ Escalas ‚Ä¢ WhatsApp',

        chefLoginTitle: 'Login do chefe',
        chefPinLabel: 'Introduzir PIN:',
        chefInfoText: 'Depois de um login bem-sucedido, s√£o desbloqueadas as √°reas do chefe (gest√£o de funcion√°rios, escalas / WhatsApp e relat√≥rio mensal).',

        empManageTitle: 'Gerir funcion√°rios',
        empNameLabel: 'Nome do funcion√°rio:',
        empPhoneLabel: 'WhatsApp / N√∫mero de telefone (opcional):',
        btnAddEmp: 'Adicionar funcion√°rio',
        empStorageNote: 'Lista de funcion√°rios, horas e banco de horas s√£o guardados neste dispositivo (localStorage).',

        planTitle: 'Escala & WhatsApp',
        planEmployeeLabel: 'Escolher funcion√°rio:',
        planDateLabel: 'Dia:',
        planFromLabel: 'Das (hora):',
        planToLabel: 'At√© (hora):',
        btnPreview: 'Mostrar mensagem',
        btnWhatsapp: 'Abrir WhatsApp',
        whatsappInfoText: 'O WhatsApp abre com a mensagem preparada. Tu decides se queres enviar.',
        previewTitle: 'Pr√©-visualiza√ß√£o da mensagem:',
        previewPlaceholder: '(Ainda sem mensagem)',

        monthlyReportTitle: 'Relat√≥rio mensal (chefe)',
        monthlyReportDesc: 'Resumo de todos os funcion√°rios no m√™s atual.',
        btnPrintMonthly: 'Imprimir / guardar em PDF',

        stempTitle: 'Rel√≥gio de ponto (funcion√°rios)',
        stempEmployeeLabel: 'Escolher funcion√°rio:',
        ruleNote: 'Regra: M√°ximo 40 horas por m√™s. Tudo acima vai para o banco de horas.',
        logTitle: 'Registos de hoje:',

        hoursInfoEmpty: 'Horas neste m√™s: 0 | Banco de horas: 0',
        hoursInfoText: 'Horas neste m√™s: {hours} | Banco de horas: {bank}',
        hoursLimitSuffix: ' ‚Äì LIMITE 40h ultrapassado!',

        chefLoginSuccess: 'Login efetuado com sucesso. √Åreas do chefe desbloqueadas.',
        chefLoginError: 'PIN incorreto.',
        statusNoEmployees: 'Ainda n√£o h√° funcion√°rios. O chefe tem de adicionar primeiro.',
        statusReady: 'Pronto para registar ponto.',
        statusStampedCurrent: 'Funcion√°rio est√° com ponto aberto (desde {time}).',

        monthlyNoEmployees: 'Nenhum funcion√°rio registado.',
        monthlyTableEmp: 'Funcion√°rio',
        monthlyTableHours: 'Horas no m√™s',
        monthlyTableBank: 'Banco de horas',
        monthlyTableSum: 'Total:',
        printTitle: 'Relat√≥rio mensal ‚Äì Eiscaf√© Sanremo',
        printMonthLabel: 'M√™s: ',

        waHeader: 'Eiscaf√© Sanremo ‚Äì Escala',
        waHello: 'Ol√° {name},',
        waYourShift: 'o teu turno:',
        waDate: 'üìÖ Dia',
        waTime: '‚è∞ Hor√°rio',
        waPlace: 'üìç Local',
        waPlaceValue: 'Eiscaf√© Sanremo, Bad Berleburg',
        waMonthInfo: 'M√™s atual: {hours} h (banco de horas: {bank} h)',
        waLimitNote: ' ‚Äì LIMITE 40h ultrapassado!',
        waConfirm: 'Por favor confirma com OK.',

        legalTitle: 'Prote√ß√£o de dados & Utiliza√ß√£o',
        legalIntro: 'Este sistema guarda os dados apenas localmente no navegador/tablet do estabelecimento. Nenhum dado √© enviado para servidores externos.',
        legalPoint1: 'Prote√ß√£o de dados: Apenas o estabelecimento/chefe e as pessoas autorizadas por ele t√™m acesso aos dados guardados. O empregador √© respons√°vel por informar os funcion√°rios sobre a recolha destes dados.',
        legalPoint2: 'Utiliza√ß√£o & direitos de autor: Esta aplica√ß√£o √© destinada apenas ao estabelecimento licenciado. √â proibida a partilha, c√≥pia, venda ou reprodu√ß√£o do c√≥digo e do design a terceiros sem autoriza√ß√£o escrita do desenvolvedor.',
        legalPoint3: 'Exclus√£o de responsabilidade: A aplica√ß√£o ajuda a registar horas de trabalho, mas n√£o substitui a contabilidade oficial. O c√°lculo correto de sal√°rios e o cumprimento da legisla√ß√£o laboral continuam sob responsabilidade do empregador.',

        footerImpressum: 'Impressum',
        footerDatenschutz: 'Prote√ß√£o de dados'
      },
      it: {
        langLabel: 'Lingua:',
        systemTitle: 'Sistema digitale di controllo dipendenti',
        heroSubtitle: 'Portale dipendenti ‚Äì Bad Berleburg',
        heroBadge: 'Timbratura ‚Ä¢ Turni ‚Ä¢ WhatsApp',

        chefLoginTitle: 'Login del capo',
        chefPinLabel: 'Inserisci PIN:',
        chefInfoText: 'Dopo il login andato a buon fine si sbloccano le aree del capo (gestione dipendenti, turni / WhatsApp e rapporto mensile).',

        empManageTitle: 'Gestione dipendenti',
        empNameLabel: 'Nome del dipendente:',
        empPhoneLabel: 'WhatsApp / Numero di telefono (opzionale):',
        btnAddEmp: 'Aggiungi dipendente',
        empStorageNote: 'Elenco dipendenti, ore e banca ore sono salvati su questo dispositivo (localStorage).',

        planTitle: 'Turni & WhatsApp',
        planEmployeeLabel: 'Seleziona dipendente:',
        planDateLabel: 'Giorno:',
        planFromLabel: 'Da (ora):',
        planToLabel: 'A (ora):',
        btnPreview: 'Mostra messaggio',
        btnWhatsapp: 'Apri WhatsApp',
        whatsappInfoText: 'WhatsApp si apre con il messaggio preparato. Decidi tu se inviarlo.',
        previewTitle: 'Anteprima messaggio:',
        previewPlaceholder: '(Ancora nessun messaggio)',

        monthlyReportTitle: 'Rapporto mensile (capo)',
        monthlyReportDesc: 'Panoramica di tutti i dipendenti per il mese corrente.',
        btnPrintMonthly: 'Stampa / salva in PDF',

        stempTitle: 'Timbro orario (dipendenti)',
        stempEmployeeLabel: 'Seleziona dipendente:',
        ruleNote: 'Regola: massimo 40 ore al mese. Tutto oltre va nella banca ore.',
        logTitle: 'Registrazioni di oggi:',

        hoursInfoEmpty: 'Ore in questo mese: 0 | Banca ore: 0',
        hoursInfoText: 'Ore in questo mese: {hours} | Banca ore: {bank}',
        hoursLimitSuffix: ' ‚Äì LIMITE 40h superato!',

        chefLoginSuccess: 'Login eseguito. Aree del capo sbloccate.',
        chefLoginError: 'PIN errato.',
        statusNoEmployees: 'Nessun dipendente creato. Il capo deve aggiungerne uno.',
        statusReady: 'Pronto per timbrare.',
        statusStampedCurrent: 'Il dipendente √® attualmente timbrato (da {time}).',

        monthlyNoEmployees: 'Nessun dipendente presente.',
        monthlyTableEmp: 'Dipendente',
        monthlyTableHours: 'Ore nel mese',
        monthlyTableBank: 'Banca ore',
        monthlyTableSum: 'Totale:',
        printTitle: 'Rapporto mensile ‚Äì Eiscaf√© Sanremo',
        printMonthLabel: 'Mese: ',

        waHeader: 'Eiscaf√© Sanremo ‚Äì Turno',
        waHello: 'Ciao {name},',
        waYourShift: 'il tuo turno:',
        waDate: 'üìÖ Data',
        waTime: '‚è∞ Orario',
        waPlace: 'üìç Luogo',
        waPlaceValue: 'Eiscaf√© Sanremo, Bad Berleburg',
        waMonthInfo: 'Mese corrente: {hours} h (banca ore: {bank} h)',
        waLimitNote: ' ‚Äì LIMITE 40h superato!',
        waConfirm: 'Per favore conferma con OK.',

        legalTitle: 'Protezione dei dati & Utilizzo',
        legalIntro: 'Questo sistema salva i dati solo localmente nel browser/tablet dell\'esercizio. Nessun dato viene inviato a server esterni.',
        legalPoint1: 'Protezione dei dati: Solo l\'azienda/il titolare e le persone da lui autorizzate hanno accesso ai dati salvati. Il datore di lavoro √® responsabile di informare i dipendenti sulla raccolta di questi dati.',
        legalPoint2: 'Utilizzo & diritto d\'autore: Questa applicazione √® destinata esclusivamente all\'esercizio licenziatario. √à vietata la condivisione, copia, vendita o riproduzione del codice e del design a terzi senza autorizzazione scritta dello sviluppatore.',
        legalPoint3: 'Esclusione di responsabilit√†: L\'applicazione aiuta a registrare le ore di lavoro, ma non sostituisce la contabilit√† ufficiale. Il calcolo corretto delle retribuzioni e il rispetto delle norme sul lavoro rimangono responsabilit√† del datore di lavoro.',

        footerImpressum: 'Impressum',
        footerDatenschutz: 'Protezione dei dati'
      }
    };

    let employees = [];
    let currentLang = localStorage.getItem('sanremoLang') || 'de';

    const chefPinInput = document.getElementById('chefPinInput');
    const btnChefLogin = document.getElementById('btnChefLogin');
    const btnChefLogout = document.getElementById('btnChefLogout');
    const chefLoginStatus = document.getElementById('chefLoginStatus');
    const chefArea = document.getElementById('chefArea');

    const empNameInput = document.getElementById('empName');
    const empPhoneInput = document.getElementById('empPhone');
    const btnAddEmp = document.getElementById('btnAddEmp');
    const employeeListDiv = document.getElementById('employeeList');

    const employeeSelect = document.getElementById('employeeSelect');
    const statusEl = document.getElementById('status');
    const hoursInfoEl = document.getElementById('hoursInfo');
    const logEl = document.getElementById('log');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');
    const btnCancelStempel = document.getElementById('btnCancelStempel');

    const planEmployeeSelect = document.getElementById('planEmployeeSelect');
    const planHoursInfoEl = document.getElementById('planHoursInfo');
    const dateInput = document.getElementById('date');
    const timeFromInput = document.getElementById('timeFrom');
    const timeToInput = document.getElementById('timeTo');
    const btnPreview = document.getElementById('btnPreview');
    const btnWhatsapp = document.getElementById('btnWhatsapp');
    const previewText = document.getElementById('previewText');

    const monthlyReportContainer = document.getElementById('monthlyReportContainer');

    const langSelect = document.getElementById('langSelect');
    const flagButtons = document.querySelectorAll('.lang-flag');

    const reportEmployeeSelect = document.getElementById('reportEmployeeSelect');
    const btnExportExcel = document.getElementById('btnExportExcel');
    const btnExportMonthAll = document.getElementById('btnExportMonthAll');
    const btnPrintEmployeeDetail = document.getElementById('btnPrintEmployeeDetail');
    const exportMonthInput = document.getElementById('exportMonth');

    function setActiveFlag(lang) {
      flagButtons.forEach(btn => {
        if (btn.dataset.lang === lang) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    function applyLanguage(lang) {
      const t = translations[lang] || translations.de;
      currentLang = lang;
      localStorage.setItem('sanremoLang', lang);
      langSelect.value = lang;
      setActiveFlag(lang);

      document.getElementById('langLabel').textContent = t.langLabel;
      document.getElementById('systemTitle').textContent = t.systemTitle;
      document.getElementById('heroSubtitle').textContent = t.heroSubtitle;
      document.getElementById('heroBadge').textContent = t.heroBadge;

      document.getElementById('chefLoginTitle').textContent = t.chefLoginTitle;
      document.getElementById('chefPinLabel').textContent = t.chefPinLabel;
      document.getElementById('chefInfoText').textContent = t.chefInfoText;

      document.getElementById('empManageTitle').textContent = t.empManageTitle;
      document.getElementById('empNameLabel').textContent = t.empNameLabel;
      document.getElementById('empPhoneLabel').textContent = t.empPhoneLabel;
      document.getElementById('empStorageNote').textContent = t.empStorageNote;
      btnAddEmp.textContent = t.btnAddEmp;

      document.getElementById('planTitle').textContent = t.planTitle;
      document.getElementById('planEmployeeLabel').textContent = t.planEmployeeLabel;
      document.getElementById('planDateLabel').textContent = t.planDateLabel;
      document.getElementById('planFromLabel').textContent = t.planFromLabel;
      document.getElementById('planToLabel').textContent = t.planToLabel;
      btnPreview.textContent = t.btnPreview;
      btnWhatsapp.textContent = t.btnWhatsapp;
      document.getElementById('whatsappInfoText').textContent = t.whatsappInfoText;
      document.getElementById('previewTitle').textContent = t.previewTitle;

      document.getElementById('monthlyReportTitle').textContent = t.monthlyReportTitle;
      document.getElementById('monthlyReportDesc').textContent = t.monthlyReportDesc;
      document.getElementById('btnPrintMonthly').textContent = t.btnPrintMonthly;

      document.getElementById('stempTitle').textContent = t.stempTitle;
      document.getElementById('stempEmployeeLabel').textContent = t.stempEmployeeLabel;
      document.getElementById('ruleNote').textContent = t.ruleNote;

      document.getElementById('legalTitle').textContent = t.legalTitle;
      document.getElementById('legalIntro').textContent = t.legalIntro;
      document.getElementById('legalPoint1').textContent = t.legalPoint1;
      document.getElementById('legalPoint2').textContent = t.legalPoint2;
      document.getElementById('legalPoint3').textContent = t.legalPoint3;

      const fImp = document.getElementById('footerImpressum');
      const fDat = document.getElementById('footerDatenschutz');
      if (fImp) fImp.textContent = t.footerImpressum;
      if (fDat) fDat.textContent = t.footerDatenschutz;

      hoursInfoEl.innerHTML = t.hoursInfoEmpty;
      planHoursInfoEl.innerHTML = t.hoursInfoEmpty;
      logEl.innerHTML = '<b>' + t.logTitle + '</b><br>';

      if (employees.length === 0) {
        statusEl.textContent = t.statusNoEmployees;
      } else {
        statusEl.textContent = t.statusReady;
      }
      previewText.textContent = t.previewPlaceholder;
    }

    langSelect.addEventListener('change', (e) => {
      applyLanguage(e.target.value);
      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    });

    flagButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.dataset.lang;
        applyLanguage(lang);
        updateHoursInfo();
        updatePlanHoursInfo();
        renderMonthlyReport();
      });
    });

    btnChefLogin.addEventListener('click', () => {
      const t = translations[currentLang];
      const pin = chefPinInput.value.trim();
      if (pin === CHEF_PIN) {
        chefArea.style.display = 'block';
        btnChefLogout.style.display = 'block';
        chefLoginStatus.style.color = 'green';
        chefLoginStatus.textContent = t.chefLoginSuccess;
        chefPinInput.value = '';
      } else {
        chefLoginStatus.style.color = 'red';
        chefLoginStatus.textContent = t.chefLoginError;
      }
    });

    btnChefLogout.addEventListener('click', () => {
      chefArea.style.display = 'none';
      btnChefLogout.style.display = 'none';
      chefLoginStatus.textContent = '';
      chefLoginStatus.style.color = '';
      chefPinInput.value = '';
      alert('Logout abgeschlossen.');
    });

    function loadEmployees() {
      const data = localStorage.getItem('sanremoEmployees');
      if (data) {
        employees = JSON.parse(data);
      } else {
        employees = [];
      }
    }

    function saveEmployees() {
      localStorage.setItem('sanremoEmployees', JSON.stringify(employees));
    }

    function generateId() {
      return 'emp_' + Math.random().toString(36).substring(2, 9);
    }

    function getCurrentMonthKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function getSelectedMonthKey() {
      if (exportMonthInput && exportMonthInput.value) {
        return exportMonthInput.value;
      }
      return getCurrentMonthKey();
    }

    function formatGermanDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("de-DE", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }

    function getHoursAndBank(emp) {
      const monthKey = getCurrentMonthKey();
      const total = (emp.monthlyHours && emp.monthlyHours[monthKey]) || 0;
      const bank = (emp.timeBank && emp.timeBank[monthKey]) || 0;
      return { total, bank };
    }

    function setHoursInfoElement(el, emp) {
      const t = translations[currentLang];
      if (!emp) {
        el.innerHTML = t.hoursInfoEmpty;
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = t.hoursInfoText
        .replace('{hours}', total.toFixed(2))
        .replace('{bank}', bank.toFixed(2));
      if (total > MAX_HOURS_PER_MONTH) {
        text += t.hoursLimitSuffix;
      }
      el.innerHTML = text;
    }

    function updateHoursInfo() {
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      setHoursInfoElement(hoursInfoEl, emp);
    }

    function updatePlanHoursInfo() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      setHoursInfoElement(planHoursInfoEl, emp);
    }

    function addLog(text) {
      const now = new Date().toLocaleString();
      logEl.innerHTML += `${text} ‚Äì <i>${now}</i><br>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function refreshEmployeeUI() {
      const t = translations[currentLang];

      employeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
      planEmployeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
      if (reportEmployeeSelect) {
        reportEmployeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
      }

      employees.forEach(emp => {
        const opt1 = document.createElement('option');
        opt1.value = emp.id;
        opt1.textContent = emp.name;
        employeeSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = emp.id;
        opt2.textContent = emp.name;
        planEmployeeSelect.appendChild(opt2);

        if (reportEmployeeSelect) {
          const opt3 = document.createElement('option');
          opt3.value = emp.id;
          opt3.textContent = emp.name;
          reportEmployeeSelect.appendChild(opt3);
        }
      });

      employeeListDiv.innerHTML = '';
      employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        row.innerHTML = `<span>${emp.name} ${emp.phone ? '(' + emp.phone + ')' : ''}</span>`;
        const btnDel = document.createElement('button');
        btnDel.textContent = 'L√∂schen';
        btnDel.className = 'btn-danger';
        btnDel.onclick = () => {
          if (confirm('Mitarbeiter "' + emp.name + '" wirklich l√∂schen?')) {
            employees = employees.filter(e => e.id !== emp.id);
            saveEmployees();
            refreshEmployeeUI();
            updateHoursInfo();
            updatePlanHoursInfo();
            renderMonthlyReport();
          }
        };
        row.appendChild(btnDel);
        employeeListDiv.appendChild(row);
      });

      const disabled = employees.length === 0;
      btnIn.disabled = disabled;
      btnOut.disabled = disabled;
      if (btnCancelStempel) btnCancelStempel.disabled = disabled;

      if (disabled) {
        statusEl.textContent = t.statusNoEmployees;
      } else {
        statusEl.textContent = t.statusReady;
      }
    }

    employeeSelect.addEventListener('change', () => {
      const t = translations[currentLang];
      updateHoursInfo();
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (emp && emp.activeSessionStart) {
        statusEl.textContent = t.statusStampedCurrent.replace(
          '{time}',
          new Date(emp.activeSessionStart).toLocaleString()
        );
      } else {
        statusEl.textContent = t.statusReady;
      }
    });

    planEmployeeSelect.addEventListener('change', () => {
      updatePlanHoursInfo();
    });

    btnAddEmp.addEventListener('click', () => {
      const name = empNameInput.value.trim();
      const phone = empPhoneInput.value.trim();
      if (!name) {
        alert('Bitte einen Namen eingeben.');
        return;
      }
      const emp = {
        id: generateId(),
        name,
        phone: phone || '',
        monthlyHours: {},
        timeBank: {},
        workLog: {},
        activeSessionStart: null
      };
      employees.push(emp);
      saveEmployees();
      empNameInput.value = '';
      empPhoneInput.value = '';
      refreshEmployeeUI();
      renderMonthlyReport();
    });

    btnIn.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (emp.activeSessionStart) {
        alert('Dieser Mitarbeiter ist bereits eingestempelt.');
        return;
      }

      emp.activeSessionStart = new Date().toISOString();
      saveEmployees();
      statusEl.textContent = 'Eingestempelt um ' +
        new Date(emp.activeSessionStart).toLocaleString() + '.';
      addLog(emp.name + ' eingestempelt');
    });

    btnOut.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (!emp.activeSessionStart) {
        alert('Dieser Mitarbeiter ist noch nicht eingestempelt.');
        return;
      }

      const start = new Date(emp.activeSessionStart);
      const end = new Date();
      const diffMs = end - start;
      const hours = diffMs / 1000 / 60 / 60;

      const monthKey = getCurrentMonthKey();
      if (!emp.monthlyHours) emp.monthlyHours = {};
      if (!emp.timeBank) emp.timeBank = {};

      const prevTotal = emp.monthlyHours[monthKey] || 0;
      const newTotal = prevTotal + hours;
      emp.monthlyHours[monthKey] = newTotal;

      let bank = 0;
      if (newTotal > MAX_HOURS_PER_MONTH) {
        bank = newTotal - MAX_HOURS_PER_MONTH;
      }
      emp.timeBank[monthKey] = bank;

      if (!emp.workLog) emp.workLog = {};
      if (!emp.workLog[monthKey]) emp.workLog[monthKey] = [];
      emp.workLog[monthKey].push({
        date: start.toISOString().slice(0, 10),
        start: start.toISOString(),
        end: end.toISOString(),
        hours: hours
      });

      emp.activeSessionStart = null;
      saveEmployees();

      statusEl.textContent = 'Ausgestempelt. Gearbeitete Zeit: ' +
        hours.toFixed(2) + ' Std. Gesamt in diesem Monat: ' +
        newTotal.toFixed(2) + ' Std.';
      addLog(emp.name + ' ausgestempelt (' + hours.toFixed(2) + ' Std.)');

      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    });

    if (btnCancelStempel) {
      btnCancelStempel.addEventListener('click', () => {
        const empId = employeeSelect.value;
        if (!empId) {
          alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
          return;
        }
        const emp = employees.find(e => e.id === empId);
        if (!emp) return;

        const monthKey = getCurrentMonthKey();
        const t = translations[currentLang];

        if (emp.activeSessionStart) {
          emp.activeSessionStart = null;
          saveEmployees();
          statusEl.textContent = t.statusReady;
          addLog(emp.name + ' Einstempeln annulliert.');
          return;
        }

        if (!emp.workLog || !emp.workLog[monthKey] || emp.workLog[monthKey].length === 0) {
          alert('Kein Eintrag zum Annullieren f√ºr diesen Monat.');
          return;
        }

        const logs = emp.workLog[monthKey];
        const last = logs[logs.length - 1];
        const dateInfo = last.date || '';

        if (!confirm('Letzten Eintrag vom ' + dateInfo + ' wirklich l√∂schen?')) {
          return;
        }

        const hoursToRemove = last.hours || 0;
        logs.pop();

        if (!emp.monthlyHours) emp.monthlyHours[monthKey] = emp.monthlyHours[monthKey] || 0;
        const prevTotal = emp.monthlyHours[monthKey] || 0;
        let newTotal = prevTotal - hoursToRemove;
        if (newTotal < 0) newTotal = 0;
        emp.monthlyHours[monthKey] = newTotal;

        if (!emp.timeBank) emp.timeBank = {};
        let bank = 0;
        if (newTotal > MAX_HOURS_PER_MONTH) {
          bank = newTotal - MAX_HOURS_PER_MONTH;
        }
        emp.timeBank[monthKey] = bank;

        saveEmployees();
        updateHoursInfo();
        updatePlanHoursInfo();
        renderMonthlyReport();

        addLog(emp.name + ' letzter Eintrag annulliert (' + hoursToRemove.toFixed(2) + ' Std.).');
      });
    }

    function buildMessage() {
      const t = translations[currentLang];
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const date = dateInput.value;
      const tFrom = timeFromInput.value;
      const tTo = timeToInput.value;

      if (!emp || !date || !tFrom || !tTo) {
        return "";
      }

      const dateDE = formatGermanDate(date);
      const { total, bank } = getHoursAndBank(emp);

      let hoursLine =
        t.waMonthInfo
          .replace('{hours}', total.toFixed(2))
          .replace('{bank}', bank.toFixed(2));
      if (total > MAX_HOURS_PER_MONTH) {
        hoursLine += t.waLimitNote;
      }

      const msg =
        t.waHeader + "\n\n" +
        t.waHello.replace('{name}', emp.name) + "\n\n" +
        t.waYourShift + "\n" +
        t.waDate + ": " + dateDE + "\n" +
        t.waTime + ": " + tFrom + " ‚Äì " + tTo + " Uhr\n" +
        t.waPlace + ": " + t.waPlaceValue + "\n\n" +
        hoursLine + "\n\n" +
        t.waConfirm;
      return msg;
    }

    btnPreview.addEventListener('click', () => {
      const msg = buildMessage();
      if (!msg) {
        alert("Bitte Mitarbeiter, Tag und Zeiten ausf√ºllen.");
        return;
      }
      previewText.textContent = msg;
    });

    btnWhatsapp.addEventListener('click', () => {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const msg = buildMessage();

      if (!emp) {
        alert("Bitte Mitarbeiter w√§hlen.");
        return;
      }
      if (!msg) {
        alert("Bitte Mitarbeiter, Tag und Zeiten ausf√ºllen.");
        return;
      }

      if (!emp.phone) {
        alert("F√ºr diesen Mitarbeiter ist keine Telefonnummer hinterlegt.");
        return;
      }

      const phone = emp.phone;
      const encodedMsg = encodeURIComponent(msg);
      const url = "https://wa.me/" + phone + "?text=" + encodedMsg;

      window.open(url, "_blank");
    });

    function renderMonthlyReport() {
      const t = translations[currentLang];
      if (!monthlyReportContainer) return;

      if (!employees || employees.length === 0) {
        monthlyReportContainer.innerHTML = '<em>' + t.monthlyNoEmployees + '</em>';
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse; font-size:14px;">';
      html += '<thead><tr>' +
              '<th style="border-bottom:1px solid #ccc; text-align:left; padding:4px;">' + t.monthlyTableEmp + '</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">' + t.monthlyTableHours + '</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">' + t.monthlyTableBank + '</th>' +
              '</tr></thead><tbody>';

      let totalHoursAll = 0;
      let totalBankAll = 0;

      employees.forEach(emp => {
        const { total, bank } = getHoursAndBank(emp);
        totalHoursAll += total;
        totalBankAll += bank;

        html += '<tr>' +
          '<td style="border-bottom:1px solid #eee; padding:4px;">' + emp.name + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + total.toFixed(2) + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + bank.toFixed(2) + '</td>' +
          '</tr>';
      });

      html += '<tr>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + t.monthlyTableSum + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalHoursAll.toFixed(2) + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalBankAll.toFixed(2) + '</td>' +
        '</tr>';

      html += '</tbody></table>';

      monthlyReportContainer.innerHTML = html;
    }

    function printMonthlyReport() {
      const t = translations[currentLang];
      if (!monthlyReportContainer) return;

      const win = window.open('', '_blank');
      win.document.write('<html><head><title>' + t.printTitle + '</title>');
      win.document.write('<meta charset="UTF-8">');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse;font-size:14px;} th,td{border:1px solid #ccc;padding:4px;} th{text-align:left;background:#f0f0f0;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h2>' + t.printTitle + '</h2>');
      win.document.write('<p>' + t.printMonthLabel + getCurrentMonthKey() + '</p>');
      win.document.write(monthlyReportContainer.innerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }

    window.printMonthlyReport = printMonthlyReport;

    function exportEmployeeMonthToCSV() {
      if (!reportEmployeeSelect) return;
      const empId = reportEmployeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter f√ºr den Export w√§hlen.');
        return;
      }

      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        alert('Mitarbeiter nicht gefunden.');
        return;
      }

      const monthKey = getSelectedMonthKey();
      const logs = (emp.workLog && emp.workLog[monthKey]) ? emp.workLog[monthKey] : [];

      if (!logs.length) {
        alert('F√ºr diesen Monat gibt es keine Eintr√§ge f√ºr diesen Mitarbeiter.');
        return;
      }

      let csv = 'Mitarbeiter;Datum;Einstempelzeit;Ausstempelzeit;Stunden\n';

      let totalHours = 0;
      logs.forEach(entry => {
        const date = entry.date;
        const startTime = new Date(entry.start);
        const endTime = new Date(entry.end);

        const startStr = startTime.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        const endStr = endTime.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        const hours = entry.hours || 0;
        totalHours += hours;

        csv += `${emp.name};${date};${startStr};${endStr};${hours.toFixed(2)}\n`;
      });

      csv += `Gesamt;;;;${totalHours.toFixed(2)}\n`;

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const fileNameSafe = emp.name.replace(/\s+/g, '_');
      link.href = url;
      link.download = `stunden_${fileNameSafe}_${monthKey}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function printEmployeeDetailReport() {
      if (!reportEmployeeSelect) return;
      const empId = reportEmployeeSelect.value;
      if (!empId) {
        alert('Bitte zuerst einen Mitarbeiter f√ºr den Bericht w√§hlen.');
        return;
      }

      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        alert('Mitarbeiter nicht gefunden.');
        return;
      }

      const monthKey = getSelectedMonthKey();
      const logs = (emp.workLog && emp.workLog[monthKey]) ? emp.workLog[monthKey] : [];

      if (!logs.length) {
        alert('F√ºr diesen Monat gibt es keine Eintr√§ge f√ºr diesen Mitarbeiter.');
        return;
      }

      let tableHtml = '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
      tableHtml += '<thead><tr>' +
        '<th style="border:1px solid #ccc; padding:4px; text-align:left;">Mitarbeiter</th>' +
        '<th style="border:1px solid #ccc; padding:4px; text-align:left;">Datum</th>' +
        '<th style="border:1px solid #ccc; padding:4px; text-align:left;">Einstempelzeit</th>' +
        '<th style="border:1px solid #ccc; padding:4px; text-align:left;">Ausstempelzeit</th>' +
        '<th style="border:1px solid #ccc; padding:4px; text-align:right;">Stunden</th>' +
        '</tr></thead><tbody>';

      let totalHours = 0;

      logs.forEach(entry => {
        const date = entry.date;
        const startTime = new Date(entry.start);
        const endTime = new Date(entry.end);
        const hours = entry.hours || 0;
        totalHours += hours;

        const startStr = startTime.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        const endStr = endTime.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});

        tableHtml += '<tr>' +
          '<td style="border:1px solid #ccc; padding:4px;">' + emp.name + '</td>' +
          '<td style="border:1px solid #ccc; padding:4px;">' + date + '</td>' +
          '<td style="border:1px solid #ccc; padding:4px;">' + startStr + '</td>' +
          '<td style="border:1px solid #ccc; padding:4px;">' + endStr + '</td>' +
          '<td style="border:1px solid #ccc; padding:4px; text-align:right;">' + hours.toFixed(2) + '</td>' +
          '</tr>';
      });

      tableHtml += '<tr>' +
        '<td colspan="4" style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">Gesamt</td>' +
        '<td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">' + totalHours.toFixed(2) + '</td>' +
        '</tr>';

      tableHtml += '</tbody></table>';

      const win = window.open('', '_blank');
      win.document.write('<html><head><title>Stundenbericht ‚Äì ' + emp.name + ' ‚Äì ' + monthKey + '</title>');
      win.document.write('<meta charset="UTF-8">');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} h2,h3{margin:0 0 8px 0;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h2>Stundenbericht</h2>');
      win.document.write('<h3>Mitarbeiter: ' + emp.name + '</h3>');
      win.document.write('<p>Monat: ' + monthKey + '</p>');
      win.document.write(tableHtml);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }

    function exportMonthAllToCSV() {
      if (!employees || employees.length === 0) {
        alert('Keine Mitarbeiter angelegt.');
        return;
      }
      const monthKey = getSelectedMonthKey();

      let csv = 'Name;Monat;Monatsstunden;√úberstundenkonto\n';
      let totalHoursAll = 0;
      let totalBankAll = 0;

      employees.forEach(emp => {
        const total = (emp.monthlyHours && emp.monthlyHours[monthKey]) || 0;
        const bank = (emp.timeBank && emp.timeBank[monthKey]) || 0;
        totalHoursAll += total;
        totalBankAll += bank;
        csv += `${emp.name};${monthKey};${total.toFixed(2)};${bank.toFixed(2)}\n`;
      });

      csv += `Gesamt;${monthKey};${totalHoursAll.toFixed(2)};${totalBankAll.toFixed(2)}\n`;

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `monatsuebersicht_${monthKey}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    loadEmployees();
    refreshEmployeeUI();
    updateHoursInfo();
    updatePlanHoursInfo();
    renderMonthlyReport();
    applyLanguage(currentLang);

    if (exportMonthInput) {
      exportMonthInput.value = getCurrentMonthKey();
    }

    if (btnExportExcel && reportEmployeeSelect) {
      btnExportExcel.addEventListener('click', exportEmployeeMonthToCSV);
    }
    if (btnExportMonthAll) {
      btnExportMonthAll.addEventListener('click', exportMonthAllToCSV);
    }
    if (btnPrintEmployeeDetail && reportEmployeeSelect) {
      btnPrintEmployeeDetail.addEventListener('click', printEmployeeDetailReport);
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(function (err) {
        console.error('ServiceWorker-Fehler:', err);
      });
    }
  </script>

</body>
</html>
