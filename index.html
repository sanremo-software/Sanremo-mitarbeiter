
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Mitarbeiterportal ‚Äì Zeit & Dienstplan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f0f2f5">
  <link rel="manifest" href="manifest.json">

  <!-- Biblioteca para export Word (DOCX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.umd.min.js"
          integrity="sha512-NzH6k3iCWaC+7Ns4Zwy9zcfJDoBbJx4F3jh6Bb3+1h3tqUeqS9pkLxyRQyThgOvGgZC9CgnB5Ty2hny0PRCAxg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 1050px;
      margin: 0 auto;
      background: #f0f2f5;
      min-height: 100vh;
    }
    h2, h3 { margin-top: 0; }
    label { display:block; margin-top:8px; font-weight:bold; }
    input, select, button {
      padding:10px; margin-top:4px; font-size:16px; box-sizing:border-box;
    }
    select, input { width:100%; }
    button {
      cursor:pointer; border-radius:6px; border:none;
    }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-secondary { background:#eee; color:#333; }
    .btn-danger { background:#d32f2f; color:#fff; }
    .btn-ghost { background:transparent; color:#1976d2; border:1px solid #1976d2; }

    .section {
      border:1px solid #ccc; padding:14px; margin-top:15px;
      border-radius:10px; background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.06);
    }

    #status, #hoursInfo, #planHoursInfo, #exportInfo {
      font-size:14px; margin-top:6px;
    }
    #log {
      margin-top:10px; max-height:220px; overflow-y:auto;
      background:#fff; border:1px solid #ddd; padding:8px;
      font-size:13px; border-radius:6px;
    }

    .employee-row {
      display:flex; justify-content:space-between; align-items:center;
      font-size:14px; padding:4px 0; border-bottom:1px solid #eee; gap:8px;
    }
    .employee-row button {
      padding:6px 10px; font-size:12px; white-space:nowrap;
    }

    .warning { color:#d32f2f; font-weight:bold; }
    .box {
      border:1px solid #ccc; padding:10px; border-radius:8px;
      background:#fafafa; margin-top:10px;
    }
    small { font-size:12px; color:#555; }

    @media (min-width:850px) {
      .grid { display:grid; grid-template-columns:1.1fr 1fr; gap:16px; }
    }

    /* HERO topo */
    .hero-banner {
      position:relative; margin-bottom:24px; border-radius:16px;
      overflow:hidden; height:210px;
      background-image:
        linear-gradient(135deg, rgba(0,0,0,0.55), rgba(0,0,0,0.2)),
        url('IMG-20251125-WA0004.jpg');
      background-size:cover; background-position:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.12); color:#fff;
    }
    .hero-overlay {
      position:absolute; left:18px; right:18px; bottom:18px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px;
    }
    .hero-text { max-width:70%; text-shadow:0 2px 4px rgba(0,0,0,0.6); }
    .hero-title { font-size:22px; font-weight:700; }
    .hero-subtitle { font-size:14px; opacity:0.95; }
    .hero-badge {
      margin-top:6px; display:inline-block; font-size:11px;
      padding:3px 10px; border-radius:999px;
      background:rgba(0,0,0,0.55);
    }

    .neutral-logo {
      width:76px; height:76px; border-radius:20px; background:#fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.35);
      color:#1976d2; font-size:34px;
    }

    .lang-switcher {
      position:absolute; top:10px; right:14px; display:flex; gap:4px;
    }
    .lang-btn {
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:none; cursor:pointer; background:rgba(255,255,255,0.85);
    }
    .lang-btn.active { background:#1976d2; color:#fff; }

    /* Login chefe fundo bandeira */
    .chef-login-section {
      background:linear-gradient(
        90deg,
        #008C45 0%, #008C45 33%,
        #F4F5F0 33%, #F4F5F0 66%,
        #CD212A 66%, #CD212A 100%
      );
      padding:3px; border-radius:12px; margin-bottom:12px;
    }
    .chef-login-inner {
      background:#fff; border-radius:10px; padding:14px;
    }

    /* Legal cards */
    .legal-grid { display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:700px) {
      .legal-grid { grid-template-columns:repeat(3,1fr); }
    }
    .legal-card {
      background:#fafafa; border-radius:8px; padding:10px;
      border:1px solid #ddd; font-size:13px;
    }
    .legal-card h4 { margin:0 0 6px 0; font-size:14px; }

    footer {
      margin-top:20px; text-align:center; font-size:12px; color:#555;
    }
  </style>
</head>
<body>
  <!-- BANNER -->
  <header class="hero-banner">
    <div class="lang-switcher">
      <button class="lang-btn active" data-lang="de">DE</button>
      <button class="lang-btn" data-lang="pt">PT</button>
      <button class="lang-btn" data-lang="it">IT</button>
    </div>
    <div class="hero-overlay">
      <div class="hero-text">
        <div class="hero-title" data-i18n="heroTitle">
          Mitarbeiterportal ‚Äì Zeit &amp; Dienstplan
        </div>
        <div class="hero-subtitle" data-i18n="heroSubtitle">
          Tablet-optimiertes System zur Arbeitszeiterfassung und Schichtplanung.
        </div>
        <div class="hero-badge" data-i18n="heroBadge">
          Lokal im Betrieb ¬∑ Keine Cloud ¬∑ Ideal f√ºr kleine Teams
        </div>
      </div>
      <div class="neutral-logo">‚è±</div>
    </div>
  </header>

  <!-- LOGIN CHEFE -->
  <div class="chef-login-section">
    <div class="chef-login-inner">
      <div class="section" style="margin-top:0; box-shadow:none; border:none; padding:0;">
        <h3 data-i18n="chefLoginTitle">Chef Login</h3>
        <label for="chefPinInput" data-i18n="chefPinLabel">PIN eingeben:</label>
        <input type="password" id="chefPinInput" placeholder="PIN">

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="btnChefLogin" class="btn-primary" style="flex:1;" data-i18n="chefLoginBtn">Login</button>
          <button id="btnChefLogout" class="btn-secondary" style="flex:0.7;" data-i18n="chefLogoutBtn" disabled>Logout</button>
        </div>

        <p id="chefLoginStatus"></p>
        <small data-i18n="chefLoginHint">
          Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp, Export &amp; Datenschutz) freigeschaltet.
        </small>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- √ÅREA DO CHEFE -->
    <div id="chefArea" style="display:none;">
      <!-- Gest√£o empregados -->
      <div class="section">
        <h3 data-i18n="manageEmployeesTitle">Mitarbeiter verwalten</h3>

        <label for="empName" data-i18n="empNameLabel">Name des Mitarbeiters:</label>
        <input type="text" id="empName" data-i18n-placeholder="empNamePlaceholder" placeholder="z.B. Jo√£o, Maria, ...">

        <label for="empPhone" data-i18n="empPhoneLabel">WhatsApp / Telefonnummer (optional):</label>
        <input type="text" id="empPhone" data-i18n-placeholder="empPhonePlaceholder" placeholder="z.B. 491701234567">

        <button id="btnAddEmp" class="btn-primary" style="width:100%; margin-top:10px;" data-i18n="addEmpBtn">
          Mitarbeiter hinzuf√ºgen
        </button>

        <div id="employeeList" style="margin-top:12px;"></div>

        <small data-i18n="manageEmployeesInfo">
          Mitarbeiterliste und Arbeitszeiten werden nur lokal im Browser/Tablet gespeichert (localStorage). Es werden keine Daten an Server gesendet.
        </small>
      </div>

      <!-- Dienstplan + WhatsApp -->
      <div class="section">
        <h3 data-i18n="planTitle">Dienstplan &amp; WhatsApp</h3>

        <label for="planEmployeeSelect" data-i18n="planEmpSelectLabel">Mitarbeiter ausw√§hlen:</label>
        <select id="planEmployeeSelect">
          <option value="" data-i18n="selectEmployeeOption">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="planHoursInfo">Stunden diesen Monat: 0 | √úberstundenkonto: 0</div>

        <label for="date" data-i18n="planDateLabel">Tag:</label>
        <input type="date" id="date">

        <label for="timeFrom" data-i18n="planFromLabel">Von (Uhrzeit):</label>
        <input type="time" id="timeFrom">

        <label for="timeTo" data-i18n="planToLabel">Bis (Uhrzeit):</label>
        <input type="time" id="timeTo">

        <div class="box">
          <button id="btnPreview" class="btn-secondary" style="width:100%; margin-bottom:6px;" data-i18n="previewMsgBtn">
            Nachricht anzeigen
          </button>
          <button id="btnWhatsapp" class="btn-primary" style="width:100%;" data-i18n="openWhatsappBtn">
            WhatsApp √∂ffnen
          </button>
          <p style="font-size:12px; margin-top:6px;" data-i18n="whatsappInfo">
            WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.
          </p>
        </div>

        <div class="box">
          <b data-i18n="previewTitle">Vorschau Nachricht:</b>
          <p id="previewText" style="white-space: pre-wrap; margin-top: 8px;">(Noch keine Nachricht)</p>
        </div>
      </div>

      <!-- Monatsbericht (sum√°rio) -->
      <div class="section">
        <h3 data-i18n="monthlyReportTitle">Monatsbericht (√úbersicht)</h3>
        <p style="font-size:13px; margin-bottom:8px;" data-i18n="monthlyReportInfo">
          √úbersicht aller Mitarbeiter f√ºr den aktuellen Monat ‚Äì Gesamtstunden und √úberstundenkonto.
        </p>
        <div id="monthlyReportContainer"></div>
        <button class="btn-secondary" style="width:100%; margin-top:10px;" onclick="printMonthlyReport()" data-i18n="printReportBtn">
          Drucken / als PDF speichern
        </button>
      </div>

      <!-- Monats-Export (Word) -->
      <div class="section" id="monthlyExportSection">
        <h3 data-i18n="monthly_export_title">Monats-Export (Word)</h3>
        <p style="font-size:13px; margin-bottom:8px;" data-i18n="monthly_export_desc">
          Export pro Mitarbeiter und Monat ‚Äì ideal f√ºr den Steuerberater. Die Datei wird als Word-Dokument (.docx) mit einer Tabelle wie dem Stundennachweis erstellt.
        </p>

        <label for="exportEmployeeSelect" data-i18n="monthly_export_employee">Mitarbeiter ausw√§hlen:</label>
        <select id="exportEmployeeSelect">
          <option value="" data-i18n="selectEmployeeOption">-- Mitarbeiter w√§hlen --</option>
        </select>

        <label for="exportMonthSelect" style="margin-top:10px;" data-i18n="monthly_export_month">Monat ausw√§hlen:</label>
        <select id="exportMonthSelect"></select>

        <button type="button"
                class="btn-primary"
                style="width:100%; margin-top:12px;"
                onclick="exportMonthlyWord()"
                data-i18n="monthly_export_btn">
          Word-Export erstellen
        </button>

        <p id="exportInfo" style="font-size:12px; margin-top:8px; color:#555;"></p>
      </div>

      <!-- Legal / Datenschutz -->
      <div class="section" id="legalSection">
        <h3 data-i18n="legalTitle">Datenschutz &amp; Nutzungshinweise</h3>
        <p style="font-size:13px;" data-i18n="legalIntro">
          Kurze Zusammenfassung der wichtigsten Punkte. Details k√∂nnen Sie Ihrem Steuerberater / Rechtsberater zeigen.
        </p>

        <div class="legal-grid">
          <div class="legal-card">
            <h4 data-i18n="legalCard1Title">1. Datenschutz</h4>
            <p data-i18n="legalCard1Text">
              Alle Daten werden nur lokal im Browser/Tablet des Betriebs gespeichert. Es werden keine Daten auf externe Server √ºbertragen.
            </p>
          </div>
          <div class="legal-card">
            <h4 data-i18n="legalCard2Title">2. Nutzung &amp; Urheberrecht</h4>
            <p data-i18n="legalCard2Text">
              Die Anwendung ist nur f√ºr den lizenzierten Betrieb bestimmt. Weitergabe, Kopieren oder Verkauf ohne schriftliche Zustimmung des Entwicklers ist untersagt.
            </p>
          </div>
          <div class="legal-card">
            <h4 data-i18n="legalCard3Title">3. Haftung</h4>
            <p data-i18n="legalCard3Text">
              Die App unterst√ºtzt bei der Erfassung von Arbeitszeiten. Lohnabrechnung und Einhaltung arbeitsrechtlicher Vorschriften bleiben in der Verantwortung des Arbeitgebers.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- STEMPELUHR EMPREGADOS -->
    <div>
      <div class="section">
        <h3 data-i18n="clockTitle">Stempeluhr (f√ºr Mitarbeiter)</h3>

        <label for="employeeSelect" data-i18n="clockEmpSelectLabel">Mitarbeiter ausw√§hlen:</label>
        <select id="employeeSelect">
          <option value="" data-i18n="selectEmployeeOption">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="hoursInfo">Stunden diesen Monat: 0 | √úberstundenkonto: 0</div>
        <div id="status" data-i18n="clockReady">Bereit zum Stempeln.</div>

        <button id="btnIn" class="btn-primary" style="width:100%; margin-top:10px;" data-i18n="clockInBtn">
          Einstempeln
        </button>
        <button id="btnOut" class="btn-secondary" style="width:100%; margin-top:8px;" data-i18n="clockOutBtn">
          Ausstempeln
        </button>
        <button id="btnUndo" class="btn-ghost" style="width:100%; margin-top:8px;" data-i18n="clockUndoBtn">
          Letzten Stempel l√∂schen
        </button>

        <div id="log"><b data-i18n="todayEntriesTitle">Heutige Eintr√§ge:</b><br></div>

        <small data-i18n="clockRule">
          Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).
        </small>
      </div>
    </div>
  </div>

  <footer>
    &copy; <span id="year"></span> ‚Äì <span data-i18n="footerText">Lokales Mitarbeiterportal zur Arbeitszeiterfassung.</span>
  </footer>

  <script>
    /* TRADU√á√ïES */
    const translations = {
      de: {
        heroTitle: 'Mitarbeiterportal ‚Äì Zeit & Dienstplan',
        heroSubtitle: 'Tablet-optimiertes System zur Arbeitszeiterfassung und Schichtplanung.',
        heroBadge: 'Lokal im Betrieb ¬∑ Keine Cloud ¬∑ Ideal f√ºr kleine Teams',

        chefLoginTitle: 'Chef Login',
        chefPinLabel: 'PIN eingeben:',
        chefLoginBtn: 'Login',
        chefLogoutBtn: 'Logout',
        chefLoginHint: 'Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp, Export & Datenschutz) freigeschaltet.',
        chefLoginOk: 'Login erfolgreich. Chef-Bereiche sind freigeschaltet.',
        chefLoginFail: 'Falscher PIN.',
        chefLogoutMsg: 'Logout erfolgreich.',

        manageEmployeesTitle: 'Mitarbeiter verwalten',
        empNameLabel: 'Name des Mitarbeiters:',
        empNamePlaceholder: 'z.B. Jo√£o, Maria, ...',
        empPhoneLabel: 'WhatsApp / Telefonnummer (optional):',
        empPhonePlaceholder: 'z.B. 491701234567',
        addEmpBtn: 'Mitarbeiter hinzuf√ºgen',
        manageEmployeesInfo: 'Mitarbeiterliste und Arbeitszeiten werden nur lokal im Browser/Tablet gespeichert (localStorage). Es werden keine Daten an Server gesendet.',
        deleteEmpConfirm: 'Mitarbeiter wirklich l√∂schen?',

        planTitle: 'Dienstplan & WhatsApp',
        planEmpSelectLabel: 'Mitarbeiter ausw√§hlen:',
        planDateLabel: 'Tag:',
        planFromLabel: 'Von (Uhrzeit):',
        planToLabel: 'Bis (Uhrzeit):',
        previewMsgBtn: 'Nachricht anzeigen',
        openWhatsappBtn: 'WhatsApp √∂ffnen',
        whatsappInfo: 'WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.',
        previewTitle: 'Vorschau Nachricht:',
        selectEmployeeOption: '-- Mitarbeiter w√§hlen --',

        monthlyReportTitle: 'Monatsbericht (√úbersicht)',
        monthlyReportInfo: '√úbersicht aller Mitarbeiter f√ºr den aktuellen Monat ‚Äì Gesamtstunden und √úberstundenkonto.',
        printReportBtn: 'Drucken / als PDF speichern',

        monthly_export_title: 'Monats-Export (Word)',
        monthly_export_desc: 'Export pro Mitarbeiter und Monat ‚Äì ideal f√ºr den Steuerberater. Die Datei wird als Word-Dokument (.docx) mit einer Tabelle wie dem Stundennachweis erstellt.',
        monthly_export_employee: 'Mitarbeiter ausw√§hlen:',
        monthly_export_month: 'Monat ausw√§hlen:',
        monthly_export_btn: 'Word-Export erstellen',

        legalTitle: 'Datenschutz & Nutzungshinweise',
        legalIntro: 'Kurze Zusammenfassung der wichtigsten Punkte. Details k√∂nnen Sie Ihrem Steuerberater / Rechtsberater zeigen.',
        legalCard1Title: '1. Datenschutz',
        legalCard1Text: 'Alle Daten werden nur lokal im Browser/Tablet des Betriebs gespeichert. Es werden keine Daten auf externe Server √ºbertragen.',
        legalCard2Title: '2. Nutzung & Urheberrecht',
        legalCard2Text: 'Die Anwendung ist nur f√ºr den lizenzierten Betrieb bestimmt. Weitergabe, Kopieren oder Verkauf ohne schriftliche Zustimmung des Entwicklers ist untersagt.',
        legalCard3Title: '3. Haftung',
        legalCard3Text: 'Die App unterst√ºtzt bei der Erfassung von Arbeitszeiten. Lohnabrechnung und Einhaltung arbeitsrechtlicher Vorschriften bleiben in der Verantwortung des Arbeitgebers.',

        clockTitle: 'Stempeluhr (f√ºr Mitarbeiter)',
        clockEmpSelectLabel: 'Mitarbeiter ausw√§hlen:',
        clockReady: 'Bereit zum Stempeln.',
        clockInBtn: 'Einstempeln',
        clockOutBtn: 'Ausstempeln',
        clockUndoBtn: 'Letzten Stempel l√∂schen',
        todayEntriesTitle: 'Heutige Eintr√§ge:',
        clockRule: 'Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).',
        clockAlreadyIn: 'Dieser Mitarbeiter ist bereits eingestempelt.',
        clockNotIn: 'Dieser Mitarbeiter ist noch nicht eingestempelt.',
        clockSelectEmp: 'Bitte zuerst einen Mitarbeiter ausw√§hlen.',
        clockUndoNoEntries: 'Keine Eintr√§ge zum L√∂schen vorhanden.',

        msgMissingFields: 'Bitte Mitarbeiter, Tag und Zeiten ausf√ºllen.',
        msgMissingEmp: 'Bitte Mitarbeiter w√§hlen.',
        msgNoPhone: 'F√ºr diesen Mitarbeiter ist keine Telefonnummer hinterlegt.',

        footerText: 'Lokales Mitarbeiterportal zur Arbeitszeiterfassung.'
      },
      pt: {
        heroTitle: 'Portal de Funcion√°rios ‚Äì Horas & Turnos',
        heroSubtitle: 'Sistema optimizado para tablet para registar horas e organizar turnos.',
        heroBadge: 'Dados apenas locais ¬∑ Sem cloud ¬∑ Ideal para equipas pequenas',

        chefLoginTitle: 'Login do chefe',
        chefPinLabel: 'Introduzir PIN:',
        chefLoginBtn: 'Login',
        chefLogoutBtn: 'Logout',
        chefLoginHint: 'Depois do login activam-se as √°reas do chefe (gest√£o de funcion√°rios, turnos / WhatsApp, exporta√ß√£o & protec√ß√£o de dados).',
        chefLoginOk: 'Login com sucesso. √Åreas do chefe activadas.',
        chefLoginFail: 'PIN errado.',
        chefLogoutMsg: 'Sess√£o terminada.',

        manageEmployeesTitle: 'Gest√£o de funcion√°rios',
        empNameLabel: 'Nome do funcion√°rio:',
        empNamePlaceholder: 'Ex.: Jo√£o, Maria, ...',
        empPhoneLabel: 'WhatsApp / Telem√≥vel (opcional):',
        empPhonePlaceholder: 'Ex.: 491701234567',
        addEmpBtn: 'Adicionar funcion√°rio',
        manageEmployeesInfo: 'Lista de funcion√°rios e horas s√£o guardadas apenas localmente no tablet (localStorage). Nada √© enviado para servidores externos.',
        deleteEmpConfirm: 'Eliminar este funcion√°rio?',

        planTitle: 'Plano de servi√ßo & WhatsApp',
        planEmpSelectLabel: 'Escolher funcion√°rio:',
        planDateLabel: 'Dia:',
        planFromLabel: 'Das (hora):',
        planToLabel: 'At√© (hora):',
        previewMsgBtn: 'Mostrar mensagem',
        openWhatsappBtn: 'Abrir WhatsApp',
        whatsappInfo: 'O WhatsApp abre com mensagem preparada. Tu decides se envias.',
        previewTitle: 'Pr√©-visualiza√ß√£o da mensagem:',
        selectEmployeeOption: '-- Escolher funcion√°rio --',

        monthlyReportTitle: 'Relat√≥rio mensal (vista geral)',
        monthlyReportInfo: 'Vista geral de todos os funcion√°rios no m√™s actual ‚Äì horas totais e banco de horas.',
        printReportBtn: 'Imprimir / guardar em PDF',

        monthly_export_title: 'Exporta√ß√£o mensal (Word)',
        monthly_export_desc: 'Exporta√ß√£o por funcion√°rio e m√™s ‚Äì ideal para o contabilista. O ficheiro √© criado em Word (.docx) com uma tabela tipo folha de horas.',
        monthly_export_employee: 'Escolher funcion√°rio:',
        monthly_export_month: 'Escolher m√™s:',
        monthly_export_btn: 'Criar Word',

        legalTitle: 'Protec√ß√£o de dados & utiliza√ß√£o',
        legalIntro: 'Resumo curto dos pontos principais. Mostra os detalhes ao teu contabilista / advogado se precisares.',
        legalCard1Title: '1. Dados',
        legalCard1Text: 'Todos os dados s√£o guardados apenas localmente no tablet. Nada √© enviado para servidores externos.',
        legalCard2Title: '2. Utiliza√ß√£o & direitos de autor',
        legalCard2Text: 'A aplica√ß√£o √© apenas para o neg√≥cio licenciado. √â proibido copiar, revender ou partilhar sem autoriza√ß√£o escrita do criador.',
        legalCard3Title: '3. Responsabilidade',
        legalCard3Text: 'A app ajuda a registar horas. O c√°lculo final de sal√°rios e o cumprimento da lei laboral continuam responsabilidade do empregador.',

        clockTitle: 'Rel√≥gio de ponto (empregados)',
        clockEmpSelectLabel: 'Escolher funcion√°rio:',
        clockReady: 'Pronto para picar.',
        clockInBtn: 'Entrar (Einstempeln)',
        clockOutBtn: 'Sair (Ausstempeln)',
        clockUndoBtn: 'Anular √∫ltimo registo',
        todayEntriesTitle: 'Registos de hoje:',
        clockRule: 'Regra: m√°ximo 40 horas por m√™s. O resto vai para banco de horas.',
        clockAlreadyIn: 'Esse funcion√°rio j√° est√° picado como presente.',
        clockNotIn: 'Esse funcion√°rio ainda n√£o picou entrada.',
        clockSelectEmp: 'Escolhe primeiro um funcion√°rio.',
        clockUndoNoEntries: 'N√£o h√° registos para apagar.',

        msgMissingFields: 'Escolhe funcion√°rio, dia e horas.',
        msgMissingEmp: 'Escolhe um funcion√°rio.',
        msgNoPhone: 'N√£o est√° guardado n√∫mero de telefone para este funcion√°rio.',

        footerText: 'Portal local de funcion√°rios para registo de horas.'
      },
      it: {
        heroTitle: 'Portale Dipendenti ‚Äì Ore & Turni',
        heroSubtitle: 'Sistema ottimizzato per tablet per registrare le ore e gestire i turni.',
        heroBadge: 'Dati solo locali ¬∑ Nessun cloud ¬∑ Ideale per piccoli team',

        chefLoginTitle: 'Login del capo',
        chefPinLabel: 'Inserire PIN:',
        chefLoginBtn: 'Login',
        chefLogoutBtn: 'Logout',
        chefLoginHint: 'Dopo il login si attivano le aree del capo (gestione dipendenti, turni / WhatsApp, export & privacy).',
        chefLoginOk: 'Login riuscito. Aree del capo attivate.',
        chefLoginFail: 'PIN errato.',
        chefLogoutMsg: 'Logout eseguito.',

        manageEmployeesTitle: 'Gestione dipendenti',
        empNameLabel: 'Nome del dipendente:',
        empNamePlaceholder: 'Es.: Marco, Maria, ...',
        empPhoneLabel: 'WhatsApp / Telefono (opzionale):',
        empPhonePlaceholder: 'Es.: 491701234567',
        addEmpBtn: 'Aggiungi dipendente',
        manageEmployeesInfo: 'Elenco dipendenti e ore vengono salvati solo in locale sul tablet (localStorage). Nessun dato viene inviato a server esterni.',
        deleteEmpConfirm: 'Vuoi davvero cancellare questo dipendente?',

        planTitle: 'Pianificazione turni & WhatsApp',
        planEmpSelectLabel: 'Seleziona dipendente:',
        planDateLabel: 'Giorno:',
        planFromLabel: 'Da (ora):',
        planToLabel: 'A (ora):',
        previewMsgBtn: 'Mostra messaggio',
        openWhatsappBtn: 'Apri WhatsApp',
        whatsappInfo: 'WhatsApp si apre con un messaggio precompilato. Decidi tu se inviarlo.',
        previewTitle: 'Anteprima messaggio:',
        selectEmployeeOption: '-- Seleziona dipendente --',

        monthlyReportTitle: 'Report mensile (panoramica)',
        monthlyReportInfo: 'Panoramica di tutti i dipendenti nel mese corrente ‚Äì ore totali e banca ore.',
        printReportBtn: 'Stampa / salva in PDF',

        monthly_export_title: 'Export mensile (Word)',
        monthly_export_desc: 'Export per dipendente e mese ‚Äì ideale per il commercialista. Il file Word (.docx) contiene una tabella tipo foglio ore.',
        monthly_export_employee: 'Seleziona dipendente:',
        monthly_export_month: 'Seleziona mese:',
        monthly_export_btn: 'Crea Word',

        legalTitle: 'Privacy & condizioni d‚Äôuso',
        legalIntro: 'Breve riassunto dei punti principali. Puoi mostrare i dettagli al tuo commercialista / consulente.',
        legalCard1Title: '1. Dati',
        legalCard1Text: 'Tutti i dati vengono salvati solo in locale sul tablet. Nessun dato viene inviato a server esterni.',
        legalCard2Title: '2. Uso & copyright',
        legalCard2Text: 'L‚Äôapplicazione √® solo per l‚Äôesercizio autorizzato. √à vietato copiare, rivendere o condividere senza autorizzazione scritta dello sviluppatore.',
        legalCard3Title: '3. Responsabilit√†',
        legalCard3Text: 'L‚Äôapp aiuta a registrare le ore. Il calcolo delle paghe e il rispetto delle norme di lavoro restano responsabilit√† del datore di lavoro.',

        clockTitle: 'Timbro orario (dipendenti)',
        clockEmpSelectLabel: 'Seleziona dipendente:',
        clockReady: 'Pronto per timbrare.',
        clockInBtn: 'Entrata',
        clockOutBtn: 'Uscita',
        clockUndoBtn: 'Annulla ultima timbratura',
        todayEntriesTitle: 'Registrazioni di oggi:',
        clockRule: 'Regola: massimo 40 ore al mese. Il resto va nella banca ore.',
        clockAlreadyIn: 'Questo dipendente risulta gi√† in servizio.',
        clockNotIn: 'Questo dipendente non ha ancora timbrato l‚Äôentrata.',
        clockSelectEmp: 'Seleziona prima un dipendente.',
        clockUndoNoEntries: 'Nessuna registrazione da cancellare.',

        msgMissingFields: 'Seleziona dipendente, giorno e orari.',
        msgMissingEmp: 'Seleziona un dipendente.',
        msgNoPhone: 'Per questo dipendente non √® salvato alcun numero di telefono.',

        footerText: 'Portale locale dipendenti per la registrazione delle ore.'
      }
    };

    let currentLang = 'de';
    let currentTexts = translations[currentLang];

    function applyTranslations() {
      currentTexts = translations[currentLang];

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (currentTexts[key]) el.innerHTML = currentTexts[key];
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (currentTexts[key]) el.setAttribute('placeholder', currentTexts[key]);
      });

      const ft = document.querySelector('[data-i18n="footerText"]');
      if (ft) ft.textContent = currentTexts.footerText;
    }

    /* CONFIG GER
AL */
    const CHEF_PIN = "4729";

    const chefPinInput = document.getElementById('chefPinInput');
    const btnChefLogin = document.getElementById('btnChefLogin');
    const btnChefLogout = document.getElementById('btnChefLogout');
    const chefLoginStatus = document.getElementById('chefLoginStatus');
    const chefArea = document.getElementById('chefArea');

    let employees = [];

    const empNameInput = document.getElementById('empName');
    const empPhoneInput = document.getElementById('empPhone');
    const btnAddEmp = document.getElementById('btnAddEmp');
    const employeeListDiv = document.getElementById('employeeList');

    const employeeSelect = document.getElementById('employeeSelect');
    const statusEl = document.getElementById('status');
    const hoursInfoEl = document.getElementById('hoursInfo');
    const logEl = document.getElementById('log');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');
    const btnUndo = document.getElementById('btnUndo');

    const planEmployeeSelect = document.getElementById('planEmployeeSelect');
    const planHoursInfoEl = document.getElementById('planHoursInfo');
    const dateInput = document.getElementById('date');
    const timeFromInput = document.getElementById('timeFrom');
    const timeToInput = document.getElementById('timeTo');
    const btnPreview = document.getElementById('btnPreview');
    const btnWhatsapp = document.getElementById('btnWhatsapp');
    const previewText = document.getElementById('previewText');

    const exportEmployeeSelect = document.getElementById('exportEmployeeSelect');
    const exportMonthSelect = document.getElementById('exportMonthSelect');
    const exportInfoEl = document.getElementById('exportInfo');

    const MAX_HOURS_PER_MONTH = 40;

    function loadEmployees() {
      const data = localStorage.getItem('sanremoEmployees_v2');
      employees = data ? JSON.parse(data) : [];
    }
    function saveEmployees() {
      localStorage.setItem('sanremoEmployees_v2', JSON.stringify(employees));
    }
    function generateId() {
      return 'emp_' + Math.random().toString(36).substring(2, 9);
    }
    function maskPhone(phone) {
      if (!phone) return '';
      const last = phone.slice(-4);
      return '***' + last;
    }

    function getCurrentMonthKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    function getMonthKeyFromDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    function formatGermanDate(dateObj) {
      return dateObj.toLocaleDateString("de-DE", {
        weekday: "short", day: "2-digit", month: "2-digit", year: "numeric"
      });
    }
    function formatTimeHHMM(d) {
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }

    function getMonthEntries(emp, monthKey) {
      const entries = emp.entries || [];
      return entries.filter(entry => {
        const d = new Date(entry.start);
        return getMonthKeyFromDate(d) === monthKey;
      });
    }
    function getMonthTotals(emp, monthKey) {
      const entries = getMonthEntries(emp, monthKey);
      let total = 0;
      entries.forEach(e => total += e.hours);
      const bank = Math.max(0, total - MAX_HOURS_PER_MONTH);
      return { total, bank, entries };
    }
    function getCurrentMonthTotals(emp) {
      return getMonthTotals(emp, getCurrentMonthKey());
    }

    function updateHoursInfo() {
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        hoursInfoEl.innerHTML = 'Stunden diesen Monat: 0 | √úberstundenkonto: 0';
        return;
      }
      const { total, bank } = getCurrentMonthTotals(emp);
      let text = `Stunden diesen Monat: ${total.toFixed(2)} | √úberstundenkonto: ${bank.toFixed(2)}`;
      if (total > MAX_HOURS_PER_MONTH) {
        text += ` ‚Äì <span class="warning">Limit 40h √ºberschritten!</span>`;
      }
      hoursInfoEl.innerHTML = text;
    }

    function updatePlanHoursInfo() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        planHoursInfoEl.innerHTML = 'Stunden diesen Monat: 0 | √úberstundenkonto: 0';
        return;
      }
      const { total, bank } = getCurrentMonthTotals(emp);
      let text = `Stunden diesen Monat: ${total.toFixed(2)} | √úberstundenkonto: ${bank.toFixed(2)}`;
      if (total > MAX_HOURS_PER_MONTH) {
        text += ` ‚Äì <span class="warning">Limit 40h √ºberschritten!</span>`;
      }
      planHoursInfoEl.innerHTML = text;
    }

    function renderTodayLog() {
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const today = new Date();
      const todayKey = today.toISOString().slice(0,10);

      let html = `<b>${currentTexts.todayEntriesTitle}</b><br>`;
      if (!emp || !(emp.entries && emp.entries.length)) {
        logEl.innerHTML = html;
        return;
      }
      emp.entries.forEach(entry => {
        const start = new Date(entry.start);
        const end = new Date(entry.end);
        const key = entry.start.slice(0,10);
        if (key === todayKey) {
          const dateStr = formatGermanDate(start);
          html += `${dateStr}: ${formatTimeHHMM(start)} ‚Äì ${formatTimeHHMM(end)} (${entry.hours.toFixed(2)} h)<br>`;
        }
      });
      logEl.innerHTML = html;
    }

    function refreshEmployeeUI() {
      employeeSelect.innerHTML = `<option value="">${currentTexts.selectEmployeeOption}</option>`;
      planEmployeeSelect.innerHTML = `<option value="">${currentTexts.selectEmployeeOption}</option>`;
      if (exportEmployeeSelect) {
        exportEmployeeSelect.innerHTML = `<option value="">${currentTexts.selectEmployeeOption}</option>`;
      }

      employees.forEach(emp => {
        const opt1 = document.createElement('option');
        opt1.value = emp.id; opt1.textContent = emp.name;
        employeeSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = emp.id; opt2.textContent = emp.name;
        planEmployeeSelect.appendChild(opt2);

        if (exportEmployeeSelect) {
          const opt3 = document.createElement('option');
          opt3.value = emp.id; opt3.textContent = emp.name;
          exportEmployeeSelect.appendChild(opt3);
        }
      });

      employeeListDiv.innerHTML = '';
      employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        const span = document.createElement('span');
        span.textContent = emp.name + (emp.phone ? ' (' + maskPhone(emp.phone) + ')' : '');
        row.appendChild(span);

        const btnDel = document.createElement('button');
        btnDel.textContent = 'L√∂schen';
        btnDel.className = 'btn-danger';
        btnDel.onclick = () => {
          if (confirm(currentTexts.deleteEmpConfirm)) {
            employees = employees.filter(e => e.id !== emp.id);
            saveEmployees();
            refreshEmployeeUI();
            updateHoursInfo();
            updatePlanHoursInfo();
            renderMonthlyReport();
            renderTodayLog();
          }
        };
        row.appendChild(btnDel);
        employeeListDiv.appendChild(row);
      });

      const disabled = employees.length === 0;
      btnIn.disabled = disabled;
      btnOut.disabled = disabled;
      btnUndo.disabled = disabled;
      if (disabled) {
        statusEl.textContent = 'Keine Mitarbeiter angelegt. Chef muss zuerst Mitarbeiter hinzuf√ºgen.';
      } else {
        statusEl.textContent = currentTexts.clockReady;
      }
    }

    function renderMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      if (!employees || employees.length === 0) {
        container.innerHTML = '<em>Keine Mitarbeiter angelegt.</em>';
        return;
      }

      const monthKey = getCurrentMonthKey();
      let html = '<table style="width:100%; border-collapse: collapse; font-size:14px;">';
      html += '<thead><tr>' +
              '<th style="border-bottom:1px solid #ccc; text-align:left; padding:4px;">Mitarbeiter</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">Stunden im Monat</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">√úberstundenkonto</th>' +
              '</tr></thead><tbody>';

      let totalHoursAll = 0;
      let totalBankAll = 0;

      employees.forEach(emp => {
        const { total, bank } = getMonthTotals(emp, monthKey);
        totalHoursAll += total;
        totalBankAll += bank;

        html += '<tr>' +
          '<td style="border-bottom:1px solid #eee; padding:4px;">' + emp.name + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + total.toFixed(2) + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + bank.toFixed(2) + '</td>' +
          '</tr>';
      });

      html += '<tr>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">Summe:</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalHoursAll.toFixed(2) + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalBankAll.toFixed(2) + '</td>' +
        '</tr>';

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function printMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      const win = window.open('', '_blank');
      win.document.write('<html><head><title>Monatsbericht</title>');
      win.document.write('<meta charset="UTF-8">');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse;font-size:14px;} th,td{border:1px solid #ccc;padding:4px;} th{text-align:left;background:#f0f0f0;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h2>Monatsbericht</h2>');
      win.document.write('<p>Monat: ' + getCurrentMonthKey() + '</p>');
      win.document.write(container.innerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }

    function buildMessage() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const dateVal = dateInput.value;
      const tFrom = timeFromInput.value;
      const tTo = timeToInput.value;

      if (!emp || !dateVal || !tFrom || !tTo) return "";

      const dateObj = new Date(dateVal + "T00:00:00");
      const { total, bank } = getCurrentMonthTotals(emp);
      let hoursLine = `Aktueller Monat: ${total.toFixed(2)} Std. (√úberstundenkonto: ${bank.toFixed(2)} Std.)`;
      if (total > MAX_HOURS_PER_MONTH) {
        hoursLine += " ‚Äì LIMIT 40h √ºberschritten!";
      }

      const dateDE = formatGermanDate(dateObj);

      const msg =
        "Dienstplan\n\n" +
        "Hallo " + emp.name + ",\n\n" +
        "dein Dienst:\n" +
        "üìÖ Datum: " + dateDE + "\n" +
        "‚è∞ Zeit: " + tFrom + " ‚Äì " + tTo + " Uhr\n" +
        "üìç Ort: Betrieb\n\n" +
        hoursLine + "\n\n" +
        "Bitte best√§tige mit OK.";
      return msg;
    }

    function fillExportMonthSelect() {
      const sel = exportMonthSelect;
      if (!sel) return;

      sel.innerHTML = '';

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      for (let m = 1; m <= 12; m++) {
        const date = new Date(currentYear, m - 1, 1);
        const label = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
        const opt = document.createElement('option');
        opt.value = `${currentYear}-${String(m).padStart(2, '0')}`;
        opt.textContent = label;
        if (m === currentMonth) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    function exportMonthlyWord() {
      if (!exportEmployeeSelect || !exportMonthSelect) return;

      const empId = exportEmployeeSelect.value;
      const monthValue = exportMonthSelect.value;

      if (!empId) {
        alert(currentTexts.msgMissingEmp);
        return;
      }
      if (!monthValue) {
        alert('Bitte Monat ausw√§hlen.');
        return;
      }

      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        alert('Mitarbeiter nicht gefunden.');
        return;
      }

      const [yearStr, monthStr] = monthValue.split('-');
      const year = parseInt(yearStr, 10);
      const month = parseInt(monthStr, 10);
      const daysInMonth = new Date(year, month, 0).getDate();

      const docxLib = window.docx;
      const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun, WidthType, HeadingLevel } = docxLib;

      const headerRow = new TableRow({
        children: [
          new TableCell({ children: [new Paragraph('Tag')] }),
          new TableCell({ children: [new Paragraph('Arbeitsbeginn')] }),
          new TableCell({ children: [new Paragraph('Arbeitsende')] }),
          new TableCell({ children: [new Paragraph('Pausenbeginn')] }),
          new TableCell({ children: [new Paragraph('Pausenende')] }),
          new TableCell({ children: [new Paragraph('Arbeitszeit (Std)')] }),
          new TableCell({ children: [new Paragraph('Entlohnungsart')] })
        ]
      });

      const rows = [headerRow];

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dateStr = date.toLocaleDateString('de-DE', {
          day: '2-digit', month: '2-digit', year: 'numeric'
        });

        rows.push(new TableRow({
          children: [
            new TableCell({ children: [new Paragraph(dateStr)] }),
            new TableCell({ children: [new Paragraph('')] }),
            new TableCell({ children: [new Paragraph('')] }),
            new TableCell({ children: [new Paragraph('')] }),
            new TableCell({ children: [new Paragraph('')] }),
            new TableCell({ children: [new Paragraph('')] }),
            new TableCell({ children: [new Paragraph('')] })
          ]
        }));
      }

      rows.push(
        new TableRow({
          children: [
            new TableCell({
              children: [
                new Paragraph({
                  children: [new TextRun({ text: 'Summe Arbeitsstunden:', bold: true })]
                })
              ],
              columnSpan: 5
            }),
            new TableCell({
              children: [
                new Paragraph({
                  children: [new TextRun({ text: '0,00', bold: true })]
                })
              ]
            }),
            new TableCell({ children: [new Paragraph('')] })
          ]
        })
      );

      const table = new Table({
        rows,
        width: { size: 100, type: WidthType.PERCENTAGE }
      });

      const monthLabel = new Date(year, month - 1, 1).toLocaleDateString('de-DE', {
        month: 'long', year: 'numeric'
      });

      const doc = new Document({
        sections: [
          {
            properties: {},
            children: [
              new Paragraph({ text: 'Arbeitszeitnachweis', heading: HeadingLevel.HEADING_1 }),
              new Paragraph(''),
              new Paragraph(`Mitarbeiter: ${emp.name}`),
              new Paragraph(`Monat: ${monthLabel}`),
              new Paragraph(''),
              table
            ]
          }
        ]
      });

      Packer.toBlob(doc).then(blob => {
        const fileName = `stunden_${emp.name}_${year}-${String(month).padStart(2, '0')}.docx`;
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);

        if (exportInfoEl) exportInfoEl.textContent = `Export erstellt: ${fileName}`;
      }).catch(err => {
        console.error(err);
        alert('Fehler beim Erstellen des Word-Dokuments.');
      });
    }

    /* EVENTOS */

    btnChefLogin.addEventListener('click', () => {
      const pin = chefPinInput.value.trim();
      if (pin === CHEF_PIN) {
        chefArea.style.display = 'block';
        chefLoginStatus.style.color = 'green';
        chefLoginStatus.textContent = currentTexts.chefLoginOk;
        chefPinInput.value = '';
        btnChefLogout.disabled = false;
      } else {
        chefLoginStatus.style.color = 'red';
        chefLoginStatus.textContent = currentTexts.chefLoginFail;
      }
    });

    btnChefLogout.addEventListener('click', () => {
      chefArea.style.display = 'none';
      chefLoginStatus.style.color = '#333';
      chefLoginStatus.textContent = currentTexts.chefLogoutMsg;
      btnChefLogout.disabled = true;
    });

    btnAddEmp.addEventListener('click', () => {
      const name = empNameInput.value.trim();
      const phone = empPhoneInput.value.trim();
      if (!name) {
        alert('Bitte einen Namen eingeben.');
        return;
      }
      const emp = {
        id: generateId(),
        name,
        phone: phone || '',
        activeSessionStart: null,
        entries: []
      };
      employees.push(emp);
      saveEmployees();
      empNameInput.value = '';
      empPhoneInput.value = '';
      refreshEmployeeUI();
      renderMonthlyReport();
    });

    employeeSelect.addEventListener('change', () => {
      updateHoursInfo();
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (emp && emp.activeSessionStart) {
        statusEl.textContent = 'Mitarbeiter ist aktuell eingestempelt (seit ' +
          new Date(emp.activeSessionStart).toLocaleString() + ').';
      } else {
        statusEl.textContent = currentTexts.clockReady;
      }
      renderTodayLog();
    });

    planEmployeeSelect.addEventListener('change', () => {
      updatePlanHoursInfo();
    });

    btnIn.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(currentTexts.clockSelectEmp);
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (emp.activeSessionStart) {
        alert(currentTexts.clockAlreadyIn);
        return;
      }

      emp.activeSessionStart = new Date().toISOString();
      saveEmployees();
      statusEl.textContent = 'Eingestempelt um ' +
        new Date(emp.activeSessionStart).toLocaleString() + '.';
      renderTodayLog();
    });

    btnOut.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(currentTexts.clockSelectEmp);
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (!emp.activeSessionStart) {
        alert(currentTexts.clockNotIn);
        return;
      }

      const start = new Date(emp.activeSessionStart);
      const end = new Date();
      const diffMs = end - start;
      const hours = diffMs / 1000 / 60 / 60;

      if (!emp.entries) emp.entries = [];
      emp.entries.push({
        start: start.toISOString(),
        end: end.toISOString(),
        hours
      });

      emp.activeSessionStart = null;
      saveEmployees();

      const monthTotals = getCurrentMonthTotals(emp);

      statusEl.textContent =
        `Ausgestempelt. Gearbeitete Zeit: ${hours.toFixed(2)} Std. ` +
        `Gesamt in diesem Monat: ${monthTotals.total.toFixed(2)} Std.`;

      updateHoursInfo();
      updatePlanHoursInfo();
      renderTodayLog();
      renderMonthlyReport();
    });

    btnUndo.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(currentTexts.clockSelectEmp);
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (emp.activeSessionStart) {
        alert('Mitarbeiter ist aktuell eingestempelt. Zuerst ausstempeln.');
        return;
      }

      if (!emp.entries || emp.entries.length === 0) {
        alert(currentTexts.clockUndoNoEntries);
        return;
      }

      const last = emp.entries[emp.entries.length - 1];
      const start = new Date(last.start);
      const end = new Date(last.end);

      if (!confirm(
        `Letzten Eintrag l√∂schen?\n` +
        `${formatGermanDate(start)} ${formatTimeHHMM(start)} ‚Äì ${formatTimeHHMM(end)}\n` +
        `(${last.hours.toFixed(2)} Std.)`
      )) {
        return;
      }

      emp.entries.pop();
      saveEmployees();
      updateHoursInfo();
      updatePlanHoursInfo();
      renderTodayLog();
      renderMonthlyReport();
    });

    btnPreview.addEventListener('click', () => {
      const msg = buildMessage();
      if (!msg) {
        alert(currentTexts.msgMissingFields);
        return;
      }
      previewText.textContent = msg;
    });

    btnWhatsapp.addEventListener('click', () => {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const msg = buildMessage();

      if (!emp) {
        alert(currentTexts.msgMissingEmp);
        return;
      }
      if (!msg) {
        alert(currentTexts.msgMissingFields);
        return;
      }
      if (!emp.phone) {
        alert(currentTexts.msgNoPhone);
        return;
      }

      const phone = emp.phone;
      const encodedMsg = encodeURIComponent(msg);
      const url = "https://wa.me/" + phone + "?text=" + encodedMsg;
      window.open(url, "_blank");
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('year').textContent = new Date().getFullYear();

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const lang = btn.getAttribute('data-lang');
          currentLang = lang;
          document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          applyTranslations();
          updateHoursInfo();
          updatePlanHoursInfo();
          renderTodayLog();
        });
      });

      applyTranslations();
      loadEmployees();
      refreshEmployeeUI();
      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
      renderTodayLog();
      fillExportMonthSelect();
    });
  </script>
</body>
</html>
