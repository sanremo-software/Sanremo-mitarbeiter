
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WorkTime ‚Äì Stempel System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f0f2f5">

  <style>
    html, body {
      height: 100%;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 1000px;
      margin: 0 auto;
      background: #f0f2f5;
      min-height: 100vh;
    }

    h2, h3 {
      margin-top: 0;
    }

    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }

    input, select, button {
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    select, input {
      width: 100%;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-danger {
      background: #d32f2f;
      color: #fff;
    }

    .section {
      border: 1px solid #ccc;
      padding: 14px;
      margin-top: 15px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    #status, #hoursInfo, #planHoursInfo {
      font-size: 14px;
      margin-top: 6px;
    }

    #log {
      margin-top: 10px;
      max-height: 220px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
    }

    .employee-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      gap: 8px;
    }
    .employee-row button {
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .warning {
      color: #d32f2f;
      font-weight: bold;
    }
    .box {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: #fafafa;
      margin-top: 10px;
    }
    #chefLoginStatus {
      font-size: 13px;
      margin-top: 6px;
    }
    small {
      font-size: 12px;
      color: #555;
    }

    @media (min-width: 800px) {
      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 16px;
      }
    }

    /* TOPO: LOGO HORIZONTAL + BANDEIRAS */
    .top-header-wrapper {
      margin-bottom: 18px;
    }
    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 16px;
      border-radius: 18px;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      gap: 12px; /* espa√ßo entre logo e bandeiras */
    }
    /* caixa do logo ocupa todo o espa√ßo dispon√≠vel √† esquerda */
    .logo-box {
      flex: 1;
      display: flex;
      align-items: center;
    }
    /* logo usa a largura quase total da caixa */
    .logo-img {
      width: 100%;
      max-width: 600px;
      height: auto;
      display: block;
    }

    .lang-switch {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0; /* n√£o deixa as bandeiras encolherem */
    }
    .lang-flag {
      width: 32px;
      height: 22px;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      opacity: 0.7;
      transition: transform 0.1s ease, opacity 0.1s ease, box-shadow 0.1s ease;
    }
    .lang-flag:hover {
      transform: translateY(-1px);
      opacity: 0.9;
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }
    .lang-flag.active {
      outline: 2px solid #1976d2;
      opacity: 1;
    }

    /* cart√£o login com cores da bandeira italiana */
    .chef-login-card {
      border-radius: 12px;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
      padding: 14px;
      margin-top: 10px;
    }
    .chef-login-card::before {
      content: "";
      position: absolute;
      inset: -2px;
      z-index: -1;
      border-radius: inherit;
      background: linear-gradient(90deg, #008C45, #F4F5F0, #CD212A);
    }

    /* Datenschutz box */
    #datenschutzBox {
      display: none;
      margin-top: 20px;
    }
    .ds-block {
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 10px 12px;
      background: #fafafa;
      margin-top: 10px;
      font-size: 13px;
    }
    .ds-block h4 {
      margin: 0 0 6px 0;
    }

    footer {
      margin-top: 24px;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    footer a {
      color: #1976d2;
      text-decoration: none;
      margin: 0 4px;
    }

    @media (max-width: 600px) {
      .top-header {
        padding: 14px 12px;
      }
      .logo-img {
        max-width: 320px;
      }
      .lang-flag {
        width: 28px;
        height: 20px;
      }
    }
  </style>
</head>
<body>

  <!-- TOPO: LOGO + BANDEIRAS -->
  <div class="top-header-wrapper">
    <header class="top-header">
      <div class="logo-box">
        <!-- usa o nome exato do ficheiro que subiste para o GitHub -->
        <img src="IMG-20251127-WA0009.jpg"
             alt="WorkTime ‚Äì Stempel System"
             class="logo-img">
      </div>

      <div class="lang-switch">
        <img src="https://flagcdn.com/w40/de.png" alt="Deutsch" class="lang-flag" data-lang="de">
        <img src="https://flagcdn.com/w40/pt.png" alt="Portugu√™s" class="lang-flag" data-lang="pt">
        <img src="https://flagcdn.com/w40/it.png" alt="Italiano" class="lang-flag" data-lang="it">
      </div>
    </header>
  </div>

  <!-- LOGIN DO CHEFE -->
  <div class="section chef-login-card">
    <h3 data-i18n="chef_login_title">Chef Login</h3>
    <label for="chefPinInput" data-i18n="chef_pin_label">PIN eingeben:</label>
    <input type="password" id="chefPinInput" placeholder="PIN" data-i18n-placeholder="chef_pin_placeholder">

    <div style="display:flex; gap:10px; margin-top:8px;">
      <button id="btnChefLogin" class="btn-primary" style="flex:1;" data-i18n="btn_login">
        Login
      </button>
      <button id="btnChefLogout" class="btn-secondary" style="flex:1;" data-i18n="btn_logout">
        Logout
      </button>
    </div>

    <p id="chefLoginStatus"></p>
    <small data-i18n="chef_login_hint">
      Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten,
      Dienstplan / WhatsApp, Monatsbericht &amp; Export, Datenschutz) freigeschaltet.
    </small>
  </div>

  <div class="grid">
    <!-- √ÅREA DO CHEFE (escondida at√© login) -->
    <div id="chefArea" style="display:none;">

      <!-- Gest√£o de empregados -->
      <div class="section">
        <h3 data-i18n="manage_employees_title">Mitarbeiter verwalten</h3>

        <label for="empName" data-i18n="emp_name_label">Name des Mitarbeiters:</label>
        <input type="text" id="empName" placeholder="z.B. Jo√£o, Maria, ..." data-i18n-placeholder="emp_name_placeholder">

        <label for="empPhone" data-i18n="emp_phone_label">WhatsApp / Telefonnummer (optional):</label>
        <input type="text" id="empPhone" placeholder="z.B. 491701234567" data-i18n-placeholder="emp_phone_placeholder">

        <button id="btnAddEmp" class="btn-primary" style="width:100%; margin-top:10px;" data-i18n="btn_add_employee">
          Mitarbeiter hinzuf√ºgen
        </button>

        <div id="employeeList" style="margin-top:12px;">
          <!-- lista de empregados -->
        </div>

        <small data-i18n="emp_storage_hint">
          Mitarbeiterliste, Stunden, √úberstunden und Historie werden im Browser (localStorage) gespeichert.
        </small>
      </div>

      <!-- Plano + WhatsApp -->
      <div class="section">
        <h3 data-i18n="schedule_title">Dienstplan &amp; WhatsApp</h3>

        <label for="planEmployeeSelect" data-i18n="plan_emp_label">Mitarbeiter ausw√§hlen:</label>
        <select id="planEmployeeSelect">
          <option value="" data-i18n="option_choose_employee">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="planHoursInfo">
          Stunden diesen Monat: 0 | √úberstundenkonto: 0
        </div>

        <label for="date" data-i18n="plan_day_label">Tag:</label>
        <input type="date" id="date">

        <label for="timeFrom" data-i18n="plan_from_label">Von (Uhrzeit):</label>
        <input type="time" id="timeFrom">

        <label for="timeTo" data-i18n="plan_to_label">Bis (Uhrzeit):</label>
        <input type="time" id="timeTo">

        <div class="box">
          <button id="btnPreview" class="btn-secondary" style="width:100%; margin-bottom:6px;" data-i18n="btn_show_message">
            Nachricht anzeigen
          </button>
          <button id="btnWhatsapp" class="btn-primary" style="width:100%;" data-i18n="btn_open_whatsapp">
            WhatsApp √∂ffnen
          </button>
          <p style="font-size:12px; margin-top:6px;" data-i18n="whatsapp_hint">
            WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.
          </p>
        </div>

        <div class="box">
          <b data-i18n="preview_title">Vorschau Nachricht:</b>
          <p id="previewText" style="white-space: pre-wrap; margin-top: 8px;">
            (Noch keine Nachricht)
          </p>
        </div>
      </div>

      <!-- MONATSBERICHT (CHEF) -->
      <div class="section">
        <h3 data-i18n="monthly_report_title">Monatsbericht (Chef)</h3>
        <p style="font-size: 13px; margin-bottom:8px;" data-i18n="monthly_report_hint">
          √úbersicht aller Mitarbeiter f√ºr den aktuellen Monat.
        </p>

        <div id="monthlyReportContainer">
          <!-- tabela gerada por JavaScript -->
        </div>

        <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="printMonthlyReport()" data-i18n="btn_print_report">
          Drucken / als PDF speichern
        </button>
      </div>

      <!-- MONATS-EXPORT COM HIST√ìRICO DETALHADO -->
      <div class="section" id="exportSection">
        <h3 data-i18n="export_title">Monats-Export (Word / Drucker)</h3>
        <p style="font-size:13px; margin-bottom:10px;" data-i18n="export_hint">
          Export pro Mitarbeiter und Monat ‚Äì ideal f√ºr den Steuerberater.
          Es wird ein Monatsblatt mit allen Tagen, Arbeitsbeginn und Arbeitsende erstellt,
          das du drucken oder als PDF speichern kannst.
        </p>

        <label for="exportEmployeeSelect"><b data-i18n="export_emp_label">Mitarbeiter ausw√§hlen:</b></label>
        <select id="exportEmployeeSelect">
          <option value="" data-i18n="option_choose_employee">-- Mitarbeiter w√§hlen --</option>
        </select>

        <label for="exportMonthSelect" style="margin-top:10px;"><b data-i18n="export_month_label">Monat ausw√§hlen:</b></label>
        <select id="exportMonthSelect"></select>

        <button id="btnExportWord" class="btn-primary" style="width:100%; margin-top:14px;" data-i18n="btn_export_word">
          Word / Drucker ‚Äì Monatsblatt erstellen
        </button>

        <small id="exportInfo" style="display:block; margin-top:8px; font-size:12px; color:#555;" data-i18n="export_info">
          Hinweis: Es wird ein neues Fenster mit einer Tabelle ge√∂ffnet.
          Von dort kannst du direkt drucken oder als PDF speichern.
        </small>
      </div>

      <!-- DATENSCHUTZ & NUTZUNG ‚Äì s√≥ para o chefe -->
      <div class="section" id="datenschutzBox">
        <h3 data-i18n="privacy_title">Datenschutz &amp; Nutzungshinweise</h3>

        <div class="ds-block">
          <h4 data-i18n="privacy_block1_title">1. Datenschutz</h4>
          <p data-i18n="privacy_block1_text">
            Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs.
            Es werden keine Daten auf externen Servern gespeichert. Zugriff auf die
            gespeicherten Daten haben nur der Betrieb/Chef und die von ihm
            autorisierten Personen. Der Arbeitgeber ist daf√ºr verantwortlich,
            seine Mitarbeiter √ºber die Datenerfassung zu informieren.
          </p>
        </div>

        <div class="ds-block">
          <h4 data-i18n="privacy_block2_title">2. Nutzung &amp; Urheberrecht</h4>
          <p data-i18n="privacy_block2_text">
            Diese Anwendung ist nur f√ºr den lizenzierten Betrieb bestimmt. Eine
            Weitergabe, Vervielf√§ltigung, der Verkauf oder das Kopieren des
            Quellcodes und Designs an Dritte ohne ausdr√ºckliche schriftliche
            Zustimmung des Entwicklers ist untersagt.
          </p>
        </div>

        <div class="ds-block">
          <h4 data-i18n="privacy_block3_title">3. Haftungsausschluss</h4>
          <p data-i18n="privacy_block3_text">
            Die Anwendung unterst√ºtzt bei der Erfassung von Arbeitszeiten. Die
            rechtlich korrekte Lohnabrechnung und Einhaltung arbeitsrechtlicher
            Vorschriften bleiben in der Verantwortung des Arbeitgebers.
          </p>
        </div>
      </div>

    </div>

    <!-- SEC√á√ÉO: Stempeluhr ‚Äì para os empregados (sempre vis√≠vel) -->
    <div>
      <div class="section">
        <h3 data-i18n="clock_title">Stempeluhr (f√ºr Mitarbeiter)</h3>

        <label for="employeeSelect" data-i18n="clock_emp_label">Mitarbeiter ausw√§hlen:</label>
        <select id="employeeSelect">
          <option value="" data-i18n="option_choose_employee">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="hoursInfo">
          Stunden diesen Monat: 0 | √úberstundenkonto: 0
        </div>

        <div id="status" data-i18n="status_ready">Bereit zum Stempeln.</div>

        <button id="btnIn" class="btn-primary" style="width:100%; margin-top:10px;" data-i18n="btn_clock_in">
          Einstempeln
        </button>
        <button id="btnOut" class="btn-secondary" style="width:100%; margin-top:8px;" data-i18n="btn_clock_out">
          Ausstempeln
        </button>
        <button id="btnUndo" class="btn-danger" style="width:100%; margin-top:8px;" data-i18n="btn_undo_last">
          Letzten Eintrag l√∂schen
        </button>

        <div id="log"><b data-i18n="today_entries_title">Heutige Eintr√§ge:</b><br></div>

        <small data-i18n="rule_text">
          Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).
        </small>
      </div>
    </div>
  </div>

  <footer>
    <a href="#" id="linkImpressum" data-i18n="footer_impressum">Impressum</a> |
    <a href="#" id="linkDatenschutz" data-i18n="footer_privacy">Datenschutz</a>
  </footer>

  <script>
    // ================== TRADU√á√ïES ==================
    const translations = {
      de: {
        chef_login_title: "Chef Login",
        chef_pin_label: "PIN eingeben:",
        chef_pin_placeholder: "PIN",
        btn_login: "Login",
        btn_logout: "Logout",
        chef_login_hint: "Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp, Monatsbericht & Export, Datenschutz) freigeschaltet.",
        manage_employees_title: "Mitarbeiter verwalten",
        emp_name_label: "Name des Mitarbeiters:",
        emp_name_placeholder: "z.B. Jo√£o, Maria, ...",
        emp_phone_label: "WhatsApp / Telefonnummer (optional):",
        emp_phone_placeholder: "z.B. 491701234567",
        btn_add_employee: "Mitarbeiter hinzuf√ºgen",
        emp_storage_hint: "Mitarbeiterliste, Stunden, √úberstunden und Historie werden im Browser (localStorage) gespeichert.",
        schedule_title: "Dienstplan & WhatsApp",
        plan_emp_label: "Mitarbeiter ausw√§hlen:",
        option_choose_employee: "-- Mitarbeiter w√§hlen --",
        plan_day_label: "Tag:",
        plan_from_label: "Von (Uhrzeit):",
        plan_to_label: "Bis (Uhrzeit):",
        btn_show_message: "Nachricht anzeigen",
        btn_open_whatsapp: "WhatsApp √∂ffnen",
        whatsapp_hint: "WhatsApp wird mit vorbereiteter Nachricht ge√∂ffnet. Du entscheidest, ob du sendest.",
        preview_title: "Vorschau Nachricht:",
        monthly_report_title: "Monatsbericht (Chef)",
        monthly_report_hint: "√úbersicht aller Mitarbeiter f√ºr den aktuellen Monat.",
        btn_print_report: "Drucken / als PDF speichern",
        export_title: "Monats-Export (Word / Drucker)",
        export_hint: "Export pro Mitarbeiter und Monat ‚Äì ideal f√ºr den Steuerberater. Es wird ein Monatsblatt mit allen Tagen, Arbeitsbeginn und Arbeitsende erstellt, das du drucken oder als PDF speichern kannst.",
        export_emp_label: "Mitarbeiter ausw√§hlen:",
        export_month_label: "Monat ausw√§hlen:",
        btn_export_word: "Word / Drucker ‚Äì Monatsblatt erstellen",
        export_info: "Hinweis: Es wird ein neues Fenster mit einer Tabelle ge√∂ffnet. Von dort kannst du direkt drucken oder als PDF speichern.",
        privacy_title: "Datenschutz & Nutzungshinweise",
        privacy_block1_title: "1. Datenschutz",
        privacy_block1_text: "Dieses System speichert Daten nur lokal im Browser/Tablet des Betriebs. Es werden keine Daten auf externen Servern gespeichert. Zugriff auf die gespeicherten Daten haben nur der Betrieb/Chef und die von ihm autorisierten Personen. Der Arbeitgeber ist daf√ºr verantwortlich, seine Mitarbeiter √ºber die Datenerfassung zu informieren.",
        privacy_block2_title: "2. Nutzung & Urheberrecht",
        privacy_block2_text: "Diese Anwendung ist nur f√ºr den lizenzierten Betrieb bestimmt. Eine Weitergabe, Vervielf√§ltigung, der Verkauf oder das Kopieren des Quellcodes und Designs an Dritte ohne ausdr√ºckliche schriftliche Zustimmung des Entwicklers ist untersagt.",
        privacy_block3_title: "3. Haftungsausschluss",
        privacy_block3_text: "Die Anwendung unterst√ºtzt bei der Erfassung von Arbeitszeiten. Die rechtlich korrekte Lohnabrechnung und Einhaltung arbeitsrechtlicher Vorschriften bleiben in der Verantwortung des Arbeitgebers.",
        clock_title: "Stempeluhr (f√ºr Mitarbeiter)",
        clock_emp_label: "Mitarbeiter ausw√§hlen:",
        status_ready: "Bereit zum Stempeln.",
        btn_clock_in: "Einstempeln",
        btn_clock_out: "Ausstempeln",
        btn_undo_last: "Letzten Eintrag l√∂schen",
        today_entries_title: "Heutige Eintr√§ge:",
        rule_text: "Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).",
        footer_impressum: "Impressum",
        footer_privacy: "Datenschutz",

        hours_info: "Stunden diesen Monat: {total} | √úberstundenkonto: {bank}",
        hours_limit: " ‚Äì Limit 40h √ºberschritten!",
        status_no_employees: "Keine Mitarbeiter angelegt. Chef muss zuerst Mitarbeiter hinzuf√ºgen.",
        alert_enter_name: "Bitte einen Namen eingeben.",
        alert_select_employee: "Bitte zuerst einen Mitarbeiter ausw√§hlen.",
        alert_already_clocked_in: "Dieser Mitarbeiter ist bereits eingestempelt.",
        alert_not_clocked_in: "Dieser Mitarbeiter ist noch nicht eingestempelt.",
        alert_no_entries_to_delete: "Keine Eintr√§ge zum L√∂schen vorhanden.",
        confirm_delete_employee: "Mitarbeiter \"{name}\" wirklich l√∂schen?",
        confirm_delete_last: "Letzten Eintrag f√ºr \"{name}\" wirklich l√∂schen?",
        log_in: "{name} eingestempelt",
        log_out: "{name} ausgestempelt ({hours} Std.)",
        log_deleted: "{name} ‚Äì letzter Eintrag gel√∂scht",
        chef_logged_out: "Abgemeldet.",
        chef_login_ok: "Login erfolgreich. Chef-Bereiche sind freigeschaltet.",
        chef_pin_wrong: "Falscher PIN.",
        whatsapp_fill_all: "Bitte Mitarbeiter, Tag und Zeiten ausf√ºllen.",
        whatsapp_choose_emp: "Bitte Mitarbeiter w√§hlen.",
        whatsapp_fill_date_time: "Bitte Tag und Zeiten eintragen.",
        whatsapp_no_phone: "F√ºr diesen Mitarbeiter ist keine Telefonnummer hinterlegt.",
        export_choose_emp: "Bitte einen Mitarbeiter ausw√§hlen.",
        export_choose_month: "Bitte einen Monat ausw√§hlen.",
        impressum_alert: "Impressum: Hier kannst du deine Firmenadresse und Kontaktdaten erg√§nzen.",

        msg_prefix: "WorkTime ‚Äì Dienstplan",
        msg_hello: "Hallo {name},",
        msg_shift: "dein Dienst:",
        msg_date: "üìÖ Datum: {date}",
        msg_time: "‚è∞ Zeit: {from} ‚Äì {to} Uhr",
        msg_place: "üìç Ort: Eiscaf√© Sanremo, Bad Berleburg",
        msg_month_info: "Aktueller Monat: {total} Std. (√úberstundenkonto: {bank} Std.)",
        msg_limit_info: " ‚Äì LIMIT 40h √ºberschritten!",
        msg_confirm: "Bitte best√§tige mit OK."
      },

      pt: {
        chef_login_title: "Login do Chefe",
        chef_pin_label: "Introduzir PIN:",
        chef_pin_placeholder: "PIN",
        btn_login: "Entrar",
        btn_logout: "Sair",
        chef_login_hint: "Depois do login, as √°reas do chefe (gest√£o de empregados, plano / WhatsApp, relat√≥rio mensal & exporta√ß√£o, prote√ß√£o de dados) ficam desbloqueadas.",
        manage_employees_title: "Gerir empregados",
        emp_name_label: "Nome do empregado:",
        emp_name_placeholder: "Ex.: Jo√£o, Maria...",
        emp_phone_label: "WhatsApp / Telem√≥vel (opcional):",
        emp_phone_placeholder: "Ex.: 351912345678",
        btn_add_employee: "Adicionar empregado",
        emp_storage_hint: "Lista de empregados, horas, banco de horas e hist√≥rico s√£o guardados localmente no browser (localStorage).",
        schedule_title: "Plano de servi√ßo & WhatsApp",
        plan_emp_label: "Escolher empregado:",
        option_choose_employee: "-- Escolher empregado --",
        plan_day_label: "Dia:",
        plan_from_label: "De (hora):",
        plan_to_label: "At√© (hora):",
        btn_show_message: "Mostrar mensagem",
        btn_open_whatsapp: "Abrir WhatsApp",
        whatsapp_hint: "O WhatsApp abre com a mensagem pronta. Tu decides se queres enviar.",
        preview_title: "Pr√©-visualiza√ß√£o da mensagem:",
        monthly_report_title: "Relat√≥rio mensal (Chefe)",
        monthly_report_hint: "Resumo de todos os empregados no m√™s atual.",
        btn_print_report: "Imprimir / guardar em PDF",
        export_title: "Exporta√ß√£o mensal (Word / Impress√£o)",
        export_hint: "Exportar por empregado e m√™s ‚Äì ideal para o contabilista. √â criada uma folha mensal com todos os dias, hora de entrada e hora de sa√≠da.",
        export_emp_label: "Escolher empregado:",
        export_month_label: "Escolher m√™s:",
        btn_export_word: "Criar folha mensal (Word / Impress√£o)",
        export_info: "Abre uma nova janela com a tabela. A partir da√≠ podes imprimir ou guardar em PDF.",
        privacy_title: "Prote√ß√£o de dados & utiliza√ß√£o",
        privacy_block1_title: "1. Prote√ß√£o de dados",
        privacy_block1_text: "Este sistema guarda os dados apenas localmente no browser/tablet do estabelecimento. N√£o s√£o guardados dados em servidores externos. S√≥ o estabelecimento/chefe e pessoas autorizadas t√™m acesso. O empregador √© respons√°vel por informar os empregados sobre a recolha de dados.",
        privacy_block2_title: "2. Utiliza√ß√£o & direitos de autor",
        privacy_block2_text: "Esta aplica√ß√£o √© apenas para o estabelecimento licenciado. √â proibida a partilha, c√≥pia, venda ou reprodu√ß√£o do c√≥digo-fonte e design sem autoriza√ß√£o escrita do desenvolvedor.",
        privacy_block3_title: "3. Exclus√£o de responsabilidade",
        privacy_block3_text: "A aplica√ß√£o ajuda a registar horas de trabalho. O c√°lculo correto dos sal√°rios e o cumprimento da legisla√ß√£o laboral continuam a ser responsabilidade do empregador.",
        clock_title: "Rel√≥gio de ponto (para empregados)",
        clock_emp_label: "Escolher empregado:",
        status_ready: "Pronto para bater o ponto.",
        btn_clock_in: "Entrar",
        btn_clock_out: "Sair",
        btn_undo_last: "Apagar √∫ltimo registo",
        today_entries_title: "Registos de hoje:",
        rule_text: "Regra: M√°ximo 40 horas por m√™s. O que estiver acima vai para o banco de horas.",
        footer_impressum: "Impressum",
        footer_privacy: "Prote√ß√£o de dados",

        hours_info: "Horas neste m√™s: {total} | Banco de horas: {bank}",
        hours_limit: " ‚Äì Limite de 40h ultrapassado!",
        status_no_employees: "Nenhum empregado criado. O chefe tem de adicionar primeiro.",
        alert_enter_name: "Por favor introduz um nome.",
        alert_select_employee: "Primeiro escolhe um empregado.",
        alert_already_clocked_in: "Este empregado j√° est√° registado como presente.",
        alert_not_clocked_in: "Este empregado ainda n√£o est√° registado como presente.",
        alert_no_entries_to_delete: "N√£o h√° registos para apagar.",
        confirm_delete_employee: "Eliminar mesmo o empregado \"{name}\"?",
        confirm_delete_last: "Apagar mesmo o √∫ltimo registo de \"{name}\"?",
        log_in: "{name} entrou",
        log_out: "{name} saiu ({hours} h)",
        log_deleted: "√öltimo registo de {name} apagado",
        chef_logged_out: "Sess√£o terminada.",
        chef_login_ok: "Login com sucesso. √Åreas do chefe desbloqueadas.",
        chef_pin_wrong: "PIN errado.",
        whatsapp_fill_all: "Escolhe empregado, dia e horas.",
        whatsapp_choose_emp: "Escolhe um empregado.",
        whatsapp_fill_date_time: "Introduz dia e horas.",
        whatsapp_no_phone: "N√£o foi guardado n√∫mero de telefone para este empregado.",
        export_choose_emp: "Escolhe um empregado.",
        export_choose_month: "Escolhe um m√™s.",
        impressum_alert: "Impressum: aqui podes colocar os dados da tua empresa e contactos.",

        msg_prefix: "WorkTime ‚Äì Plano de servi√ßo",
        msg_hello: "Ol√° {name},",
        msg_shift: "O teu turno:",
        msg_date: "üìÖ Data: {date}",
        msg_time: "‚è∞ Hor√°rio: {from} ‚Äì {to}",
        msg_place: "üìç Local: Eiscaf√© Sanremo, Bad Berleburg",
        msg_month_info: "M√™s atual: {total} h (banco de horas: {bank} h)",
        msg_limit_info: " ‚Äì LIMITE de 40h ultrapassado!",
        msg_confirm: "Confirma com OK, por favor."
      },

      it: {
        chef_login_title: "Login Responsabile",
        chef_pin_label: "Inserisci PIN:",
        chef_pin_placeholder: "PIN",
        btn_login: "Login",
        btn_logout: "Logout",
        chef_login_hint: "Dopo il login si sbloccano le aree del responsabile (gestione dipendenti, pianificazione / WhatsApp, report mensile & export, privacy).",
        manage_employees_title: "Gestione dipendenti",
        emp_name_label: "Nome del dipendente:",
        emp_name_placeholder: "es. Marco, Anna...",
        emp_phone_label: "WhatsApp / Numero di telefono (opzionale):",
        emp_phone_placeholder: "es. 393123456789",
        btn_add_employee: "Aggiungi dipendente",
        emp_storage_hint: "Elenco dipendenti, ore, straordinari e storico vengono salvati localmente nel browser (localStorage).",
        schedule_title: "Pianificazione turni & WhatsApp",
        plan_emp_label: "Seleziona dipendente:",
        option_choose_employee: "-- Seleziona dipendente --",
        plan_day_label: "Giorno:",
        plan_from_label: "Da (ora):",
        plan_to_label: "A (ora):",
        btn_show_message: "Mostra messaggio",
        btn_open_whatsapp: "Apri WhatsApp",
        whatsapp_hint: "WhatsApp si apre con il messaggio gi√† pronto. Decidi tu se inviarlo.",
        preview_title: "Anteprima messaggio:",
        monthly_report_title: "Report mensile (Responsabile)",
        monthly_report_hint: "Panoramica di tutti i dipendenti per il mese corrente.",
        btn_print_report: "Stampa / salva come PDF",
        export_title: "Export mensile (Word / Stampa)",
        export_hint: "Export per dipendente e mese ‚Äì ideale per il commercialista. Viene creata una scheda mensile con tutti i giorni, inizio e fine lavoro.",
        export_emp_label: "Seleziona dipendente:",
        export_month_label: "Seleziona mese:",
        btn_export_word: "Crea scheda mensile (Word / Stampa)",
        export_info: "Si apre una nuova finestra con la tabella. Da l√¨ puoi stampare o salvare in PDF.",
        privacy_title: "Privacy & condizioni d'uso",
        privacy_block1_title: "1. Privacy",
        privacy_block1_text: "Questo sistema salva i dati solo localmente nel browser/tablet dell'esercizio. Nessun dato viene salvato su server esterni. L'accesso ai dati √® consentito solo al titolare/responsabile e alle persone autorizzate. Il datore di lavoro √® responsabile di informare i dipendenti sulla raccolta dati.",
        privacy_block2_title: "2. Utilizzo & copyright",
        privacy_block2_text: "L'applicazione √® destinata esclusivamente all'esercizio licenziatario. √à vietata la diffusione, copia, vendita o riproduzione del codice sorgente e del design senza autorizzazione scritta dello sviluppatore.",
        privacy_block3_title: "3. Esclusione di responsabilit√†",
        privacy_block3_text: "L'applicazione supporta la registrazione delle ore di lavoro. Il calcolo corretto delle retribuzioni e il rispetto delle norme sul lavoro restano responsabilit√† del datore di lavoro.",
        clock_title: "Timbro presenze (per dipendenti)",
        clock_emp_label: "Seleziona dipendente:",
        status_ready: "Pronto per timbrare.",
        btn_clock_in: "Entrata",
        btn_clock_out: "Uscita",
        btn_undo_last: "Cancella ultima registrazione",
        today_entries_title: "Registrazioni di oggi:",
        rule_text: "Regola: massimo 40 ore al mese. Il resto va nel conto ore.",
        footer_impressum: "Impressum",
        footer_privacy: "Privacy",

        hours_info: "Ore questo mese: {total} | Conto ore: {bank}",
        hours_limit: " ‚Äì Limite di 40h superato!",
        status_no_employees: "Nessun dipendente creato. Il responsabile deve aggiungerne uno.",
        alert_enter_name: "Inserisci un nome, per favore.",
        alert_select_employee: "Seleziona prima un dipendente.",
        alert_already_clocked_in: "Questo dipendente √® gi√† registrato come presente.",
        alert_not_clocked_in: "Questo dipendente non ha ancora timbrato l'entrata.",
        alert_no_entries_to_delete: "Nessuna registrazione da cancellare.",
        confirm_delete_employee: "Vuoi davvero eliminare il dipendente \"{name}\"?",
        confirm_delete_last: "Vuoi davvero cancellare l'ultima registrazione di \"{name}\"?",
        log_in: "{name} entrata/entrato",
        log_out: "{name} uscita/uscito ({hours} h)",
        log_deleted: "Ultima registrazione di {name} cancellata",
        chef_logged_out: "Logout eseguito.",
        chef_login_ok: "Login riuscito. Aree responsabile sbloccate.",
        chef_pin_wrong: "PIN errato.",
        whatsapp_fill_all: "Seleziona dipendente, giorno e orari.",
        whatsapp_choose_emp: "Seleziona un dipendente.",
        whatsapp_fill_date_time: "Inserisci giorno e orari.",
        whatsapp_no_phone: "Per questo dipendente non √® stato salvato alcun numero di telefono.",
        export_choose_emp: "Seleziona un dipendente.",
        export_choose_month: "Seleziona un mese.",
        impressum_alert: "Impressum: qui puoi inserire i dati e i contatti della tua azienda.",

        msg_prefix: "WorkTime ‚Äì Pianificazione turni",
        msg_hello: "Ciao {name},",
        msg_shift: "il tuo turno:",
        msg_date: "üìÖ Data: {date}",
        msg_time: "‚è∞ Orario: {from} ‚Äì {to}",
        msg_place: "üìç Luogo: Eiscaf√© Sanremo, Bad Berleburg",
        msg_month_info: "Mese attuale: {total} h (conto ore: {bank} h)",
        msg_limit_info: " ‚Äì LIMITE di 40h superato!",
        msg_confirm: "Per favore conferma con OK."
      }
    };

    let currentLang = localStorage.getItem('wt_lang') || 'de';

    function tr(key, params = {}) {
      const dict = translations[currentLang] || translations['de'];
      let str = dict[key] || translations['de'][key] || '';
      Object.keys(params).forEach(k => {
        str = str.replace(`{${k}}`, params[k]);
      });
      return str;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const txt = tr(key);
        if (txt) el.textContent = txt;
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        const txt = tr(key);
        if (txt) el.placeholder = txt;
      });

      const statusEl = document.getElementById('status');
      if (statusEl && !statusEl.dataset.forced) {
        statusEl.textContent = tr('status_ready');
      }
    }

    function updateLangButtons() {
      document.querySelectorAll('.lang-flag').forEach(img => {
        img.classList.toggle('active', img.dataset.lang === currentLang);
      });
    }

    document.querySelectorAll('.lang-flag').forEach(img => {
      img.addEventListener('click', () => {
        currentLang = img.dataset.lang || 'de';
        localStorage.setItem('wt_lang', currentLang);
        updateLangButtons();
        applyTranslations();
        updateHoursInfo();
        updatePlanHoursInfo();
      });
    });

    updateLangButtons();
    applyTranslations();

    // ================== CONFIG LOGIN DO CHEFE ==================
    const CHEF_PIN = "1234";

    const chefPinInput   = document.getElementById('chefPinInput');
    const btnChefLogin   = document.getElementById('btnChefLogin');
    const btnChefLogout  = document.getElementById('btnChefLogout');
    const chefLoginStatus = document.getElementById('chefLoginStatus');
    const chefArea       = document.getElementById('chefArea');
    const datenschutzBox = document.getElementById('datenschutzBox');

    let isChefLoggedIn = false;

    function setChefLoggedIn(state) {
      isChefLoggedIn = state;
      if (state) {
        chefArea.style.display = 'block';
        datenschutzBox.style.display = 'block';
        chefLoginStatus.style.color = 'green';
        chefLoginStatus.textContent = tr('chef_login_ok');
        chefPinInput.value = '';
      } else {
        chefArea.style.display = 'none';
        datenschutzBox.style.display = 'none';
        chefLoginStatus.style.color = '#555';
        chefLoginStatus.textContent = tr('chef_logged_out');
        chefPinInput.value = '';
      }
    }

    btnChefLogin.addEventListener('click', () => {
      const pin = chefPinInput.value.trim();
      if (pin === CHEF_PIN) {
        setChefLoggedIn(true);
      } else {
        chefLoginStatus.style.color = 'red';
        chefLoginStatus.textContent = tr('chef_pin_wrong');
      }
    });

    btnChefLogout.addEventListener('click', () => {
      setChefLoggedIn(false);
    });

    // ================== DADOS & ARMAZENAMENTO ==================
    let employees = [];

    function normalizeEmployees() {
      employees.forEach(e => {
        if (!e.monthlyHours) e.monthlyHours = {};
        if (!e.timeBank) e.timeBank = {};
        if (!e.sessions) e.sessions = [];
      });
    }

    function loadEmployees() {
      const data = localStorage.getItem('sanremoEmployees');
      employees = data ? JSON.parse(data) : [];
      normalizeEmployees();
    }

    function saveEmployees() {
      localStorage.setItem('sanremoEmployees', JSON.stringify(employees));
    }

    function generateId() {
      return 'emp_' + Math.random().toString(36).substring(2, 9);
    }

    const empNameInput = document.getElementById('empName');
    const empPhoneInput = document.getElementById('empPhone');
    const btnAddEmp = document.getElementById('btnAddEmp');
    const employeeListDiv = document.getElementById('employeeList');

    const employeeSelect = document.getElementById('employeeSelect');
    const statusEl = document.getElementById('status');
    const hoursInfoEl = document.getElementById('hoursInfo');
    const logEl = document.getElementById('log');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');
    const btnUndo = document.getElementById('btnUndo');

    const planEmployeeSelect = document.getElementById('planEmployeeSelect');
    const planHoursInfoEl = document.getElementById('planHoursInfo');
    const dateInput = document.getElementById('date');
    const timeFromInput = document.getElementById('timeFrom');
    const timeToInput = document.getElementById('timeTo');
    const btnPreview = document.getElementById('btnPreview');
    const btnWhatsapp = document.getElementById('btnWhatsapp');
    const previewText = document.getElementById('previewText');

    const exportEmployeeSelect = document.getElementById('exportEmployeeSelect');
    const exportMonthSelect    = document.getElementById('exportMonthSelect');
    const btnExportWord        = document.getElementById('btnExportWord');

    const MAX_HOURS_PER_MONTH = 40;

    function getCurrentMonthKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function formatGermanDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("de-DE", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }

    function getMonthLabel(year, month) {
      const d = new Date(year, month - 1, 1);
      return d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
    }

    function buildExportMonthOptions() {
      if (!exportMonthSelect) return;
      exportMonthSelect.innerHTML = '';
      const now = new Date();
      const year = now.getFullYear();
      for (let m = 1; m <= 12; m++) {
        const value = `${year}-${String(m).padStart(2,'0')}`;
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = getMonthLabel(year, m);
        exportMonthSelect.appendChild(opt);
      }
      exportMonthSelect.value = getCurrentMonthKey();
    }

    function getHoursAndBank(emp) {
      const monthKey = getCurrentMonthKey();
      const total = (emp.monthlyHours && emp.monthlyHours[monthKey]) || 0;
      const bank = (emp.timeBank && emp.timeBank[monthKey]) || 0;
      return { total, bank };
    }

    function getHoursAndBankForMonth(emp, monthKey) {
      const total = (emp.monthlyHours && emp.monthlyHours[monthKey]) || 0;
      const bank = (emp.timeBank && emp.timeBank[monthKey]) || 0;
      return { total, bank };
    }

    function updateHoursInfo() {
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        hoursInfoEl.textContent = tr('hours_info', { total: '0', bank: '0' });
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = tr('hours_info', { total: total.toFixed(2), bank: bank.toFixed(2) });
      if (total > MAX_HOURS_PER_MONTH) {
        text += tr('hours_limit');
      }
      hoursInfoEl.innerHTML = text;
    }

    function updatePlanHoursInfo() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (!emp) {
        planHoursInfoEl.textContent = tr('hours_info', { total: '0', bank: '0' });
        return;
      }
      const { total, bank } = getHoursAndBank(emp);
      let text = tr('hours_info', { total: total.toFixed(2), bank: bank.toFixed(2) });
      if (total > MAX_HOURS_PER_MONTH) {
        text += tr('hours_limit');
      }
      planHoursInfoEl.innerHTML = text;
    }

    function addLog(text) {
      const now = new Date().toLocaleString();
      logEl.innerHTML += `${text} ‚Äì <i>${now}</i><br>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function maskPhone(phone) {
      if (!phone) return '';
      if (phone.length <= 4) return phone;
      return phone.slice(0, 3) + '****' + phone.slice(-2);
    }

    function refreshEmployeeUI() {
      employeeSelect.innerHTML = `<option value="">${tr('option_choose_employee')}</option>`;
      planEmployeeSelect.innerHTML = `<option value="">${tr('option_choose_employee')}</option>`;
      exportEmployeeSelect.innerHTML = `<option value="">${tr('option_choose_employee')}</option>`;

      employees.forEach(emp => {
        const opt1 = document.createElement('option');
        opt1.value = emp.id;
        opt1.textContent = emp.name;
        employeeSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = emp.id;
        opt2.textContent = emp.name;
        planEmployeeSelect.appendChild(opt2);

        const opt3 = document.createElement('option');
        opt3.value = emp.id;
        opt3.textContent = emp.name;
        exportEmployeeSelect.appendChild(opt3);
      });

      employeeListDiv.innerHTML = '';
      employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        row.innerHTML = `
          <span>${emp.name} ${emp.phone ? '(' + maskPhone(emp.phone) + ')' : ''}</span>
        `;
        const btnDel = document.createElement('button');
        btnDel.textContent = "L√∂schen";
        btnDel.className = 'btn-danger';
        btnDel.onclick = () => {
          if (confirm(tr('confirm_delete_employee', { name: emp.name }))) {
            employees = employees.filter(e => e.id !== emp.id);
            saveEmployees();
            refreshEmployeeUI();
            updateHoursInfo();
            updatePlanHoursInfo();
            renderMonthlyReport();
          }
        };
        row.appendChild(btnDel);
        employeeListDiv.appendChild(row);
      });

      const disabled = employees.length === 0;
      btnIn.disabled = disabled;
      btnOut.disabled = disabled;
      btnUndo.disabled = disabled;
      if (disabled) {
        statusEl.textContent = tr('status_no_employees');
        statusEl.dataset.forced = "1";
      } else {
        statusEl.textContent = tr('status_ready');
        statusEl.dataset.forced = "";
      }

      buildExportMonthOptions();
    }

    employeeSelect.addEventListener('change', () => {
      updateHoursInfo();
      const empId = employeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      if (emp && emp.activeSessionStart) {
        statusEl.textContent = new Date(emp.activeSessionStart).toLocaleString();
      } else {
        statusEl.textContent = tr('status_ready');
      }
    });

    planEmployeeSelect.addEventListener('change', () => {
      updatePlanHoursInfo();
    });

    btnAddEmp.addEventListener('click', () => {
      const name = empNameInput.value.trim();
      const phone = empPhoneInput.value.trim();
      if (!name) {
        alert(tr('alert_enter_name'));
        return;
      }
      const emp = {
        id: generateId(),
        name,
        phone: phone || '',
        monthlyHours: {},
        timeBank: {},
        activeSessionStart: null,
        sessions: []
      };
      employees.push(emp);
      saveEmployees();
      empNameInput.value = '';
      empPhoneInput.value = '';
      refreshEmployeeUI();
      renderMonthlyReport();
    });

    btnIn.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(tr('alert_select_employee'));
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (emp.activeSessionStart) {
        alert(tr('alert_already_clocked_in'));
        return;
      }

      emp.activeSessionStart = new Date().toISOString();
      saveEmployees();
      statusEl.textContent = new Date(emp.activeSessionStart).toLocaleString();
      addLog(tr('log_in', { name: emp.name }));
    });

    btnOut.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(tr('alert_select_employee'));
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      if (!emp.activeSessionStart) {
        alert(tr('alert_not_clocked_in'));
        return;
      }

      const start = new Date(emp.activeSessionStart);
      const end = new Date();
      const diffMs = end - start;
      const hours = diffMs / 1000 / 60 / 60;

      const monthKey = getCurrentMonthKey();
      if (!emp.monthlyHours) emp.monthlyHours = {};
      if (!emp.timeBank) emp.timeBank = {};

      const prevTotal = emp.monthlyHours[monthKey] || 0;
      const newTotal = prevTotal + hours;
      emp.monthlyHours[monthKey] = newTotal;

      let bank = 0;
      if (newTotal > MAX_HOURS_PER_MONTH) {
        bank = newTotal - MAX_HOURS_PER_MONTH;
      }
      emp.timeBank[monthKey] = bank;

      if (!emp.sessions) emp.sessions = [];
      emp.sessions.push({
        start: start.toISOString(),
        end: end.toISOString(),
        hours: hours
      });

      emp.activeSessionStart = null;
      saveEmployees();

      statusEl.textContent =
        tr('log_out', { name: emp.name, hours: hours.toFixed(2) });
      addLog(tr('log_out', { name: emp.name, hours: hours.toFixed(2) }));

      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
    });

    btnUndo.addEventListener('click', () => {
      const empId = employeeSelect.value;
      if (!empId) {
        alert(tr('alert_select_employee'));
        return;
      }
      const emp = employees.find(e => e.id === empId);
      if (!emp || !emp.sessions || emp.sessions.length === 0) {
        alert(tr('alert_no_entries_to_delete'));
        return;
      }

      if (!confirm(tr('confirm_delete_last', { name: emp.name }))) {
        return;
      }

      const last = emp.sessions.pop();
      const dateKey = last.start.substring(0, 7);
      let sum = 0;
      emp.sessions.forEach(s => {
        if (s.start.substring(0, 7) === dateKey) {
          sum += (s.hours || 0);
        }
      });
      if (!emp.monthlyHours) emp.monthlyHours = {};
      if (!emp.timeBank) emp.timeBank = {};
      emp.monthlyHours[dateKey] = sum;
      emp.timeBank[dateKey] = sum > MAX_HOURS_PER_MONTH ? (sum - MAX_HOURS_PER_MONTH) : 0;

      saveEmployees();
      updateHoursInfo();
      updatePlanHoursInfo();
      renderMonthlyReport();
      addLog(tr('log_deleted', { name: emp.name }));
    });

    function getHoursAndBankForCurrentMonth(emp) {
      const monthKey = getCurrentMonthKey();
      return getHoursAndBankForMonth(emp, monthKey);
    }

    function buildMessage() {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const date = dateInput.value;
      const tFrom = timeFromInput.value;
      const tTo = timeToInput.value;

      if (!emp || !date || !tFrom || !tTo) {
        return "";
      }

      const dateDE = formatGermanDate(date);
      const { total, bank } = getHoursAndBankForCurrentMonth(emp);

      let hoursLine = tr('msg_month_info', {
        total: total.toFixed(2),
        bank: bank.toFixed(2)
      });
      if (total > MAX_HOURS_PER_MONTH) {
        hoursLine += tr('msg_limit_info');
      }

      const msg =
        tr('msg_prefix') + "\n\n" +
        tr('msg_hello', { name: emp.name }) + "\n\n" +
        tr('msg_shift') + "\n" +
        tr('msg_date', { date: dateDE }) + "\n" +
        tr('msg_time', { from: tFrom, to: tTo }) + "\n" +
        tr('msg_place') + "\n\n" +
        hoursLine + "\n\n" +
        tr('msg_confirm');
      return msg;
    }

    btnPreview.addEventListener('click', () => {
      const msg = buildMessage();
      if (!msg) {
        alert(tr('whatsapp_fill_all'));
        return;
      }
      previewText.textContent = msg;
    });

    btnWhatsapp.addEventListener('click', () => {
      const empId = planEmployeeSelect.value;
      const emp = employees.find(e => e.id === empId);
      const msg = buildMessage();

      if (!emp) {
        alert(tr('whatsapp_choose_emp'));
        return;
      }
      if (!msg) {
        alert(tr('whatsapp_fill_date_time'));
        return;
      }

      if (!emp.phone) {
        alert(tr('whatsapp_no_phone'));
        return;
      }

      const phone = emp.phone;
      const encodedMsg = encodeURIComponent(msg);
      const url = "https://wa.me/" + phone + "?text=" + encodedMsg;

      window.open(url, "_blank");
    });

    function renderMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      if (!employees || employees.length === 0) {
        container.innerHTML = '<em>Keine Mitarbeiter angelegt.</em>';
        return;
      }

      const monthKey = getCurrentMonthKey();

      let html = '<table style="width:100%; border-collapse: collapse; font-size:14px;">';
      html += '<thead><tr>' +
              '<th style="border-bottom:1px solid #ccc; text-align:left; padding:4px;">Mitarbeiter</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">Stunden im Monat</th>' +
              '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">√úberstundenkonto</th>' +
              '</tr></thead><tbody>';

      let totalHoursAll = 0;
      let totalBankAll = 0;

      employees.forEach(emp => {
        const { total, bank } = getHoursAndBankForMonth(emp, monthKey);
        totalHoursAll += total;
        totalBankAll += bank;

        html += '<tr>' +
          '<td style="border-bottom:1px solid #eee; padding:4px;">' + emp.name + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + total.toFixed(2) + '</td>' +
          '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + bank.toFixed(2) + '</td>' +
          '</tr>';
      });

      html += '<tr>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">Summe:</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalHoursAll.toFixed(2) + '</td>' +
        '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalBankAll.toFixed(2) + '</td>' +
        '</tr>';

      html += '</tbody></table>';

      container.innerHTML = html;
    }

    function printMonthlyReport() {
      const container = document.getElementById('monthlyReportContainer');
      if (!container) return;

      const win = window.open('', '_blank');
      win.document.write('<html><head><title>Monatsbericht ‚Äì WorkTime</title>');
      win.document.write('<meta charset="UTF-8">');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse;font-size:14px;} th,td{border:1px solid #ccc;padding:4px;} th{text-align:left;background:#f0f0f0;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h2>Monatsbericht ‚Äì WorkTime</h2>');
      win.document.write('<p>Monat: ' + getCurrentMonthKey() + '</p>');
      win.document.write(container.innerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }

    function buildMonthlyRowsForEmployee(emp, year, month) {
      const rows = [];
      const daysInMonth = new Date(year, month, 0).getDate();
      let totalHours = 0;

      const sessions = emp.sessions || [];

      for (let day = 1; day <= daysInMonth; day++) {
        const dayStr = String(day).padStart(2, '0');
        const dateIsoPrefix = `${year}-${String(month).padStart(2,'0')}-${dayStr}`;

        const daySessions = sessions.filter(s => {
          const sDate = s.start ? s.start.substring(0,10) : '';
          return sDate === dateIsoPrefix;
        });

        if (daySessions.length === 0) {
          rows.push({
            date: `${dayStr}.${String(month).padStart(2,'0')}.${year}`,
            start: '',
            end: '',
            breakFrom: '',
            breakTo: '',
            hours: '',
            payType: ''
          });
        } else {
          daySessions.forEach((s, idx) => {
            const start = new Date(s.start);
            const end   = new Date(s.end);
            const h     = (s.hours != null ? s.hours :
                          (end - start) / 1000 / 60 / 60);
            totalHours += h;

            rows.push({
              date: idx === 0 ? `${dayStr}.${String(month).padStart(2,'0')}.${year}` : '',
              start: start.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' }),
              end:   end.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' }),
              breakFrom: '',
              breakTo: '',
              hours: h.toFixed(2).replace('.', ','),
              payType: ''
            });
          });
        }
      }

      return { rows, totalHours };
    }

    function openMonthlyPrintWindow(emp, year, month) {
      const { rows, totalHours } = buildMonthlyRowsForEmployee(emp, year, month);
      const monthLabel = getMonthLabel(year, month);

      const win = window.open('', '_blank');
      win.document.write('<html><head><meta charset="UTF-8">');
      win.document.write('<title>Stundennachweis ‚Äì ' + emp.name + ' ‚Äì ' + monthLabel + '</title>');
      win.document.write('<style>');
      win.document.write('body{font-family:Arial,sans-serif;padding:16px;}');
      win.document.write('h2,h3{margin:4px 0;}');
      win.document.write('table{width:100%;border-collapse:collapse;margin-top:12px;font-size:12px;}');
      win.document.write('th,td{border:1px solid #ccc;padding:4px;text-align:left;}');
      win.document.write('th{text-align:center;background:#f0f0f0;}');
      win.document.write('tfoot td{font-weight:bold;}');
      win.document.write('</style></head><body>');

      win.document.write('<h2>Stundennachweis</h2>');
      win.document.write('<h3>Mitarbeiter: ' + emp.name + '</h3>');
      win.document.write('<p>Monat: ' + monthLabel + '</p>');

      win.document.write('<table>');
      win.document.write('<thead><tr>');
      win.document.write('<th>Tag</th>');
      win.document.write('<th>Arbeitsbeginn</th>');
      win.document.write('<th>Arbeitsende</th>');
      win.document.write('<th>Pausenzeiten<br>von</th>');
      win.document.write('<th>Pausenzeiten<br>bis</th>');
      win.document.write('<th>Arbeitszeit (Std.)</th>');
      win.document.write('<th>Entlohnungsart</th>');
      win.document.write('</tr></thead><tbody>');

      rows.forEach(r => {
        win.document.write('<tr>');
        win.document.write('<td>' + r.date      + '</td>');
        win.document.write('<td>' + r.start     + '</td>');
        win.document.write('<td>' + r.end       + '</td>');
        win.document.write('<td>' + r.breakFrom + '</td>');
        win.document.write('<td>' + r.breakTo   + '</td>');
        win.document.write('<td style="text-align:right;">' + r.hours + '</td>');
        win.document.write('<td>' + r.payType   + '</td>');
        win.document.write('</tr>');
      });

      win.document.write('</tbody><tfoot><tr>');
      win.document.write('<td colspan="5" style="text-align:right;">Summe Arbeitsstunden:</td>');
      win.document.write('<td style="text-align:right;">' + totalHours.toFixed(2).replace('.', ',') + '</td>');
      win.document.write('<td></td>');
      win.document.write('</tr></tfoot></table>');

      win.document.write('</body></html>');
      win.document.close();
      win.focus();
    }

    if (btnExportWord) {
      btnExportWord.addEventListener('click', () => {
        const empId = exportEmployeeSelect.value;
        const monthValue = exportMonthSelect.value;

        if (!empId) {
          alert(tr('export_choose_emp'));
          return;
        }
        if (!monthValue) {
          alert(tr('export_choose_month'));
          return;
        }

        const emp = employees.find(e => e.id === empId);
        if (!emp) {
          alert(tr('export_choose_emp'));
          return;
        }

        const [yearStr, monthStr] = monthValue.split('-');
        const year  = parseInt(yearStr, 10);
        const month = parseInt(monthStr, 10);

        openMonthlyPrintWindow(emp, year, month);
      });
    }

    document.getElementById('linkDatenschutz').addEventListener('click', function(e) {
      e.preventDefault();
      if (!isChefLoggedIn) {
        alert("Nur nach Chef-Login sichtbar.");
        return;
      }
      if (datenschutzBox.style.display === 'none') {
        datenschutzBox.style.display = 'block';
      }
      datenschutzBox.scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('linkImpressum').addEventListener('click', function(e) {
      e.preventDefault();
      alert(tr('impressum_alert'));
    });

    loadEmployees();
    refreshEmployeeUI();
    updateHoursInfo();
    updatePlanHoursInfo();
    renderMonthlyReport();
    buildExportMonthOptions();
    applyTranslations();
  </script>
</body>
</html>
