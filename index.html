
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Eiscaf√© Sanremo ‚Äì Mitarbeiterportal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* ===== Layout geral ===== */
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      padding: 20px;
      box-sizing: border-box;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 12px;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 11px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      box-sizing: border-box;
    }

    .btn-primary { background: #0275d8; color: #fff; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-danger { background: #d32f2f; color: #fff; }

    .section {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 18px;
    }

    /* ===== Banner topo ===== */
    .hero-banner {
      width: 100%;
      height: 170px;
      border-radius: 14px;
      background-image: url('IMG-20251125-WA0004.jpg'); /* foto do copo de gelado + logo */
      background-size: cover;
      background-position: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      margin-bottom: 22px;
    }

    /* ===== Chef Login com cores da bandeira italiana ===== */
    .section-chef-login {
      background: linear-gradient(
        90deg,
        rgba(0,140,69,0.18),    /* verde */
        rgba(255,255,255,0.95), /* branco */
        rgba(205,33,42,0.18)    /* vermelho */
      );
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 20px;
    }

    .section-chef-login-inner {
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      padding: 12px 14px;
    }

    #chefLoginStatus {
      font-size: 13px;
      margin-top: 6px;
    }

    /* ===== Grid principal (lado esquerdo Chefe, lado direito Stempeluhr) ===== */
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 18px;
      align-items: flex-start;
      margin-bottom: 18px;
    }

    /* Lista de empregados do chefe */
    .employee-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      gap: 8px;
    }
    .employee-row button {
      width: auto;
      padding: 5px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    #log {
      margin-top: 10px;
      font-size: 13px;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 6px;
      background: #fafafa;
    }

    .warning {
      color: #d32f2f;
      font-weight: bold;
    }

    #previewText {
      white-space: pre-wrap;
      font-size: 13px;
      margin-top: 6px;
    }

    /* Monatsbericht centrado em baixo */
    #chefReportSection {
      max-width: 600px;
      margin: 0 auto 30px auto;
    }

    @media (max-width: 800px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- BANNER -->
  <div class="hero-banner"></div>

  <!-- CHEF LOGIN -->
  <div class="section-chef-login">
    <div class="section-chef-login-inner">
      <h3>Chef Login</h3>

      <label for="chefPinInput">PIN eingeben:</label>
      <input type="password" id="chefPinInput" placeholder="PIN">

      <button id="btnChefLogin" class="btn-primary">Login</button>
      <p id="chefLoginStatus"></p>
      <small style="font-size:12px;">
        Nach erfolgreichem Login werden die Chef-Bereiche (Mitarbeiter verwalten, Dienstplan / WhatsApp)
        und der Monatsbericht freigeschaltet.
      </small>
    </div>
  </div>

  <!-- GRID: esquerda (Chef), direita (Stempeluhr) -->
  <div class="grid">

    <!-- √ÅREA DO CHEFE (escondida at√© login) -->
    <div id="chefArea" style="display:none;">

      <!-- Gest√£o de empregados -->
      <div class="section">
        <h3>Mitarbeiter verwalten</h3>

        <label for="empName">Name des Mitarbeiters:</label>
        <input type="text" id="empName" placeholder="z.B. Jo√£o, Maria, ...">

        <label for="empPhone">WhatsApp / Telefonnummer (optional):</label>
        <input type="text" id="empPhone" placeholder="z.B. 491701234567">

        <button id="btnAddEmp" class="btn-primary">Mitarbeiter hinzuf√ºgen</button>

        <div id="employeeList" style="margin-top:10px;"></div>

        <small style="font-size:12px; display:block; margin-top:8px;">
          Mitarbeiterliste, Stunden und √úberstunden werden im Browser (localStorage) gespeichert.
        </small>
      </div>

      <!-- Dienstplan + WhatsApp -->
      <div class="section">
        <h3>Dienstplan &amp; WhatsApp</h3>

        <label for="planEmployeeSelect">Mitarbeiter ausw√§hlen:</label>
        <select id="planEmployeeSelect">
          <option value="">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="planHoursInfo" style="font-size:13px; margin-bottom:8px;">
          Stunden diesen Monat: 0 | √úberstundenkonto: 0
        </div>

        <label for="date">Tag:</label>
        <input type="date" id="date">

        <label for="timeFrom">Von (Uhrzeit):</label>
        <input type="time" id="timeFrom">

        <label for="timeTo">Bis (Uhrzeit):</label>
        <input type="time" id="timeTo">

        <button id="btnPreview" class="btn-secondary" style="margin-top:4px;">
          Nachricht anzeigen
        </button>
        <button id="btnWhatsapp" class="btn-primary" style="margin-top:6px;">
          WhatsApp √∂ffnen
        </button>

        <div class="section" style="margin-top:10px; background:#fafafa;">
          <b>Vorschau Nachricht:</b>
          <p id="previewText">(Noch keine Nachricht)</p>
        </div>
      </div>
    </div>

    <!-- STEMPENUHR ‚Äì sempre vis√≠vel -->
    <div>
      <div class="section">
        <h3>Stempeluhr (f√ºr Mitarbeiter)</h3>

        <label for="employeeSelect">Mitarbeiter ausw√§hlen:</label>
        <select id="employeeSelect">
          <option value="">-- Mitarbeiter w√§hlen --</option>
        </select>

        <div id="hoursInfo" style="font-size:13px; margin-bottom:10px;">
          Stunden diesen Monat: 0 | √úberstundenkonto: 0
        </div>

        <div id="status" style="font-size:13px; margin-bottom:10px;">
          Bereit zum Stempeln.
        </div>

        <button id="btnIn" class="btn-primary">Einstempeln</button>
        <button id="btnOut" class="btn-secondary" style="margin-top:6px;">Ausstempeln</button>

        <div id="log" style="margin-top:12px;">
          <b>Heutige Eintr√§ge:</b><br>
        </div>

        <small style="font-size:12px; display:block; margin-top:8px;">
          Regel: Maximal 40 Stunden im Monat. Alles dar√ºber geht ins √úberstundenkonto (Bank von Stunden).
        </small>
      </div>
    </div>

  </div>

  <!-- MONATSBERICHT EM BAIXO, CENTRADO -->
  <div id="chefReportSection" class="section" style="display:none;">
    <h3>Monatsbericht (Chef)</h3>
    <p style="font-size:13px; margin-bottom:8px;">
      √úbersicht aller Mitarbeiter f√ºr den aktuellen Monat.
    </p>

    <div id="monthlyReportContainer"></div>

    <button class="btn-primary" style="margin-top:10px;" onclick="printMonthlyReport()">
      Drucken / als PDF speichern
    </button>
  </div>

</div>

<script>
  /* ===== CONFIG ===== */
  const CHEF_PIN = "1234"; // MUDA ESTE PIN S√ì PARA TI

  const MAX_HOURS_PER_MONTH = 40;

  /* ===== ELEMENTOS ===== */
  const chefPinInput = document.getElementById('chefPinInput');
  const btnChefLogin = document.getElementById('btnChefLogin');
  const chefLoginStatus = document.getElementById('chefLoginStatus');
  const chefArea = document.getElementById('chefArea');
  const chefReportSection = document.getElementById('chefReportSection');

  const empNameInput = document.getElementById('empName');
  const empPhoneInput = document.getElementById('empPhone');
  const btnAddEmp = document.getElementById('btnAddEmp');
  const employeeListDiv = document.getElementById('employeeList');

  const employeeSelect = document.getElementById('employeeSelect');
  const hoursInfoEl = document.getElementById('hoursInfo');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const btnIn = document.getElementById('btnIn');
  const btnOut = document.getElementById('btnOut');

  const planEmployeeSelect = document.getElementById('planEmployeeSelect');
  const planHoursInfoEl = document.getElementById('planHoursInfo');
  const dateInput = document.getElementById('date');
  const timeFromInput = document.getElementById('timeFrom');
  const timeToInput = document.getElementById('timeTo');
  const btnPreview = document.getElementById('btnPreview');
  const btnWhatsapp = document.getElementById('btnWhatsapp');
  const previewText = document.getElementById('previewText');
  const monthlyReportContainer = document.getElementById('monthlyReportContainer');

  /* ===== DADOS (localStorage) ===== */
  let employees = [];

  function loadEmployees() {
    const data = localStorage.getItem('sanremoEmployees');
    if (data) employees = JSON.parse(data);
    else employees = [];
  }

  function saveEmployees() {
    localStorage.setItem('sanremoEmployees', JSON.stringify(employees));
  }

  function generateId() {
    return 'emp_' + Math.random().toString(36).substring(2, 9);
  }

  function getCurrentMonthKey() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    return `${y}-${m}`;
  }

  function getHoursAndBank(emp) {
    const monthKey = getCurrentMonthKey();
    const total = (emp.monthlyHours && emp.monthlyHours[monthKey]) || 0;
    const bank = (emp.timeBank && emp.timeBank[monthKey]) || 0;
    return { total, bank };
  }

  function updateHoursInfo() {
    const empId = employeeSelect.value;
    const emp = employees.find(e => e.id === empId);
    if (!emp) {
      hoursInfoEl.innerHTML = 'Stunden diesen Monat: 0 | √úberstundenkonto: 0';
      return;
    }
    const { total, bank } = getHoursAndBank(emp);
    let text = `Stunden diesen Monat: ${total.toFixed(2)} | √úberstundenkonto: ${bank.toFixed(2)}`;
    if (total > MAX_HOURS_PER_MONTH) {
      text += ' ‚Äì <span class="warning">Limit 40h √ºberschritten!</span>';
    }
    hoursInfoEl.innerHTML = text;
  }

  function updatePlanHoursInfo() {
    const empId = planEmployeeSelect.value;
    const emp = employees.find(e => e.id === empId);
    if (!emp) {
      planHoursInfoEl.innerHTML = 'Stunden diesen Monat: 0 | √úberstundenkonto: 0';
      return;
    }
    const { total, bank } = getHoursAndBank(emp);
    let text = `Stunden diesen Monat: ${total.toFixed(2)} | √úberstundenkonto: ${bank.toFixed(2)}`;
    if (total > MAX_HOURS_PER_MONTH) {
      text += ' ‚Äì <span class="warning">Limit 40h √ºberschritten!</span>';
    }
    planHoursInfoEl.innerHTML = text;
  }

  function addLog(text) {
    const now = new Date().toLocaleString();
    logEl.innerHTML += `${text} ‚Äì <i>${now}</i><br>`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function refreshEmployeeUI() {
    employeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
    planEmployeeSelect.innerHTML = '<option value="">-- Mitarbeiter w√§hlen --</option>';
    employeeListDiv.innerHTML = '';

    employees.forEach(emp => {
      const opt1 = document.createElement('option');
      opt1.value = emp.id;
      opt1.textContent = emp.name;
      employeeSelect.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = emp.id;
      opt2.textContent = emp.name;
      planEmployeeSelect.appendChild(opt2);

      const row = document.createElement('div');
      row.className = 'employee-row';
      row.innerHTML = `<span>${emp.name} ${emp.phone ? '(' + emp.phone + ')' : ''}</span>`;
      const delBtn = document.createElement('button');
      delBtn.textContent = 'L√∂schen';
      delBtn.className = 'btn-danger';
      delBtn.onclick = () => {
        if (confirm(`Mitarbeiter "${emp.name}" wirklich l√∂schen?`)) {
          employees = employees.filter(e => e.id !== emp.id);
          saveEmployees();
          refreshEmployeeUI();
          updateHoursInfo();
          updatePlanHoursInfo();
          renderMonthlyReport();
        }
      };
      row.appendChild(delBtn);
      employeeListDiv.appendChild(row);
    });

    const disabled = employees.length === 0;
    btnIn.disabled = disabled;
    btnOut.disabled = disabled;
    if (disabled) {
      statusEl.textContent = 'Keine Mitarbeiter angelegt. Chef muss zuerst Mitarbeiter hinzuf√ºgen.';
    } else {
      statusEl.textContent = 'Bereit zum Stempeln.';
    }
  }

  /* ===== LOGIN DO CHEFE ===== */
  btnChefLogin.addEventListener('click', () => {
    const pin = chefPinInput.value.trim();
    if (pin === CHEF_PIN) {
      chefArea.style.display = 'block';
      chefReportSection.style.display = 'block';
      chefLoginStatus.style.color = 'green';
      chefLoginStatus.textContent = 'Login erfolgreich. Chef-Bereiche sind freigeschaltet.';
      chefPinInput.value = '';
    } else {
      chefLoginStatus.style.color = 'red';
      chefLoginStatus.textContent = 'Falscher PIN.';
    }
  });

  /* ===== ADICIONAR EMPREGADOS ===== */
  btnAddEmp.addEventListener('click', () => {
    const name = empNameInput.value.trim();
    const phone = empPhoneInput.value.trim();
    if (!name) {
      alert('Bitte einen Namen eingeben.');
      return;
    }
    const emp = {
      id: generateId(),
      name,
      phone: phone || '',
      monthlyHours: {},
      timeBank: {},
      activeSessionStart: null
    };
    employees.push(emp);
    saveEmployees();
    empNameInput.value = '';
    empPhoneInput.value = '';
    refreshEmployeeUI();
    renderMonthlyReport();
  });

  /* ===== STEMPENUHR ===== */
  employeeSelect.addEventListener('change', () => {
    updateHoursInfo();
    const empId = employeeSelect.value;
    const emp = employees.find(e => e.id === empId);
    if (emp && emp.activeSessionStart) {
      statusEl.textContent = 'Mitarbeiter ist aktuell eingestempelt (seit ' +
        new Date(emp.activeSessionStart).toLocaleString() + ').';
    } else {
      statusEl.textContent = 'Bereit zum Stempeln.';
    }
  });

  planEmployeeSelect.addEventListener('change', () => {
    updatePlanHoursInfo();
  });

  btnIn.addEventListener('click', () => {
    const empId = employeeSelect.value;
    if (!empId) {
      alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
      return;
    }
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    if (emp.activeSessionStart) {
      alert('Dieser Mitarbeiter ist bereits eingestempelt.');
      return;
    }
    emp.activeSessionStart = new Date().toISOString();
    saveEmployees();
    statusEl.textContent = 'Eingestempelt um ' +
      new Date(emp.activeSessionStart).toLocaleString() + '.';
    addLog(emp.name + ' eingestempelt');
  });

  btnOut.addEventListener('click', () => {
    const empId = employeeSelect.value;
    if (!empId) {
      alert('Bitte zuerst einen Mitarbeiter ausw√§hlen.');
      return;
    }
    const emp = employees.find(e => e.id === empId);
    if (!emp || !emp.activeSessionStart) {
      alert('Dieser Mitarbeiter ist noch nicht eingestempelt.');
      return;
    }
    const start = new Date(emp.activeSessionStart);
    const end = new Date();
    const diffMs = end - start;
    const hours = diffMs / 1000 / 60 / 60;

    const monthKey = getCurrentMonthKey();
    if (!emp.monthlyHours) emp.monthlyHours = {};
    if (!emp.timeBank) emp.timeBank = {};

    const prevTotal = emp.monthlyHours[monthKey] || 0;
    const newTotal = prevTotal + hours;
    emp.monthlyHours[monthKey] = newTotal;

    let bank = 0;
    if (newTotal > MAX_HOURS_PER_MONTH) {
      bank = newTotal - MAX_HOURS_PER_MONTH;
    }
    emp.timeBank[monthKey] = bank;

    emp.activeSessionStart = null;
    saveEmployees();

    statusEl.textContent = 'Ausgestempelt. Gearbeitete Zeit: ' +
      hours.toFixed(2) + ' Std. Gesamt in diesem Monat: ' +
      newTotal.toFixed(2) + ' Std.';
    addLog(emp.name + ' ausgestempelt (' + hours.toFixed(2) + ' Std.)');

    updateHoursInfo();
    updatePlanHoursInfo();
    renderMonthlyReport();
  });

  /* ===== WHATSAPP ===== */
  function formatGermanDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr + "T00:00:00");
    return d.toLocaleDateString("de-DE", {
      weekday: "short",
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    });
  }

  function buildMessage() {
    const empId = planEmployeeSelect.value;
    const emp = employees.find(e => e.id === empId);
    const date = dateInput.value;
    const tFrom = timeFromInput.value;
    const tTo = timeToInput.value;
    if (!emp || !date || !tFrom || !tTo) return "";

    const dateDE = formatGermanDate(date);
    const { total, bank } = getHoursAndBank(emp);
    let hoursLine =
      `Aktueller Monat: ${total.toFixed(2)} Std. (√úberstundenkonto: ${bank.toFixed(2)} Std.)`;
    if (total > MAX_HOURS_PER_MONTH) hoursLine += " ‚Äì LIMIT 40h √ºberschritten!";

    return "Eiscaf√© Sanremo ‚Äì Dienstplan\n\n" +
      "Hallo " + emp.name + ",\n\n" +
      "dein Dienst:\n" +
      "üìÖ Datum: " + dateDE + "\n" +
      "‚è∞ Zeit: " + tFrom + " ‚Äì " + tTo + " Uhr\n" +
      "üìç Ort: Eiscaf√© Sanremo, Bad Berleburg\n\n" +
      hoursLine + "\n\n" +
      "Bitte best√§tige mit OK.";
  }

  btnPreview.addEventListener('click', () => {
    const msg = buildMessage();
    if (!msg) {
      alert("Bitte Mitarbeiter, Tag und Zeiten ausf√ºllen.");
      return;
    }
    previewText.textContent = msg;
  });

  btnWhatsapp.addEventListener('click', () => {
    const empId = planEmployeeSelect.value;
    const emp = employees.find(e => e.id === empId);
    const msg = buildMessage();
    if (!emp) {
      alert("Bitte Mitarbeiter w√§hlen.");
      return;
    }
    if (!msg) {
      alert("Bitte Tag und Zeiten eintragen.");
      return;
    }
    if (!emp.phone) {
      alert("F√ºr diesen Mitarbeiter ist keine Telefonnummer hinterlegt.");
      return;
    }
    const phone = emp.phone;
    const encodedMsg = encodeURIComponent(msg);
    const url = "https://wa.me/" + phone + "?text=" + encodedMsg;
    window.open(url, "_blank");
  });

  /* ===== MONATSBERICHT ===== */
  function renderMonthlyReport() {
    if (!monthlyReportContainer) return;
    if (!employees.length) {
      monthlyReportContainer.innerHTML = "<em>Keine Mitarbeiter angelegt.</em>";
      return;
    }
    let html = '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
    html += '<tr>' +
            '<th style="border-bottom:1px solid #ccc; text-align:left; padding:4px;">Mitarbeiter</th>' +
            '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">Stunden</th>' +
            '<th style="border-bottom:1px solid #ccc; text-align:right; padding:4px;">√úberstundenkonto</th>' +
            '</tr>';
    let totalHoursAll = 0;
    let totalBankAll = 0;
    employees.forEach(emp => {
      const { total, bank } = getHoursAndBank(emp);
      totalHoursAll += total;
      totalBankAll += bank;
      html += '<tr>' +
        '<td style="border-bottom:1px solid #eee; padding:4px;">' + emp.name + '</td>' +
        '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + total.toFixed(2) + '</td>' +
        '<td style="border-bottom:1px solid #eee; padding:4px; text-align:right;">' + bank.toFixed(2) + '</td>' +
        '</tr>';
    });
    html += '<tr>' +
      '<td style="padding:4px; font-weight:bold; text-align:right;">Summe:</td>' +
      '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalHoursAll.toFixed(2) + '</td>' +
      '<td style="padding:4px; font-weight:bold; text-align:right;">' + totalBankAll.toFixed(2) + '</td>' +
      '</tr>';
    html += '</table>';
    monthlyReportContainer.innerHTML = html;
  }

  function printMonthlyReport() {
    const win = window.open('', '_blank');
    win.document.write('<html><head><title>Monatsbericht ‚Äì Eiscaf√© Sanremo</title>');
    win.document.write('<meta charset="UTF-8">');
    win.document.write('<style>body{font-family:Arial,sans-serif;padding:16px;} table{width:100%;border-collapse:collapse;font-size:13px;} th,td{border:1px solid #ccc;padding:4px;} th{background:#f0f0f0;}</style>');
    win.document.write('</head><body>');
    win.document.write('<h2>Monatsbericht ‚Äì Eiscaf√© Sanremo</h2>');
    win.document.write('<p>Monat: ' + getCurrentMonthKey() + '</p>');
    win.document.write(monthlyReportContainer.innerHTML);
    win.document.write('</body></html>');
    win.document.close();
    win.focus();
    win.print();
  }

  /* ===== INICIALIZA√á√ÉO ===== */
  loadEmployees();
  refreshEmployeeUI();
  updateHoursInfo();
  updatePlanHoursInfo();
  renderMonthlyReport();
</script>

</body>
</html>
